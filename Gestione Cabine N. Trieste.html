<!DOCTYPE html>
<!-- saved from url=(0064)file:///D:/Desktop/TRAE/Alloggi%20PIOMARTA%20versione%201.3.html -->
<html lang="it"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GESTIONE CABINE "NAVE TRIESTE"</title>
    <style>
        /* Password Protection Modal */
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        }

        .password-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid #4a90e2;
            max-width: 400px;
            width: 90%;
        }

        .password-content h2 {
            color: #ffffff;
            margin-bottom: 30px;
            font-size: 1.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .password-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        .password-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .password-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .access-btn {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .access-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(74, 144, 226, 0.4);
        }

        .readonly-btn {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(149, 165, 166, 0.3);
        }

        .readonly-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(149, 165, 166, 0.4);
        }

        .readonly-indicator {
            position: fixed;
            top: 10px;
            right: 20px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 1001;
            display: none;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #ffffff;
            height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(30, 60, 114, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #4a90e2;
            z-index: 1000;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 2.2em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .auto-save-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: 600;
            margin-top: 5px;
        }
        
        .auto-save-active {
            background-color: rgba(39, 174, 96, 0.9);
            color: white;
        }
        
        .auto-save-inactive {
            background-color: rgba(231, 76, 60, 0.9);
            color: white;
        }

        .sidebar {
            width: 310px;
            background: rgba(20, 40, 80, 0.9);
            backdrop-filter: blur(15px);
            padding: 150px 20px 20px 20px;
            border-right: 2px solid #4a90e2;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }

        .menu-item {
            margin-bottom: 15px;
        }

        .floor-btn {
            width: 95%;
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            border: none;
            padding: 15px 20px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .floor-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(74, 144, 226, 0.4);
            background: linear-gradient(135deg, #357abd 0%, #2a5f9e 100%);
        }

        .floor-btn.active {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 6px 25px rgba(231, 76, 60, 0.4);
        }

        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 10px;
        }

        .submenu.active {
            max-height: 300px;
        }

        .room-btn {
            width: 95%;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px 15px;
            margin-bottom: 8px;
            font-size: 0.95em;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            text-transform: capitalize;
        }

        .room-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #4a90e2;
            transform: translateX(5px);
        }

        .room-btn.selected {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            border-color: #27ae60;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .room-number-btn {
            width: 48%;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px 10px;
            margin: 2px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            text-align: center;
            position: relative;
            display: inline-block;
        }

        .room-number-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .status-indicator {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            position: absolute;
            top: 8px;
            right: 8px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .status-green { background-color: #27ae60; }
        .status-yellow { background-color: #f39c12; }
        .status-red { background-color: #e74c3c; }
        .status-purple { background-color: #8e44ad; }

        .room-unavailable {
            position: relative;
        }

        .room-unavailable::before {
            content: "‚úï";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #e74c3c;
            font-weight: bold;
            z-index: 10;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        }

        .room-unavailable .status-indicator {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            color: white;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
        }

        /* Custom scrollbar for webkit browsers */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 15px;
            right: 25px;
        }

        .close:hover {
            color: white;
        }

        /* Arredi Modal Styles */
        .arredi-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .arredo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .arredo-item:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .arredo-checkbox {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .arredo-checkbox input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .arredo-checkbox label {
            color: #ecf0f1;
            font-weight: 500;
            cursor: pointer;
        }

        .arredo-item input[type="number"] {
            padding: 6px 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            font-weight: bold;
            text-align: center;
        }

        .arredo-item input[type="number"]:disabled {
            background: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.6);
        }

        /* Spogliatoi Styles */
        .spogliatoi-content {
            padding: 20px;
        }

        .spogliatoi-instructions {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            text-align: center;
        }

        .spogliatoi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        /* Locali Styles */
        .locali-content {
            padding: 20px;
        }

        .locali-instructions {
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            text-align: center;
        }

        .locali-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .bed-assignment {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border-left: 4px solid #4a90e2;
        }

        .bed-assignment label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a90e2;
        }

        .bed-assignment input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            font-size: 14px;
        }

        .room-controls {
            margin-top: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .checkbox-container {
            margin: 15px 0;
        }

        .checkbox-container input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .notes-field {
            margin-top: 15px;
        }

        .notes-field textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            resize: vertical;
        }

        .save-btn {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.3);
        }

        .room-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .riepilogo-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .riepilogo-btn {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 1em;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        }

        .riepilogo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(74, 144, 226, 0.4);
        }

        .riepilogo-btn.active {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 6px 25px rgba(231, 76, 60, 0.4);
        }

        .riepilogo-panels {
            display: flex;
            gap: 30px;
            height: 620px;
        }

        .riepilogo-panel {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
            font-size: 1.1em;
        }

        .riepilogo-panel h3 {
            color: #4a90e2;
            margin-bottom: 20px;
            border-bottom: 2px solid #4a90e2;
            padding-bottom: 10px;
        }

        .comando-item {
            background: rgba(255, 255, 255, 0.05);
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4a90e2;
            font-size: 1.05em;
        }

        .comando-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .details-btn {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .details-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }

        .room-item {
            background: rgba(255, 255, 255, 0.05);
            margin: 8px 0;
            padding: 12px;
            border-radius: 6px;
            font-size: 1.05em;
        }

        /* Override per .riepilogo-panel h3 che interferisce */
        .riepilogo-panel #liberi-panel-title {
            color: #27ae60 !important;
            border-bottom: 2px solid #27ae60 !important;
        }
        
        .riepilogo-panel #occupati-panel-title {
            color: #e74c3c !important;
            border-bottom: 2px solid #e74c3c !important;
        }

        /* CSS per pannelli espandibili - copiato da LIBERI che funziona */
        .disponibilita-floor-header {
            cursor: pointer;
            position: relative;
        }

        .disponibilita-floor-header strong {
            font-size: 1.17em !important;
            font-weight: bold !important;
        }

        /* RESET font-size per entrambi i pannelli - annulla .riepilogo-panel font-size */
        #liberi-panel-content,
        #occupati-panel-content {
            font-size: 1rem !important;
        }

        /* FORZA font-size per .room-item nei pannelli per evitare cascata */
        #liberi-panel-content .room-item,
        #occupati-panel-content .room-item {
            font-size: 1rem !important;
        }

        /* Forza font-size uguale per tutti i pannelli in entrambe le sezioni */
        #liberi-panel-content .disponibilita-floor-header strong,
        #occupati-panel-content .disponibilita-floor-header strong {
            font-size: 1.17em !important;
            font-weight: bold !important;
        }

        .floor-details {
            padding-left: 10px;
            margin-top: 10px;
            font-size: 1rem !important;
        }

        /* FORZA font-size per elementi dentro .floor-details per evitare cascata */
        .floor-details .room-item {
            font-size: 1rem !important;
        }

        .floor-details strong {
            font-size: 1em !important;
        }

        .floor-details small {
            font-size: 0.875rem !important;
        }

        .dati-buttons {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .dati-btn {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
            min-width: 150px;
        }

        .dati-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(74, 144, 226, 0.4);
        }

        .dati-btn.active {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 6px 25px rgba(231, 76, 60, 0.4);
        }

        .dati-btn.delete-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .dati-btn.delete-btn:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            box-shadow: 0 6px 25px rgba(231, 76, 60, 0.5);
        }

        .dati-content {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
        }

        .file-input-wrapper {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .file-input-wrapper:hover {
            border-color: #4a90e2;
            background: rgba(74, 144, 226, 0.1);
        }

        .file-input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            font-size: 14px;
        }

        .export-info {
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid rgba(39, 174, 96, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .import-info {
            background: rgba(243, 156, 18, 0.2);
            border: 1px solid rgba(243, 156, 18, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .status-message {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
        }

        .status-success {
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid rgba(39, 174, 96, 0.5);
            color: #27ae60;
        }

        .status-error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.5);
            color: #e74c3c;
        }

        .delete-info {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .confirm-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }

        .confirm-modal-content {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            color: white;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.7);
            text-align: center;
            border: 2px solid #e74c3c;
        }

        .confirm-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 25px;
        }

        .confirm-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .confirm-btn.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .confirm-btn.danger:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            transform: translateY(-2px);
        }

        .confirm-btn.cancel {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
        }

        .confirm-btn.cancel:hover {
            background: linear-gradient(135deg, #7f8c8d 0%, #6c7b7d 100%);
            transform: translateY(-2px);
        }

        .main-content {
            flex: 1;
            padding: 120px 40px 40px 40px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
        }

        .content-area {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            min-height: 400px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .welcome-message {
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.2em;
            margin-top: 50px;
        }

        .room-info {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .room-info.active {
            display: block;
        }

        .room-info h2 {
            color: #4a90e2;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .room-info p {
            line-height: 1.6;
            margin-bottom: 15px;
            color: rgba(255, 255, 255, 0.9);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .main-content {
                padding: 120px 20px 20px 20px;
            }
        }

        /* Genera Ricevuta Styles */
        .ricevuta-content {
            padding: 20px;
        }

        .ricevuta-instructions {
            margin-bottom: 30px;
            text-align: center;
        }

        .ricevuta-instructions p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1em;
            margin: 0;
        }

        .selection-section {
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .selection-section h3 {
            color: #4a90e2;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            position: relative;
            padding-right: 30px;
            transition: all 0.3s ease;
        }

        .selection-section h3:hover {
            color: #357abd;
        }

        .selection-section h3::after {
            content: '‚ñº';
            position: absolute;
            right: 0;
            top: 0;
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }

        .selection-section.collapsed h3::after {
            transform: rotate(-90deg);
        }

        .selection-section .section-content {
            transition: all 0.3s ease;
            max-height: 500px;
            overflow: hidden;
        }

        .selection-section.collapsed .section-content {
            max-height: 0;
            opacity: 0;
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .selection-item {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .selection-item:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: #4a90e2;
            transform: translateY(-2px);
        }

        .selection-item.selected {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            border-color: #4a90e2;
            color: white;
            font-weight: bold;
        }

        .selection-item .item-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 1em;
        }

        .selection-item .item-info {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.7);
        }

        .selection-item.selected .item-info {
            color: rgba(255, 255, 255, 0.9);
        }

        .ricevuta-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ricevuta-btn {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ricevuta-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(39, 174, 96, 0.4);
            background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
        }

        /* Filter buttons for stanze */
        .stanze-filters {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            font-size: 0.9em;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #4a90e2;
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            border-color: #4a90e2;
            color: white;
            font-weight: 600;
        }

        /* Stili per notifiche di stato */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 99999 !important;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            max-width: 450px;
            pointer-events: none;
        }
        
        .notification-content {
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .notification-content.status-success {
            background: linear-gradient(135deg, rgba(46, 204, 113, 0.98) 0%, rgba(39, 174, 96, 0.98) 100%);
            color: white;
            border: 2px solid #27ae60;
        }
        
        .notification-content.status-info {
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.98) 0%, rgba(53, 122, 189, 0.98) 100%);
            color: white;
            border: 2px solid #4a90e2;
        }
        
        .notification-message {
            font-size: 14px;
            line-height: 1.4;
            font-weight: 500;
        }
    </style>

<!-- FIX: stile SOLO per i pulsanti di MODIFICA CAMERE -->
<style id="fix-modifica-camere" type="text/css">
/* Container della lista camere in MODIFICA CAMERE (tutti i piani) */
#floor-rooms-grid {
  display: grid !important;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)) !important;
  gap: 14px !important;
  margin: 20px 0 !important;
  padding: 0 !important;
  background: transparent !important;
}

/* Card elegante per ciascuna camera - STILE UNIFICATO con room-number-btn */
#floor-rooms-grid > button.modifica-room-btn {
  width: 95% !important;
  background: rgba(255, 255, 255, 0.1) !important;
  color: white !important;
  border: 1px solid rgba(255, 255, 255, 0.2) !important;
  padding: 8px 6px !important;
  margin: 2px !important;
  font-size: 1em !important;
  font-weight: 600 !important;
  border-radius: 8px !important;
  cursor: pointer !important;
  transition: all 0.3s ease !important;
  backdrop-filter: blur(10px) !important;
  text-align: center !important;
  position: relative !important;
  display: inline-block !important;
  min-height: auto !important;
  min-width: auto !important;
  box-shadow: none !important;
  text-transform: none !important;
  white-space: normal !important;
}

/* Rimuovi la barra decorativa laterale */
#floor-rooms-grid > button.modifica-room-btn::before {
  display: none !important;
}

/* Hover: stesso effetto dei pulsanti normali */
#floor-rooms-grid > button.modifica-room-btn:hover {
  background: rgba(255, 255, 255, 0.2) !important;
  border-color: #4a90e2 !important;
  transform: translateY(0) !important;
  box-shadow: none !important;
}

/* Tipografia interna - allineata ai pulsanti normali */
#floor-rooms-grid > button.modifica-room-btn .room-number {
  font-weight: 600 !important;
  font-size: 1em !important;
  margin: 0 !important;
  color: white !important;
}
#floor-rooms-grid > button.modifica-room-btn .room-type {
  font-weight: 400 !important;
  font-size: 0.85em !important;
  color: rgba(255, 255, 255, 0.8) !important;
  margin-top: 5px !important;
}
</style>

</head>
<body>
    <!-- Password Protection Modal -->
    <div class="password-modal" id="passwordModal" style="display: none;">
        <div class="password-content">
            <h2>ACCESSO SISTEMA GESTIONE ALLOGGI</h2>
            <input type="password" class="password-input" id="passwordInput" placeholder="Inserisci la password" onkeypress="if(event.key === &#39;Enter&#39;) checkPassword()">
            <div class="password-buttons">
                <button class="password-btn access-btn" onclick="checkPassword()">ACCEDI</button>
                <button class="password-btn readonly-btn" onclick="enterReadOnlyMode()">CONTINUA SOLO LETTURA</button>
            </div>
        </div>
    </div>

    <!-- Read-only mode indicator -->
    <div class="readonly-indicator" id="readonlyIndicator" style="display: block;">
        MODALIT√Ä SOLO LETTURA
    </div>

    <div class="header">
        <h1>GESTIONE CABINE "NAVE TRIESTE"</h1>
        <div id="autoSaveStatus" class="auto-save-status auto-save-inactive">AUTO-SAVE NON ATTIVO</div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="menu-item">
                <button class="floor-btn" onclick="toggleSubmenu(&#39;piano1&#39;)">PIANO PRIMO</button>
                <div class="submenu" id="piano1-submenu">
                    <button class="room-btn" onclick="selectRoom(&#39;piano1&#39;, &#39;singola&#39;)">SINGOLA</button>
                    <button class="room-btn" onclick="selectRoom(&#39;piano1&#39;, &#39;doppia&#39;)">DOPPIA</button>
                    <button class="room-btn" onclick="selectRoom(&#39;piano1&#39;, &#39;tripla&#39;)">TRIPLA</button>
                    <div id="piano1-tripla-rooms" style="display: none;">
                        <div class="room-grid">
                            <button class="room-number-btn" onclick="openRoomModal(&#39;101&#39;)">
                                101
                                <div class="status-indicator" id="status-101"></div>
                            </button>
                            <button class="room-number-btn" onclick="openRoomModal(&#39;102&#39;)">
                                102
                                <div class="status-indicator" id="status-102"></div>
                            </button>
                            <button class="room-number-btn" onclick="openRoomModal(&#39;103&#39;)">
                                103
                                <div class="status-indicator" id="status-103"></div>
                            </button>
                            <button class="room-number-btn" onclick="openRoomModal(&#39;104&#39;)">
                                104
                                <div class="status-indicator" id="status-104"></div>
                            </button>
                            <button class="room-number-btn" onclick="openRoomModal(&#39;105&#39;)">
                                105
                                <div class="status-indicator" id="status-105"></div>
                            </button>
                        </div>
                    </div>
                    <button class="room-btn" onclick="selectRoom(&#39;piano1&#39;, &#39;quadrupla&#39;)">QUADRUPLA</button>
                </div>
            </div>

            <div class="menu-item">
                <button class="floor-btn" onclick="toggleSubmenu(&#39;piano2&#39;)">PIANO AMMEZZATO</button>
                <div class="submenu" id="piano2-submenu">
                    <button class="room-btn" onclick="selectRoom(&#39;piano2&#39;, &#39;singola&#39;)">SINGOLA</button>
                    <button class="room-btn" onclick="selectRoom(&#39;piano2&#39;, &#39;doppia&#39;)">DOPPIA</button>
                    <button class="room-btn" onclick="selectRoom(&#39;piano2&#39;, &#39;tripla&#39;)">TRIPLA</button>
                    <button class="room-btn" onclick="selectRoom(&#39;piano2&#39;, &#39;quadrupla&#39;)">QUADRUPLA</button>
                    <button class="room-btn" onclick="selectRoom(&#39;piano2&#39;, &#39;quintupla&#39;)">QUINTUPLA</button>
                </div>
            </div>

            <div class="menu-item">
                <button class="floor-btn" onclick="toggleSubmenu(&#39;piano3&#39;)">PIANO SECONDO</button>
                <div class="submenu" id="piano3-submenu">
                    <button class="room-btn" onclick="selectRoom(&#39;piano3&#39;, &#39;singola&#39;)">SINGOLA</button>
                    <button class="room-btn" onclick="selectRoom(&#39;piano3&#39;, &#39;doppia&#39;)">DOPPIA</button>
                    <button class="room-btn" onclick="selectRoom(&#39;piano3&#39;, &#39;tripla&#39;)">TRIPLA</button>
                    <button class="room-btn" onclick="selectRoom(&#39;piano3&#39;, &#39;quadrupla&#39;)">QUADRUPLA</button>
                </div>
            </div>

            <div class="menu-item">
                <button class="floor-btn" onclick="showDisponibilita(this)">DISPONIBILIT√Ä</button>
            </div>


            <div class="menu-item">
                <button class="floor-btn" onclick="toggleSubmenu(&#39;modifica-camere&#39;)">MODIFICA CAMERE</button>
                <div class="submenu" id="modifica-camere-submenu">
                    <button class="room-btn" onclick="selectModificaFloor(&#39;piano1&#39;)">PIANO PRIMO</button>
                    <button class="room-btn" onclick="selectModificaFloor(&#39;piano2&#39;)">PIANO AMMEZZATO</button>
                    <button class="room-btn" onclick="selectModificaFloor(&#39;piano3&#39;)">PIANO SECONDO</button>
                </div>
            </div>

            <div class="menu-item">
                <button class="floor-btn" onclick="toggleSubmenu(&#39;spogliatoi&#39;)">SPOGLIATOI</button>
                <div class="submenu" id="spogliatoi-submenu">
                    <button class="room-btn" onclick="selectSpogliatoiFloor(&#39;piano1&#39;)">PIANO PRIMO</button>
                    <button class="room-btn" onclick="selectSpogliatoiFloor(&#39;piano3&#39;)">PIANO SECONDO</button>
                </div>
            </div>

            <div class="menu-item">
                <button class="floor-btn" onclick="toggleSubmenu(&#39;locali&#39;)">LOCALI</button>
                <div class="submenu" id="locali-submenu">
                    <button class="room-btn" onclick="selectLocaliType(&#39;segreterie&#39;)">SEGRETERIE</button>
                    <button class="room-btn" onclick="selectLocaliType(&#39;uffici&#39;)">UFFICI</button>
                    <button class="room-btn" onclick="selectLocaliType(&#39;classificati&#39;)">CLASSIFICATI</button>
                    <button class="room-btn" onclick="selectLocaliType(&#39;casse-riserva&#39;)">CASSE DI RISERVA</button>
                    <button class="room-btn" onclick="selectLocaliType(&#39;magazzini&#39;)">MAGAZZINI</button>
                </div>
            </div>

            <div class="menu-item">
                <button class="floor-btn" onclick="showGeneraRicevuta(this)">GENERA RICEVUTA</button>
            </div>

            <div class="menu-item">
                <button class="floor-btn" onclick="showRiepilogo(this)">RIEPILOGO</button>
            </div>
            <div class="menu-item">
                <button class="floor-btn" onclick="showDati(this)">DATI</button>
            </div>
            
            <div style="position: absolute; bottom: 20px; left: 20px; right: 20px; text-align: center;">
                <p style="font-style: italic; color: rgba(255, 255, 255, 0.6); font-size: 0.9em; margin: 0;">
                    Creato da Giuseppe Russo
                </p>
                <p style="font-style: italic; color: rgba(255, 255, 255, 0.5); font-size: 0.8em; margin: 5px 0 0 0;">
                    Versione 1.3
                </p>
            </div>
        </div>

        <div class="main-content">
            <div class="content-area">
                <div class="welcome-message" id="welcome">
                    Seleziona un piano e un tipo di camera dal menu a sinistra per visualizzare le informazioni sugli alloggi.
                </div>

                <div class="room-info" id="room-info">
                    <h2 id="room-title"></h2>
                    <p id="room-description"></p>
                    <div id="room-details"></div>
                </div>

                <div class="room-info" id="tripla-rooms-view">
                    <h2>Piano Primo - Camere Triple</h2>
                    <p>Seleziona una camera per gestire le assegnazioni dei letti:</p>
                    <div class="room-grid" style="margin-top: 30px;">
                        <button class="room-number-btn" onclick="openRoomModal(&#39;101&#39;)" style="width: 18%; margin: 10px;">
                            101
                            <div class="status-indicator" id="status-101"></div>
                        </button>
                        <button class="room-number-btn" onclick="openRoomModal(&#39;102&#39;)" style="width: 18%; margin: 10px;">
                            102
                            <div class="status-indicator" id="status-102"></div>
                        </button>
                        <button class="room-number-btn" onclick="openRoomModal(&#39;103&#39;)" style="width: 18%; margin: 10px;">
                            103
                            <div class="status-indicator" id="status-103"></div>
                        </button>
                        <button class="room-number-btn" onclick="openRoomModal(&#39;104&#39;)" style="width: 18%; margin: 10px;">
                            104
                            <div class="status-indicator" id="status-104"></div>
                        </button>
                        <button class="room-number-btn" onclick="openRoomModal(&#39;105&#39;)" style="width: 18%; margin: 10px;">
                            105
                            <div class="status-indicator" id="status-105"></div>
                        </button>
                    </div>
                </div>

                <div class="room-info" id="riepilogo-info">
                    <h2>RIEPILOGO GENERALE</h2>
                    
                    <div class="riepilogo-buttons">
                        <button class="riepilogo-btn active" onclick="showRiepilogoPiano(&#39;piano1&#39;)">PIANO PRIMO</button>
                        <button class="riepilogo-btn" onclick="showRiepilogoPiano(&#39;piano2&#39;)">PIANO AMMEZZATO</button>
                        <button class="riepilogo-btn" onclick="showRiepilogoPiano(&#39;piano3&#39;)">PIANO SECONDO</button>
                        <button class="riepilogo-btn" onclick="showRiepilogoPiano(&#39;spogliatoi&#39;)">SPOGLIATOI</button>
                        <button class="riepilogo-btn" onclick="showRiepilogoPiano(&#39;generale&#39;)">GENERALE</button>
                        <button class="riepilogo-btn" onclick="exportToPDF()" id="pdf-export-btn" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%); display: none;">üìÑ ESPORTA IN PDF</button>
                    </div>

                    <div class="riepilogo-panels" id="riepilogo-panels">
                        <div class="riepilogo-panel">
                            <h3 id="rooms-panel-title">Camere Piano Primo</h3>
                            <div id="rooms-panel-content"></div>
                        </div>
                        <div class="riepilogo-panel">
                            <h3 id="comando-panel-title">Riepilogo per Comando</h3>
                            <div id="comando-panel-content"></div>
                        </div>
                    </div>
                </div>

                <div class="room-info" id="disponibilita-info">
                    <h2>DISPONIBILIT√Ä LETTI E STANZE</h2>
                    
                    <div class="riepilogo-panels" style="height: 620px;">
                        <div class="riepilogo-panel">
                            <h3 id="liberi-panel-title">üü¢ STANZE/LETTI LIBERI</h3>
                            <div id="liberi-panel-content"></div>
                        </div>
                        <div class="riepilogo-panel">
                            <h3 id="occupati-panel-title">üî¥ STANZE/LETTI OCCUPATI</h3>
                            <div id="occupati-panel-content"></div>
                        </div>
                    </div>
                </div>

                <div class="room-info" id="modifica-camere-info">
                    <h2 id="modifica-floor-title">MODIFICA CONFIGURAZIONE CAMERE</h2>
                    
                    <div class="modifica-content">
                        <div class="modifica-instructions" id="modifica-instructions">
                            <p>Seleziona un piano e poi una camera per modificarne la configurazione dei letti:</p>
                        </div>
                        
                        <div id="floor-rooms-grid">
                            <!-- Floor rooms will be populated by JavaScript -->
                        </div>
                        
                        <!-- Modal for room modification -->
                        <div class="modal" id="modificaCameraModal" style="display: none;">
                            <div class="modal-content">
                                <span class="close" onclick="closeModificaCameraModal()">√ó</span>
                                <h3 id="modifica-room-title">Modifica Camera</h3>
                                
                                <div class="modifica-form">
                                    <div class="bed-count-section">
                                        <h4>Numero di letti nella camera:</h4>
                                        <div class="bed-checkboxes">
                                            <label><input type="radio" name="bed-count" value="1"> 1 letto (Singola)</label>
                                            <label><input type="radio" name="bed-count" value="2"> 2 letti (Doppia)</label>
                                            <label><input type="radio" name="bed-count" value="3"> 3 letti (Tripla)</label>
                                            <label><input type="radio" name="bed-count" value="4"> 4 letti (Quadrupla)</label>
                                            <label><input type="radio" name="bed-count" value="5"> 5 letti (Quintupla)</label>
                                        </div>
                                    </div>
                                    
                                    <div class="warning-section">
                                        <p style="color: #f39c12; font-style: italic;">
                                            ‚ö†Ô∏è Attenzione: Modificare il numero di letti canceller√† tutte le assegnazioni correnti per questa camera.
                                        </p>
                                    </div>
                                    
                                    <div class="modifica-buttons">
                                        <button class="save-btn" onclick="saveRoomModification()">Salva Modifiche</button>
                                        <button class="cancel-btn" onclick="closeModificaCameraModal()">Annulla</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="room-info" id="spogliatoi-info">
                    <h2 id="spogliatoi-floor-title">GESTIONE SPOGLIATOI</h2>
                    
                    <div class="spogliatoi-content">
                        <div class="spogliatoi-instructions" id="spogliatoi-instructions">
                            <p>Seleziona un piano per gestire gli spogliatoi:</p>
                        </div>
                        
                        <div class="spogliatoi-grid" id="spogliatoi-grid">
                            <!-- Spogliatoi content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="room-info" id="locali-info">
                    <h2 id="locali-type-title">GESTIONE LOCALI</h2>
                    
                    <div class="locali-content">
                        <div class="locali-instructions" id="locali-instructions">
                            <p>Seleziona un tipo di locale per gestire le assegnazioni:</p>
                        </div>
                        
                        <div class="locali-grid" id="locali-grid">
                            <!-- Locali content will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <div class="room-info" id="genera-ricevuta-info">
                    <h2>GENERA RICEVUTA</h2>
                    
                    <div class="ricevuta-content">
                        <div class="ricevuta-instructions">
                            <p>Seleziona le stanze, spogliatoi e locali per generare una ricevuta di assegnazione:</p>
                        </div>
                        
                        <div class="ricevuta-selection">
                            <div class="selection-section collapsed">
                                <h3 onclick="toggleSection(this)">üè† STANZE</h3>
                                <div class="section-content">
                                    <div class="stanze-filters">
                                        <button class="filter-btn active" onclick="filterStanze(&#39;tutti&#39;)">TUTTI I PIANI</button>
                                        <button class="filter-btn" onclick="filterStanze(&#39;piano1&#39;)">PIANO PRIMO</button>
                                        <button class="filter-btn" onclick="filterStanze(&#39;piano2&#39;)">PIANO AMMEZZATO</button>
                                        <button class="filter-btn" onclick="filterStanze(&#39;piano3&#39;)">PIANO SECONDO</button>
                                    </div>
                                    <div class="selection-grid" id="camere-selection">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="selection-section collapsed">
                                <h3 onclick="toggleSection(this)">üëî SPOGLIATOI</h3>
                                <div class="section-content">
                                    <div class="selection-grid" id="spogliatoi-selection">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="selection-section collapsed">
                                <h3 onclick="toggleSection(this)">üè¢ LOCALI</h3>
                                <div class="section-content">
                                    <div class="selection-grid" id="locali-selection">
                                        <!-- Will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="ricevuta-actions">
                            <button class="ricevuta-btn" onclick="generateRicevuta()">üìÑ GENERA RICEVUTA</button>
                            <button class="ricevuta-btn" onclick="clearRicevutaSelection()" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">üóëÔ∏è PULISCI SELEZIONE</button>
                        </div>
                    </div>
                </div>

                <div class="room-info" id="dati-info">
                    <h2>üîÑ Caricamento e Salvataggio Automatico</h2>
                    
                    <div class="dati-buttons">
                        <button class="dati-btn active" onclick="showDatiTab(&#39;esporta&#39;, this)">ESPORTA</button>
                        <button class="dati-btn" onclick="showDatiTab(&#39;importa&#39;, this)">IMPORTA</button>
                        <button class="dati-btn delete-btn" onclick="showDatiTab(&#39;elimina&#39;, this)" disabled="" style="opacity: 0.5; cursor: not-allowed;">ELIMINA TUTTI I DATI</button>
                    </div>

                    <div class="dati-content" id="dati-content">
                        <!-- Content will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Room Management -->
    <div id="roomModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeRoomModal()">√ó</span>
            <h2 id="modal-room-title">Camera 101 - Piano Primo Tripla</h2>
            
            <div id="bed-assignments">
                <div class="bed-assignment">
                    <label for="bed1">Letto 1 - COMANDO:</label>
                    <input type="text" id="bed1" placeholder="Inserisci nome comando" disabled="" style="opacity: 0.5; cursor: not-allowed;">
                </div>
                <div class="bed-assignment">
                    <label for="bed2">Letto 2 - COMANDO:</label>
                    <input type="text" id="bed2" placeholder="Inserisci nome comando" disabled="" style="opacity: 0.5; cursor: not-allowed;">
                </div>
                <div class="bed-assignment">
                    <label for="bed3">Letto 3 - COMANDO:</label>
                    <input type="text" id="bed3" placeholder="Inserisci nome comando" disabled="" style="opacity: 0.5; cursor: not-allowed;">
                </div>
            </div>

            <div class="room-controls">
                <div class="checkbox-container">
                    <input type="checkbox" id="full-room-assignment" onchange="toggleFullRoomAssignment()">
                    <label for="full-room-assignment">CAMERA ASSEGNATA INTERAMENTE A:</label>
                    <input type="text" id="full-room-command" placeholder="Inserisci nome comando" style="margin-left: 10px; width: 200px; padding: 5px; border-radius: 5px; border: none; opacity: 0.5; cursor: not-allowed;" disabled="">
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="room-unavailable" onchange="toggleRoomAvailability()">
                    <label for="room-unavailable">Camera NON AGIBILE</label>
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="room-under-work" onchange="toggleRoomUnderWork()">
                    <label for="room-under-work">Camera AI LAVORI</label>
                </div>
                
                <div class="notes-field">
                    <label for="room-notes">NOTE:</label>
                    <textarea id="room-notes" placeholder="Inserisci note sulla camera..." disabled="" style="opacity: 0.5; cursor: not-allowed;"></textarea>
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="save-btn" onclick="saveRoomData()">Salva Modifiche</button>
                <button class="save-btn" onclick="resetRoomForm()" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">RESET FORM</button>
                <button class="save-btn" onclick="openArrediModal()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">ARREDI</button>
            </div>
        </div>
    </div>

    <!-- Modal for Spogliatoio Management -->
    <div id="spogliatoioModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeSpogliatoioModal()">√ó</span>
            <h2 id="modal-spogliatoio-title">Spogliatoio S 1-56</h2>
            
            <div class="room-controls">
                <div class="checkbox-container">
                    <input type="checkbox" id="spogliatoio-assignment" onchange="toggleSpogliatoioAssignment()">
                    <label for="spogliatoio-assignment">SPOGLIATOIO ASSEGNATO A:</label>
                    <input type="text" id="spogliatoio-command" placeholder="Inserisci nome comando" style="margin-left: 10px; width: 200px; padding: 5px; border-radius: 5px; border: none; opacity: 0.5; cursor: not-allowed;" disabled="">
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="spogliatoio-unavailable" onchange="toggleSpogliatoioAvailability()">
                    <label for="spogliatoio-unavailable">Spogliatoio NON AGIBILE</label>
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="spogliatoio-under-work" onchange="toggleSpogliatoioUnderWork()">
                    <label for="spogliatoio-under-work">Spogliatoio AI LAVORI</label>
                </div>
                
                <div class="notes-field">
                    <label for="spogliatoio-notes">NOTE:</label>
                    <textarea id="spogliatoio-notes" placeholder="Inserisci note sullo spogliatoio..." disabled="" style="opacity: 0.5; cursor: not-allowed;"></textarea>
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="save-btn" onclick="saveSpogliatoioData()">Salva Modifiche</button>
                <button class="save-btn" onclick="resetSpogliatoioForm()" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">RESET FORM</button>
                <button class="save-btn" onclick="openSpogliatoioArrediModal()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">ARREDI</button>
            </div>
        </div>
    </div>

    <!-- Modal for Arredi (Furniture) -->
    <div id="arrediModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeArrediModal()">√ó</span>
            <h2 id="arredi-room-title">Arredi - Camera</h2>
            
            <div class="arredi-content">
                <p style="margin-bottom: 20px; color: #ecf0f1;">Seleziona gli arredi presenti nella camera e indica la quantit√†:</p>
                
                <div class="arredi-list">
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="arredo-scarpiera" onchange="toggleArredoInput(&#39;scarpiera&#39;)">
                            <label for="arredo-scarpiera">Scarpiera</label>
                        </div>
                        <input type="number" id="qty-scarpiera" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="arredo-comodini" onchange="toggleArredoInput(&#39;comodini&#39;)">
                            <label for="arredo-comodini">Comodini</label>
                        </div>
                        <input type="number" id="qty-comodini" min="1" value="2" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="arredo-armadi" onchange="toggleArredoInput(&#39;armadi&#39;)">
                            <label for="arredo-armadi">Armadi</label>
                        </div>
                        <input type="number" id="qty-armadi" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="arredo-scrivanie" onchange="toggleArredoInput(&#39;scrivanie&#39;)">
                            <label for="arredo-scrivanie">Scrivanie</label>
                        </div>
                        <input type="number" id="qty-scrivanie" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="arredo-sedie" onchange="toggleArredoInput(&#39;sedie&#39;)">
                            <label for="arredo-sedie">Sedie</label>
                        </div>
                        <input type="number" id="qty-sedie" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="arredo-bollitore" onchange="toggleArredoInput(&#39;bollitore&#39;)">
                            <label for="arredo-bollitore">Bollitore</label>
                        </div>
                        <input type="number" id="qty-bollitore" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="arredo-macchinacaffe" onchange="toggleArredoInput(&#39;macchinacaffe&#39;)">
                            <label for="arredo-macchinacaffe">Macchina del caff√®</label>
                        </div>
                        <input type="number" id="qty-macchinacaffe" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="arredo-televisione" onchange="toggleArredoInput(&#39;televisione&#39;)">
                            <label for="arredo-televisione">Televisione</label>
                        </div>
                        <input type="number" id="qty-televisione" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="arredo-ventilatore" onchange="toggleArredoInput(&#39;ventilatore&#39;)">
                            <label for="arredo-ventilatore">Ventilatore a colonna</label>
                        </div>
                        <input type="number" id="qty-ventilatore" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="arredo-climatizzatore" onchange="toggleArredoInput(&#39;climatizzatore&#39;)">
                            <label for="arredo-climatizzatore">Climatizzatore</label>
                        </div>
                        <input type="number" id="qty-climatizzatore" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="arredo-appendiabiti" onchange="toggleArredoInput(&#39;appendiabiti&#39;)">
                            <label for="arredo-appendiabiti">Appendiabiti</label>
                        </div>
                        <input type="number" id="qty-appendiabiti" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="arredo-bagno" onchange="toggleArredoInput(&#39;bagno&#39;)">
                            <label for="arredo-bagno">Bagno in camera</label>
                        </div>
                        <input type="number" id="qty-bagno" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: center;">
                    <button class="save-btn" onclick="saveArrediData()">Salva Arredi</button>
                    <button class="save-btn" onclick="closeArrediModal()" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">Annulla</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Locale Management -->
    <div id="localeModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLocaleModal()">√ó</span>
            <h2 id="modal-locale-title">Locale L 1-07</h2>
            
            <div class="room-controls">
                <div class="checkbox-container">
                    <input type="checkbox" id="locale-assignment" onchange="toggleLocaleAssignment()">
                    <label for="locale-assignment">LOCALE ASSEGNATO A:</label>
                    <input type="text" id="locale-command" placeholder="Inserisci nome comando" style="margin-left: 10px; width: 200px; padding: 5px; border-radius: 5px; border: none; opacity: 0.5; cursor: not-allowed;" disabled="">
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="locale-unavailable" onchange="toggleLocaleAvailability()">
                    <label for="locale-unavailable">Locale NON AGIBILE</label>
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="locale-under-work" onchange="toggleLocaleUnderWork()">
                    <label for="locale-under-work">Locale AI LAVORI</label>
                </div>
                
                <div class="notes-field">
                    <label for="locale-notes">NOTE:</label>
                    <textarea id="locale-notes" placeholder="Inserisci note sul locale..." disabled="" style="opacity: 0.5; cursor: not-allowed;"></textarea>
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 20px;">
                <button class="save-btn" onclick="saveLocaleData()">Salva Modifiche</button>
                <button class="save-btn" onclick="resetLocaleForm()" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">RESET FORM</button>
                <button class="save-btn" onclick="openLocaleArrediModal()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">ARREDI</button>
            </div>
        </div>
    </div>

    <!-- Modal for Spogliatoio Arredi (Furniture) -->
    <div id="spogliatoioArrediModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeSpogliatoioArrediModal()">√ó</span>
            <h2 id="spogliatoio-arredi-title">Arredi - Spogliatoio</h2>
            
            <div class="arredi-content">
                <p style="margin-bottom: 20px; color: #ecf0f1;">Seleziona gli arredi presenti nello spogliatoio e indica la quantit√†:</p>
                
                <div class="arredi-list">
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="spog-arredo-scarpiera" onchange="toggleSpogliatoioArredoInput(&#39;scarpiera&#39;)">
                            <label for="spog-arredo-scarpiera">Scarpiera</label>
                        </div>
                        <input type="number" id="spog-qty-scarpiera" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="spog-arredo-comodini" onchange="toggleSpogliatoioArredoInput(&#39;comodini&#39;)">
                            <label for="spog-arredo-comodini">Comodini</label>
                        </div>
                        <input type="number" id="spog-qty-comodini" min="1" value="2" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="spog-arredo-armadi" onchange="toggleSpogliatoioArredoInput(&#39;armadi&#39;)">
                            <label for="spog-arredo-armadi">Armadi</label>
                        </div>
                        <input type="number" id="spog-qty-armadi" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="spog-arredo-sedie" onchange="toggleSpogliatoioArredoInput(&#39;sedie&#39;)">
                            <label for="spog-arredo-sedie">Sedie</label>
                        </div>
                        <input type="number" id="spog-qty-sedie" min="1" value="2" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="spog-arredo-specchi" onchange="toggleSpogliatoioArredoInput(&#39;specchi&#39;)">
                            <label for="spog-arredo-specchi">Specchi</label>
                        </div>
                        <input type="number" id="spog-qty-specchi" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="spog-arredo-attaccapanni" onchange="toggleSpogliatoioArredoInput(&#39;attaccapanni&#39;)">
                            <label for="spog-arredo-attaccapanni">Attaccapanni</label>
                        </div>
                        <input type="number" id="spog-qty-attaccapanni" min="1" value="2" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="spog-arredo-panche" onchange="toggleSpogliatoioArredoInput(&#39;panche&#39;)">
                            <label for="spog-arredo-panche">Panche</label>
                        </div>
                        <input type="number" id="spog-qty-panche" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: center;">
                    <button class="save-btn" onclick="saveSpogliatoioArrediData()">Salva Arredi</button>
                    <button class="save-btn" onclick="closeSpogliatoioArrediModal()" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">Annulla</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Locale Arredi (Furniture) -->
    <div id="localeArrediModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeLocaleArrediModal()">√ó</span>
            <h2 id="locale-arredi-title">Arredi - Locale</h2>
            
            <div class="arredi-content">
                <p style="margin-bottom: 20px; color: #ecf0f1;">Seleziona gli arredi presenti nel locale e indica la quantit√†:</p>
                
                <div class="arredi-list">
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="loc-arredo-scrivanie" onchange="toggleLocaleArredoInput(&#39;scrivanie&#39;)">
                            <label for="loc-arredo-scrivanie">Scrivanie</label>
                        </div>
                        <input type="number" id="loc-qty-scrivanie" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="loc-arredo-sedie" onchange="toggleLocaleArredoInput(&#39;sedie&#39;)">
                            <label for="loc-arredo-sedie">Sedie</label>
                        </div>
                        <input type="number" id="loc-qty-sedie" min="1" value="2" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="loc-arredo-armadi" onchange="toggleLocaleArredoInput(&#39;armadi&#39;)">
                            <label for="loc-arredo-armadi">Armadi</label>
                        </div>
                        <input type="number" id="loc-qty-armadi" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="loc-arredo-scaffali" onchange="toggleLocaleArredoInput(&#39;scaffali&#39;)">
                            <label for="loc-arredo-scaffali">Scaffali</label>
                        </div>
                        <input type="number" id="loc-qty-scaffali" min="1" value="2" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="loc-arredo-cassettiere" onchange="toggleLocaleArredoInput(&#39;cassettiere&#39;)">
                            <label for="loc-arredo-cassettiere">Cassettiere</label>
                        </div>
                        <input type="number" id="loc-qty-cassettiere" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="loc-arredo-tavoli" onchange="toggleLocaleArredoInput(&#39;tavoli&#39;)">
                            <label for="loc-arredo-tavoli">Tavoli</label>
                        </div>
                        <input type="number" id="loc-qty-tavoli" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                    
                    <div class="arredo-item">
                        <div class="arredo-checkbox">
                            <input type="checkbox" id="loc-arredo-computer" onchange="toggleLocaleArredoInput(&#39;computer&#39;)">
                            <label for="loc-arredo-computer">Computer</label>
                        </div>
                        <input type="number" id="loc-qty-computer" min="1" value="1" disabled="" style="width: 60px; opacity: 0.5; cursor: not-allowed;">
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px; justify-content: center;">
                    <button class="save-btn" onclick="saveLocaleArrediData()">Salva Arredi</button>
                    <button class="save-btn" onclick="closeLocaleArrediModal()" style="background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);">Annulla</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Comando Details -->
    <div id="comandoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeComandoModal()">√ó</span>
            <h2 id="comando-modal-title">Dettagli Comando</h2>
            <div id="comando-modal-content"></div>
        </div>
    </div>

    <!-- Confirmation Modal for Delete All Data -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-modal-content">
            <h2 style="color: #e74c3c; margin-bottom: 20px;">‚ö†Ô∏è ATTENZIONE ‚ö†Ô∏è</h2>
            <p style="font-size: 1.1em; margin-bottom: 20px;">
                Stai per <strong>ELIMINARE TUTTI I DATI</strong> delle camere e assegnazioni.
            </p>
            <p style="margin-bottom: 25px;">
                Questa operazione √® <strong style="color: #e74c3c;">IRREVERSIBILE</strong>.<br>
                Tutti i dati verranno cancellati definitivamente.
            </p>
            <p style="margin-bottom: 30px; font-size: 1.1em;">
                Sei sicuro di voler procedere?
            </p>
            <div class="confirm-buttons">
                <button class="confirm-btn cancel" onclick="closeConfirmModal()">‚ùå Annulla</button>
                <button class="confirm-btn danger" onclick="confirmDeleteAllData()">üóëÔ∏è ELIMINA TUTTO</button>
            </div>
        </div>
    </div>

    <!-- Hidden content for PDF printing -->
    <div id="pdf-content" style="display: none;"></div>

    <!-- Print styles for PDF generation -->
    <style media="print">
        @page {
            margin: 2cm;
            size: A4;
        }
        
        body * {
            visibility: hidden;
        }
        
        #pdf-content, #pdf-content * {
            visibility: visible;
        }
        
        #pdf-content {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            background: white;
            color: #2c3e50;
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 1.4;
        }
        
        #pdf-content h1 {
            font-size: 20px;
            text-align: center;
            margin-bottom: 20px;
            color: #1e3c72;
            background: linear-gradient(135deg, #e3f2fd, #f1f8ff);
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #4a90e2;
        }
        
        #pdf-content h2 {
            font-size: 16px;
            margin: 25px 0 12px 0;
            color: #2c3e50;
            background: #f8f9fa;
            padding: 10px 15px;
            border-left: 5px solid #4a90e2;
            border-radius: 0 8px 8px 0;
        }
        
        #pdf-content h3 {
            font-size: 14px;
            margin: 15px 0 8px 0;
            color: #2c3e50;
            font-weight: bold;
        }
        
        #pdf-content .piano-section {
            margin-bottom: 20px;
            page-break-inside: avoid;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4a90e2;
        }
        
        #pdf-content .piano-section h3 {
            color: #1e3c72;
            margin-top: 0;
        }
        
        #pdf-content .comando-section {
            margin-bottom: 15px;
            page-break-inside: avoid;
            background: #fff8e1;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #f39c12;
        }
        
        #pdf-content .comando-section h3 {
            color: #e67e22;
            margin-top: 0;
        }
        
        #pdf-content .camera-section {
            margin-bottom: 15px;
            page-break-inside: avoid;
            background: #f1f8e9;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #27ae60;
        }
        
        #pdf-content .camera-section h3 {
            color: #229954;
            margin-top: 0;
        }
        
        #pdf-content .status-libera {
            color: #27ae60;
            font-weight: bold;
        }
        
        #pdf-content .status-occupata {
            color: #e74c3c;
            font-weight: bold;
        }
        
        #pdf-content .status-parziale {
            color: #f39c12;
            font-weight: bold;
        }
        
        #pdf-content .status-non-agibile {
            color: #e74c3c;
            font-weight: bold;
            background: #ffebee;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        #pdf-content .status-ai-lavori {
            color: #8e44ad;
            font-weight: bold;
            background: #f3e5f5;
            padding: 2px 6px;
            border-radius: 3px;
        }
        
        #pdf-content ul {
            margin: 8px 0 8px 20px;
        }
        
        #pdf-content li {
            margin: 4px 0;
            color: #2c3e50;
        }
        
        #pdf-content .date-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #27ae60;
            text-align: center;
            margin-bottom: 25px;
        }
        
        #pdf-content .summary-box {
            background: #fff3e0;
            border: 2px solid #ff9800;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        
        .modifica-content {
            padding: 20px;
        }
        
        
        .room-button {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            color: white;
            border: none;
            padding: 20px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 1.1em;
            text-align: center;
        }
        
        .room-button:hover {
            background: linear-gradient(135deg, #357abd 0%, #4a90e2 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);
        }
        
        button.modifica-room-btn {
            background: #ff0000 !important;
            background-image: none !important;
            color: #ffffff !important;
            border: 1px solid #e9ecef !important;
            padding: 16px 24px !important;
            margin: 8px !important;
            font-size: 0.95em !important;
            font-weight: 500 !important;
            border-radius: 12px !important;
            cursor: pointer !important;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
            text-align: left !important;
            display: inline-flex !important;
            flex-direction: column !important;
            align-items: flex-start !important;
            justify-content: center !important;
            min-width: 160px !important;
            min-height: 80px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.12) !important;
            white-space: nowrap !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        button.modifica-room-btn:hover {
            background: linear-gradient(145deg, #f8f9fa 0%, #e9ecef 100%) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12), 0 2px 6px rgba(0, 0, 0, 0.16) !important;
            border-color: #dee2e6 !important;
        }
        
        button.modifica-room-btn:active {
            transform: translateY(0) !important;
            transition: all 0.1s ease !important;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08) !important;
        }
        
        button.modifica-room-btn .room-number {
            font-weight: 700 !important;
            color: #495057 !important;
            font-size: 1.1em !important;
            margin-bottom: 4px !important;
            letter-spacing: 0.5px !important;
        }
        
        button.modifica-room-btn .room-type {
            font-weight: 400 !important;
            color: #6c757d !important;
            font-size: 0.85em !important;
            margin-left: 0 !important;
            line-height: 1.2 !important;
        }

        button.modifica-room-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #007bff 0%, #0056b3 100%);
            border-radius: 2px 0 0 2px;
            opacity: 0;
            transition: opacity 0.25s ease;
        }

        button.modifica-room-btn:hover::before {
            opacity: 1;
        }

        /* OVERRIDE ASSOLUTO per i pulsanti modifica camere */
        #floor-rooms-grid button.modifica-room-btn,
        .modifica-room-btn {
            background: #ffffff !important;
            background-color: #ffffff !important;
            background-image: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%) !important;
            color: #2c3e50 !important;
            border: 1px solid #dee2e6 !important;
            padding: 16px 20px !important;
            margin: 6px !important;
            font-size: 0.9em !important;
            font-weight: 500 !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            transition: all 0.25s ease !important;
            text-align: left !important;
            display: inline-flex !important;
            flex-direction: column !important;
            align-items: flex-start !important;
            min-width: 150px !important;
            min-height: 60px !important;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1) !important;
        }

        #floor-rooms-grid button.modifica-room-btn:hover,
        .modifica-room-btn:hover {
            background: #f8f9fa !important;
            background-color: #f8f9fa !important;
            background-image: none !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
            border-color: #adb5bd !important;
        }
        
        #floor-rooms-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            align-items: flex-start;
            gap: 5px;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            line-height: 1.4;
        }
        
        .modifica-instructions {
            background: rgba(74, 144, 226, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4a90e2;
        }
        
        .camere-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .camera-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .camera-card:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #4a90e2;
            transform: translateY(-2px);
        }
        
        .bed-checkboxes {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }
        
        .bed-checkboxes label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .bed-checkboxes label:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .bed-checkboxes input[type="radio"] {
            width: 18px;
            height: 18px;
        }
        
        .warning-section {
            background: rgba(243, 156, 18, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #f39c12;
        }
        
        .modifica-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .cancel-btn:hover {
            background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%);
            transform: translateY(-2px);
        }
    </style>
    
    <script>
        // Password Protection Variables
        let isReadOnlyMode = false;
        let isAuthenticated = false;
        const ADMIN_PASSWORD = "PIOMARTA25"; // Change this to your desired password

        // Initialize password protection on page load
        window.addEventListener('DOMContentLoaded', function() {
            showPasswordModal();
        });

        // Show password modal
        function showPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('passwordInput').focus();
        }

        // Hide password modal
        function hidePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        // Check password
        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            if (password === ADMIN_PASSWORD) {
                isAuthenticated = true;
                isReadOnlyMode = false;
                hidePasswordModal();
                document.getElementById('readonlyIndicator').style.display = 'none';
                console.log('üîê Authentication successful');
                
                // Mostra popup dati non aggiornati
                setTimeout(() => {
                    showDataUpdateWarning();
                }, 500);
            } else if (password === '') {
                alert('Inserisci una password');
                return;
            } else {
                alert('Password errata. Prova di nuovo o continua in modalit√† solo lettura.');
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }

        // Enter read-only mode
        function enterReadOnlyMode() {
            isReadOnlyMode = true;
            isAuthenticated = false;
            hidePasswordModal();
            document.getElementById('readonlyIndicator').style.display = 'block';
            disableModificationFeatures();
            console.log('üîê Read-only mode activated');
            
            // Mostra popup dati non aggiornati anche in modalit√† lettura
            setTimeout(() => {
                showDataUpdateWarning();
            }, 500);
        }

        // Disable modification features in read-only mode
        function disableModificationFeatures() {
            // Disable modification buttons and forms
            const modificationElements = [
                '.delete-btn',
                '.modifica-room-btn',
                'input[type="text"]',
                'input[type="number"]',
                'textarea',
                'select'
            ];

            modificationElements.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(element => {
                    element.disabled = true;
                    element.style.opacity = '0.5';
                    element.style.cursor = 'not-allowed';
                });
            });

            // Override click events for modification buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                if (button.textContent.includes('ELIMINA') || 
                    button.textContent.includes('MODIFICA') || 
                    button.textContent.includes('SALVA') ||
                    button.classList.contains('delete-btn') ||
                    button.classList.contains('modifica-room-btn')) {
                    button.addEventListener('click', function(e) {
                        if (isReadOnlyMode) {
                            e.preventDefault();
                            e.stopPropagation();
                            alert('Funzione non disponibile in modalit√† solo lettura');
                            return false;
                        }
                    }, true);
                }
            });
        }

        // Check if user is authenticated before allowing modifications
        function requireAuthentication() {
            if (isReadOnlyMode && !isAuthenticated) {
                alert('Accesso negato. Modalit√† solo lettura attiva.');
                return false;
            }
            return true;
        }

        let currentFloor = null;
        let currentRoom = null;

        function toggleSubmenu(floor) {
            // Close all other submenus
            const allSubmenus = document.querySelectorAll('.submenu');
            const allFloorBtns = document.querySelectorAll('.floor-btn');
            
            allSubmenus.forEach(submenu => {
                if (submenu.id !== floor + '-submenu') {
                    submenu.classList.remove('active');
                }
            });
            
            allFloorBtns.forEach(btn => {
                btn.classList.remove('active');
            });

            // Toggle current submenu
            const submenu = document.getElementById(floor + '-submenu');
            const floorBtn = event.target;
            
            if (submenu.classList.contains('active')) {
                submenu.classList.remove('active');
                floorBtn.classList.remove('active');
                currentFloor = null;
            } else {
                submenu.classList.add('active');
                floorBtn.classList.add('active');
                currentFloor = floor;
            }

            // Clear room selection when changing floor
            clearRoomSelection();
        }

        function selectRoom(floor, roomType) {
            currentFloor = floor;
            currentRoom = roomType;

            // Clear all room button selections
            const allRoomBtns = document.querySelectorAll('.room-btn');
            allRoomBtns.forEach(btn => btn.classList.remove('selected'));

            // Show rooms for the selected type if it's Piano Primo, Piano Ammezzato or Piano Secondo
            if (floor === 'piano1' || floor === 'piano2' || floor === 'piano3') {
                event.target.classList.add('selected');
                showRoomsForType(floor, roomType);
                return;
            }

            // Select current room button
            event.target.classList.add('selected');

            // Show room information
            showRoomInfo(floor, roomType);
        }

        function clearRoomSelection() {
            const allRoomBtns = document.querySelectorAll('.room-btn');
            allRoomBtns.forEach(btn => btn.classList.remove('selected'));
            
            // Hide room number grid
            const roomsDiv = document.getElementById('piano1-tripla-rooms');
            if (roomsDiv) roomsDiv.style.display = 'none';
            
            document.getElementById('welcome').style.display = 'block';
            document.getElementById('room-info').classList.remove('active');
            document.getElementById('riepilogo-info').classList.remove('active');
            document.getElementById('tripla-rooms-view').classList.remove('active');
            document.getElementById('disponibilita-info').classList.remove('active');
            document.getElementById('dati-info').classList.remove('active');
            document.getElementById('modifica-camere-info').classList.remove('active');
            document.getElementById('spogliatoi-info').classList.remove('active');
            document.getElementById('locali-info').classList.remove('active');
            document.getElementById('genera-ricevuta-info').classList.remove('active');
            
            currentRoom = null;
        }

        function showRoomInfo(floor, roomType) {
            const floorNames = {
                'piano1': 'Piano Primo',
                'piano2': 'Piano Ammezzato', 
                'piano3': 'Piano Secondo'
            };

            const roomTypes = {
                'singola': 'Camera Singola',
                'doppia': 'Camera Doppia',
                'tripla': 'Camera Tripla',
                'quadrupla': 'Camera Quadrupla',
                'quintupla': 'Camera Quintupla'
            };

            const roomDescriptions = {
                'singola': 'Camera per una persona con letto singolo, scrivania e armadio.',
                'doppia': 'Camera per due persone con letti singoli o matrimoniale, scrivania e armadio.',
                'tripla': 'Camera per tre persone con tre letti singoli, scrivania e armadio.',
                'quadrupla': 'Camera per quattro persone con quattro letti singoli, scrivania e armadio.',
                'quintupla': 'Camera per cinque persone con cinque letti singoli, scrivania e armadio.'
            };

            document.getElementById('welcome').style.display = 'none';
            document.getElementById('riepilogo-info').classList.remove('active');
            document.getElementById('tripla-rooms-view').classList.remove('active');
            document.getElementById('disponibilita-info').classList.remove('active');
            document.getElementById('dati-info').classList.remove('active');
            document.getElementById('modifica-camere-info').classList.remove('active');
            document.getElementById('spogliatoi-info').classList.remove('active');
            document.getElementById('locali-info').classList.remove('active');
            document.getElementById('genera-ricevuta-info').classList.remove('active');
            document.getElementById('room-title').textContent = `${floorNames[floor]} - ${roomTypes[roomType]}`;
            document.getElementById('room-description').textContent = roomDescriptions[roomType];
            
            // Add some additional details
            document.getElementById('room-details').innerHTML = `
                <p><strong>Capacit√†:</strong> ${roomType === 'singola' ? '1' : roomType === 'doppia' ? '2' : roomType === 'tripla' ? '3' : '4'} persone</p>
                <p><strong>Servizi inclusi:</strong> Bagno privato, riscaldamento, Wi-Fi</p>
                <p><strong>Piano:</strong> ${floorNames[floor]}</p>
            `;

            document.getElementById('room-info').classList.add('active');
        }

        function showRoomsForType(floor, roomType) {
            // Hide all other views
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('room-info').classList.remove('active');
            document.getElementById('riepilogo-info').classList.remove('active');
            document.getElementById('disponibilita-info').classList.remove('active');
            document.getElementById('dati-info').classList.remove('active');
            document.getElementById('modifica-camere-info').classList.remove('active');
            document.getElementById('spogliatoi-info').classList.remove('active');
            document.getElementById('locali-info').classList.remove('active');
            document.getElementById('genera-ricevuta-info').classList.remove('active');
            
            // Generate dynamic room list
            generateDynamicRoomView(floor, roomType);
            document.getElementById('tripla-rooms-view').classList.add('active');
        }

        function generateDynamicRoomView(floor, roomType) {
            const floorNames = {
                'piano1': 'Piano Primo',
                'piano2': 'Piano Ammezzato', 
                'piano3': 'Piano Secondo'
            };

            const roomTypeNames = {
                'singola': 'Singole',
                'doppia': 'Doppie',
                'tripla': 'Triple',
                'quadrupla': 'Quadruple',
                'quintupla': 'Quintuple'
            };

            const roomTypeBeds = {
                'singola': 1,
                'doppia': 2,
                'tripla': 3,
                'quadrupla': 4,
                'quintupla': 5
            };

            const targetBeds = roomTypeBeds[roomType];
            
            // Find all rooms that match the selected type and floor
            const matchingRooms = Object.keys(roomData).filter(roomNumber => {
                const hasCorrectBeds = roomData[roomNumber].beds.length === targetBeds;
                
                // Filter by floor based on room number prefix
                let belongsToFloor = false;
                if (floor === 'piano1') {
                    belongsToFloor = roomNumber.startsWith('1-') || /^10[1-5]$/.test(roomNumber);
                } else if (floor === 'piano2') {
                    belongsToFloor = roomNumber.startsWith('A-');
                } else if (floor === 'piano3') {
                    belongsToFloor = roomNumber.startsWith('2-') || roomNumber.startsWith('S-');
                }
                
                return hasCorrectBeds && belongsToFloor;
            }).sort((a, b) => {
                // Sort rooms in ascending order (natural sort for mixed numbers)
                const aNum = a.match(/\d+/g)?.map(Number) || [0];
                const bNum = b.match(/\d+/g)?.map(Number) || [0];
                
                // Compare first number
                if (aNum[0] !== bNum[0]) return aNum[0] - bNum[0];
                
                // If first numbers are equal, compare second numbers
                if (aNum[1] !== undefined && bNum[1] !== undefined) {
                    return aNum[1] - bNum[1];
                }
                
                return a.localeCompare(b);
            });

            // Update the title
            const title = document.querySelector('#tripla-rooms-view h2');
            title.textContent = `${floorNames[floor]} - Camere ${roomTypeNames[roomType]}`;
            
            // Update the description
            const description = document.querySelector('#tripla-rooms-view p');
            if (matchingRooms.length === 0) {
                description.textContent = `Nessuna camera configurata come ${roomTypeNames[roomType].toLowerCase()}.`;
            } else {
                description.textContent = 'Seleziona una camera per gestire le assegnazioni dei letti:';
            }

            // Generate room buttons
            const roomGrid = document.querySelector('#tripla-rooms-view .room-grid');
            let roomsHtml = '';
            
            matchingRooms.forEach(roomNumber => {
                const furnitureData = roomData[roomNumber].furniture || {};
                const hasBathroom = furnitureData.bagno !== undefined;
                const bathroomEmoji = hasBathroom ? '<span style="font-size: 1.2em; margin-right: 5px;">üöΩ</span>' : '';
                
                roomsHtml += `
                    <button class="room-number-btn" onclick="openRoomModal('${roomNumber}')" style="width: 18%; margin: 10px;">
                        ${bathroomEmoji}${roomNumber}
                        <div class="status-indicator" id="status-${roomNumber}"></div>
                    </button>
                `;
            });
            
            roomGrid.innerHTML = roomsHtml;
            
            // Update status indicators for all rooms after generating the HTML
            matchingRooms.forEach(roomNumber => {
                updateRoomStatus(roomNumber);
            });
        }

        function showRiepilogo(buttonElement) {
            // Clear all selections
            const allSubmenus = document.querySelectorAll('.submenu');
            const allFloorBtns = document.querySelectorAll('.floor-btn');
            const allRoomBtns = document.querySelectorAll('.room-btn');
            
            allSubmenus.forEach(submenu => submenu.classList.remove('active'));
            allFloorBtns.forEach(btn => btn.classList.remove('active'));
            allRoomBtns.forEach(btn => btn.classList.remove('selected'));
            
            // Activate RIEPILOGO button
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            // Hide room grid
            const roomsDiv = document.getElementById('piano1-tripla-rooms');
            if (roomsDiv) roomsDiv.style.display = 'none';

            // Show riepilogo
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('room-info').classList.remove('active');
            document.getElementById('tripla-rooms-view').classList.remove('active');
            document.getElementById('disponibilita-info').classList.remove('active');
            document.getElementById('dati-info').classList.remove('active');
            document.getElementById('modifica-camere-info').classList.remove('active');
            document.getElementById('spogliatoi-info').classList.remove('active');
            document.getElementById('locali-info').classList.remove('active');
            document.getElementById('genera-ricevuta-info').classList.remove('active');
            document.getElementById('riepilogo-info').classList.add('active');
            
            // Initialize with Piano Primo
            setTimeout(() => {
                const piano1Btn = document.querySelector('.riepilogo-btn');
                if (piano1Btn) {
                    showRiepilogoPiano('piano1');
                }
            }, 100);
            
            currentFloor = null;
            currentRoom = null;
        }

        function showDisponibilita(buttonElement) {
            // Clear all selections
            const allSubmenus = document.querySelectorAll('.submenu');
            const allFloorBtns = document.querySelectorAll('.floor-btn');
            const allRoomBtns = document.querySelectorAll('.room-btn');
            
            allSubmenus.forEach(submenu => submenu.classList.remove('active'));
            allFloorBtns.forEach(btn => btn.classList.remove('active'));
            allRoomBtns.forEach(btn => btn.classList.remove('selected'));
            
            // Activate DISPONIBILIT√Ä button
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            // Hide room grid
            const roomsDiv = document.getElementById('piano1-tripla-rooms');
            if (roomsDiv) roomsDiv.style.display = 'none';

            // Show disponibilit√† page
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('room-info').classList.remove('active');
            document.getElementById('tripla-rooms-view').classList.remove('active');
            document.getElementById('riepilogo-info').classList.remove('active');
            document.getElementById('dati-info').classList.remove('active');
            document.getElementById('modifica-camere-info').classList.remove('active');
            document.getElementById('spogliatoi-info').classList.remove('active');
            document.getElementById('locali-info').classList.remove('active');
            document.getElementById('genera-ricevuta-info').classList.remove('active');
            document.getElementById('disponibilita-info').classList.add('active');
            
            // Generate availability data
            generateDisponibilitaData();
            
            currentFloor = null;
            currentRoom = null;
        }

        function generateDisponibilitaData() {
            const liberiContent = document.getElementById('liberi-panel-content');
            const occupatiContent = document.getElementById('occupati-panel-content');
            const liberiTitle = document.getElementById('liberi-panel-title');
            const occupatiTitle = document.getElementById('occupati-panel-title');
            
            let liberiHtml = '';
            let occupatiHtml = '';
            
            // Generate data for each floor
            const floors = [
                { id: 'piano1', name: 'PIANO PRIMO', color: '#27ae60', bgColor: 'rgba(39, 174, 96, 0.1)' },
                { id: 'piano2', name: 'PIANO AMMEZZATO', color: '#f39c12', bgColor: 'rgba(243, 156, 18, 0.1)' },
                { id: 'piano3', name: 'PIANO SECONDO', color: '#3498db', bgColor: 'rgba(52, 152, 219, 0.1)' }
            ];
            
            floors.forEach(floor => {
                const floorRooms = getRoomsByFloor(floor.id);
                let floorLiberiCount = 0;
                let floorOccupatiCount = 0;
                let floorStanzeLibereCount = 0;
                let floorStanzeOccupateCount = 0;
                let floorLiberiDetails = '';
                let floorOccupatiDetails = '';
                
                floorRooms.forEach(roomNumber => {
                    const data = roomData[roomNumber];
                    
                    if (data.unavailable) {
                        return;
                    } else if (data.underWork) {
                        return;
                    } else {
                        const occupiedBeds = data.beds.filter(bed => bed.trim() !== '').length;
                        const totalBeds = data.beds.length;
                        const freeBeds = totalBeds - occupiedBeds;
                        
                        if (freeBeds > 0) {
                            floorLiberiCount += freeBeds;
                            const freeBedNumbers = [];
                            data.beds.forEach((bed, index) => {
                                if (bed.trim() === '') {
                                    freeBedNumbers.push(index + 1);
                                }
                            });
                            
                            const isFullyFree = occupiedBeds === 0;
                            const textColor = isFullyFree ? '#27ae60' : '#f39c12';
                            
                            const roomTypeName = getRoomTypeName(totalBeds);
                            floorLiberiDetails += `<div class="room-item" style="border-left: 3px solid #27ae60;">
                                <strong style="color: ${textColor};">Camera ${roomNumber} (${roomTypeName.toUpperCase()}):</strong> ${freeBeds} ${freeBeds === 1 ? 'letto libero' : 'letti liberi'}
                                <br><small>Letti disponibili: ${freeBedNumbers.join(', ')}</small>
                            </div>`;
                        }
                        
                        if (occupiedBeds === 0) {
                            floorStanzeLibereCount++;
                        } else {
                            floorStanzeOccupateCount++;
                        }
                        
                        if (occupiedBeds > 0) {
                            floorOccupatiCount += occupiedBeds;
                            const occupiedBedNumbers = [];
                            data.beds.forEach((bed, index) => {
                                if (bed.trim() !== '') {
                                    occupiedBedNumbers.push(`Letto ${index + 1}: ${bed}`);
                                }
                            });
                            const roomTypeName = getRoomTypeName(totalBeds);
                            floorOccupatiDetails += `<div class="room-item" style="border-left: 3px solid #e74c3c;">
                                <strong>Camera ${roomNumber} (${roomTypeName.toUpperCase()}):</strong> ${occupiedBeds} ${occupiedBeds === 1 ? 'letto occupato' : 'letti occupati'}
                                <br><small>${occupiedBedNumbers.join('<br><small>')}</small>
                            </div>`;
                        }
                    }
                });
                
                // Add floor summary to liberi with accordion functionality
                liberiHtml += `
                    <div class="room-item disponibilita-floor-header" onclick="toggleFloorDetails('liberi', '${floor.id}')" 
                         style="border-left: 4px solid ${floor.color}; background: ${floor.bgColor}; cursor: pointer; position: relative;">
                        <strong>${floor.name}</strong>
                        <span class="expand-indicator" id="liberi-${floor.id}-indicator" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 14px;">‚ñº</span>
                        <br>
                        <small>Stanze libere: ${floorStanzeLibereCount}</small><br>
                        <small>Totale letti liberi: ${floorLiberiCount}</small>
                    </div>
                    <div class="floor-details" id="liberi-${floor.id}-details" style="display: none;">
                        ${floorLiberiDetails}
                        ${floorRooms.length === 0 ? '<p style="color: rgba(255,255,255,0.6); margin-left: 15px; font-style: italic;">Nessuna camera configurata</p>' : ''}
                    </div>
                `;
                
                // OCCUPATI - COPIA LETTERALE DA LIBERI (LINEE 2065-2078)
                occupatiHtml += `
                    <div class="room-item disponibilita-floor-header" onclick="toggleFloorDetails('occupati', '${floor.id}')" 
                         style="border-left: 4px solid ${floor.color}; background: ${floor.bgColor}; cursor: pointer; position: relative;">
                        <strong style="font-size: 1.17em !important; font-weight: bold !important;">${floor.name}</strong>
                        <span class="expand-indicator" id="occupati-${floor.id}-indicator" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 14px;">‚ñº</span>
                        <br>
                        <small>Stanze occupate: ${floorStanzeOccupateCount}</small><br>
                        <small>Totale letti occupati: ${floorOccupatiCount}</small>
                    </div>
                    <div class="floor-details" id="occupati-${floor.id}-details" style="display: none;">
                        ${floorOccupatiDetails}
                        ${floorRooms.length === 0 ? '<p style="color: rgba(255,255,255,0.6); margin-left: 15px; font-style: italic;">Nessuna camera configurata</p>' : ''}
                    </div>
                `;
            });
            
            if (liberiHtml === '') {
                liberiHtml = '<p style="color: rgba(255,255,255,0.6); margin-left: 15px; font-style: italic;">Tutti i letti sono occupati o le camere non sono agibili</p>';
            }
            
            if (occupatiHtml === '') {
                occupatiHtml = '<p style="color: rgba(255,255,255,0.6); margin-left: 15px; font-style: italic;">Nessun letto occupato</p>';
            }
            
            liberiContent.innerHTML = liberiHtml;
            occupatiContent.innerHTML = occupatiHtml;
            
            // Calculate total counts for titles
            const allFloors = [getRoomsByFloor('piano1'), getRoomsByFloor('piano2'), getRoomsByFloor('piano3')];
            let totalStanzeLibere = 0;
            let totalStanzeOccupate = 0;
            let totalLettiLiberi = 0;
            let totalLettiOccupati = 0;
            
            allFloors.forEach(floorRooms => {
                const floorStats = getFloorStats(floorRooms);
                totalStanzeLibere += floorStats.stanzeLibere;
                totalStanzeOccupate += floorStats.stanzeOccupate;
                totalLettiLiberi += floorStats.liberi;
                totalLettiOccupati += floorStats.occupati;
            });
            
            // Update titles with totals
            liberiTitle.innerHTML = `üü¢ STANZE/LETTI LIBERI (${totalStanzeLibere}/${totalLettiLiberi})`;
            occupatiTitle.innerHTML = `üî¥ STANZE/LETTI OCCUPATI (${totalStanzeOccupate}/${totalLettiOccupati})`;
        }

        function toggleFloorDetails(section, floorId) {
            // Get all floor details in this section
            const allDetailsInSection = document.querySelectorAll(`[id^="${section}-"][id$="-details"]`);
            const allIndicatorsInSection = document.querySelectorAll(`[id^="${section}-"][id$="-indicator"]`);
            
            const targetDetails = document.getElementById(`${section}-${floorId}-details`);
            const targetIndicator = document.getElementById(`${section}-${floorId}-indicator`);
            
            // Check if the clicked floor is currently expanded
            const isCurrentlyExpanded = targetDetails.style.display === 'block';
            
            // Collapse all floors in this section
            allDetailsInSection.forEach(details => {
                details.style.display = 'none';
            });
            allIndicatorsInSection.forEach(indicator => {
                indicator.textContent = '‚ñº';
                indicator.style.transform = 'translateY(-50%) rotate(0deg)';
            });
            
            // If the clicked floor wasn't expanded, expand it
            if (!isCurrentlyExpanded) {
                targetDetails.style.display = 'block';
                targetIndicator.textContent = '‚ñ≤';
                targetIndicator.style.transform = 'translateY(-50%) rotate(0deg)';
            }
            
            // Prevent event bubbling
            event.stopPropagation();
        }

        // Close accordion when clicking outside
        document.addEventListener('click', function(event) {
            // Check if click was outside any floor header
            if (!event.target.closest('.disponibilita-floor-header')) {
                // Close all accordion details
                const allDetails = document.querySelectorAll('.floor-details');
                const allIndicators = document.querySelectorAll('.expand-indicator');
                
                allDetails.forEach(details => {
                    details.style.display = 'none';
                });
                allIndicators.forEach(indicator => {
                    indicator.textContent = '‚ñº';
                    indicator.style.transform = 'translateY(-50%) rotate(0deg)';
                });
            }
        });

        function showGeneraRicevuta(buttonElement) {
            // Clear all selections
            const allSubmenus = document.querySelectorAll('.submenu');
            const allFloorBtns = document.querySelectorAll('.floor-btn');
            const allRoomBtns = document.querySelectorAll('.room-btn');
            
            allSubmenus.forEach(submenu => submenu.classList.remove('active'));
            allFloorBtns.forEach(btn => btn.classList.remove('active'));
            allRoomBtns.forEach(btn => btn.classList.remove('selected'));
            
            // Activate GENERA RICEVUTA button
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            // Hide room grid
            const roomsDiv = document.getElementById('piano1-tripla-rooms');
            if (roomsDiv) roomsDiv.style.display = 'none';

            // Show genera ricevuta page
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('room-info').classList.remove('active');
            document.getElementById('tripla-rooms-view').classList.remove('active');
            document.getElementById('riepilogo-info').classList.remove('active');
            document.getElementById('disponibilita-info').classList.remove('active');
            document.getElementById('dati-info').classList.remove('active');
            document.getElementById('modifica-camere-info').classList.remove('active');
            document.getElementById('spogliatoi-info').classList.remove('active');
            document.getElementById('locali-info').classList.remove('active');
            document.getElementById('genera-ricevuta-info').classList.remove('active');
            document.getElementById('genera-ricevuta-info').classList.add('active');
            
            // Initialize selection grids
            initializeRicevutaSelections();
            
            currentFloor = null;
            currentRoom = null;
        }

        function showDati(buttonElement) {
            // Clear all selections
            const allSubmenus = document.querySelectorAll('.submenu');
            const allFloorBtns = document.querySelectorAll('.floor-btn');
            const allRoomBtns = document.querySelectorAll('.room-btn');
            
            allSubmenus.forEach(submenu => submenu.classList.remove('active'));
            allFloorBtns.forEach(btn => btn.classList.remove('active'));
            allRoomBtns.forEach(btn => btn.classList.remove('selected'));
            
            // Activate DATI button
            if (buttonElement) {
                buttonElement.classList.add('active');
            }

            // Hide room grid
            const roomsDiv = document.getElementById('piano1-tripla-rooms');
            if (roomsDiv) roomsDiv.style.display = 'none';

            // Show dati page
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('room-info').classList.remove('active');
            document.getElementById('tripla-rooms-view').classList.remove('active');
            document.getElementById('disponibilita-info').classList.remove('active');
            document.getElementById('riepilogo-info').classList.remove('active');
            document.getElementById('modifica-camere-info').classList.remove('active');
            document.getElementById('spogliatoi-info').classList.remove('active');
            document.getElementById('locali-info').classList.remove('active');
            document.getElementById('genera-ricevuta-info').classList.remove('active');
            document.getElementById('dati-info').classList.add('active');
            
            // Initialize with ESPORTA tab
            setTimeout(() => {
                showDatiTab('esporta');
            }, 100);
            
            currentFloor = null;
            currentRoom = null;
        }

        function showDatiTab(tab, targetButton = null) {
            // Check authentication for destructive operations
            if (tab === 'elimina' && !requireAuthentication()) {
                return;
            }
            
            // Update button states
            const buttons = document.querySelectorAll('.dati-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Find the button to activate
            if (targetButton) {
                targetButton.classList.add('active');
            } else {
                // Find button by tab name when called programmatically
                const buttonText = {
                    'esporta': 'ESPORTA',
                    'importa': 'IMPORTA', 
                    'elimina': 'ELIMINA TUTTI I DATI'
                };
                const targetBtn = Array.from(buttons).find(btn => btn.textContent.trim() === buttonText[tab]);
                if (targetBtn) targetBtn.classList.add('active');
            }

            const content = document.getElementById('dati-content');
            
            if (tab === 'esporta') {
                content.innerHTML = `
                    <div class="export-info">
                        <h3>üì§ Esporta Dati</h3>
                        <p>Scarica tutti i dati delle camere e assegnazioni in formato JSON</p>
                    </div>
                    
                    <div>
                        <p><strong>Dati che verranno esportati:</strong></p>
                        <ul style="text-align: left; display: inline-block; margin: 20px 0;">
                            <li>Assegnazioni letti per tutte le camere</li>
                            <li>Stati camere (disponibili, non agibili, ai lavori)</li>
                            <li>Note per ogni camera</li>
                            <li>Data e ora di esportazione</li>
                        </ul>
                    </div>
                    
                    <button class="save-btn" onclick="exportData()" style="font-size: 1.1em; padding: 15px 30px;">
                        üì• Scarica File JSON
                    </button>
                    
                    <div style="text-align: center; margin: 30px 0; border-top: 2px solid rgba(135, 206, 250, 0.3); padding-top: 30px;">
                        <h3>üîÑ Salvataggio Automatico</h3>
                        <p style="margin: 10px 0; color: #6c757d; font-size: 0.9em;">
                            Abilita il salvataggio automatico delle modifiche
                        </p>
                        <div style="margin: 20px 0;">
                            <label style="display: flex; align-items: center; justify-content: center; margin: 10px 0;">
                                <input type="checkbox" id="auto-save-enabled" onchange="toggleAutoSave()" style="margin-right: 10px;">
                                <span>Abilita Auto-save</span>
                            </label>
                        </div>
                        <div style="background-color: rgba(135, 206, 250, 0.1); border: 1px solid rgba(135, 206, 250, 0.3); border-radius: 8px; padding: 15px; margin: 20px auto; max-width: 500px; text-align: left;">
                            <p style="margin: 0; font-size: 0.9em; color: #495057;">
                                <strong>‚ÑπÔ∏è Come funziona l'Auto-save:</strong><br>
                                ‚Ä¢ Disabilitato per impostazione predefinita<br>
                                ‚Ä¢ Una volta abilitato, salva automaticamente dopo ogni modifica<br>
                                ‚Ä¢ Le modifiche vengono salvate nel formato JSON configurato<br>
                                ‚Ä¢ Puoi disabilitarlo in qualsiasi momento
                            </p>
                        </div>
                    </div>
                    
                    <div id="export-status"></div>
                `;
                // Initialize auto-save checkbox state after DOM is updated
                setTimeout(() => initializeAutoSave(), 0);
            } else if (tab === 'importa') {
                content.innerHTML = `
                    <div class="import-info">
                        <h3>üì§ Importa Dati</h3>
                        <p>Carica un file JSON precedentemente esportato per ripristinare i dati</p>
                        <p><strong>‚ö†Ô∏è Attenzione:</strong> Tutti i dati attuali verranno sostituiti!</p>
                    </div>
                    
                    <div class="import-methods" style="margin-bottom: 30px;">
                        <h4 style="margin-bottom: 15px;">Carica il file dalla tua cartella</h4>
                        <button class="save-btn" onclick="loadPiomartaJSON()" style="font-size: 1.1em; padding: 15px 30px; background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);">
                            CARICA
                        </button>
                    </div>
                    
                    <div id="import-status"></div>
                `;
            } else if (tab === 'elimina') {
                content.innerHTML = `
                    <div class="delete-info">
                        <h3>üóëÔ∏è Elimina Tutti i Dati</h3>
                        <p><strong>‚ö†Ô∏è ATTENZIONE: OPERAZIONE IRREVERSIBILE ‚ö†Ô∏è</strong></p>
                        <p>Questa funzione canceller√† completamente tutti i dati memorizzati:</p>
                    </div>
                    
                    <div>
                        <p><strong>Dati che verranno eliminati:</strong></p>
                        <ul style="text-align: left; display: inline-block; margin: 20px 0; color: #e74c3c;">
                            <li>Tutte le assegnazioni letti</li>
                            <li>Stati di tutte le camere</li>
                            <li>Note di tutte le camere</li>
                            <li>Tutti i dati salvati localmente</li>
                        </ul>
                    </div>
                    
                    <p style="margin: 30px 0; font-size: 1.1em; color: #f39c12;">
                        <strong>üí° Consiglio:</strong> Esporta i dati prima di eliminarli, per avere un backup di sicurezza!
                    </p>
                    
                    <button class="save-btn delete-btn" onclick="showDeleteConfirmation()" style="font-size: 1.1em; padding: 15px 30px; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                        üóëÔ∏è ELIMINA TUTTI I DATI
                    </button>
                    
                    <div id="delete-status"></div>
                `;
            }
        }

        function exportData() {
            try {
                const exportData = {
                    version: "2.0",
                    exportDate: new Date().toISOString(),
                    exportTime: new Date().toLocaleString('it-IT'),
                    roomData: roomData,
                    spogliatoioData: spogliatoioData,
                    localiData: localiData,
                    metadata: {
                        totalRooms: Object.keys(roomData).length,
                        totalSpogliatoi: Object.keys(spogliatoioData).length,
                        totalLocali: Object.keys(localiData).length,
                        applicationName: "GESTIONE ALLOGGI CASERMA L. PIOMARTA"
                    }
                };
                
                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `maristanav_dati_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                document.getElementById('export-status').innerHTML = `
                    <div class="status-message status-success">
                        ‚úÖ Dati esportati con successo!<br>
                        <small>File: maristanav_dati_${new Date().toISOString().split('T')[0]}.json</small>
                    </div>
                `;
            } catch (error) {
                document.getElementById('export-status').innerHTML = `
                    <div class="status-message status-error">
                        ‚ùå Errore durante l'esportazione: ${error.message}
                    </div>
                `;
            }
        }

        function toggleAutoSave() {
            const checkbox = document.getElementById('auto-save-enabled');
            const autoSaveStatus = document.getElementById('autoSaveStatus');
            
            if (checkbox.checked) {
                localStorage.setItem('piomarta_auto_save_enabled', 'true');
                // Aggiorna l'indicatore di stato
                if (autoSaveStatus) {
                    autoSaveStatus.textContent = 'AUTO-SAVE ATTIVO';
                    autoSaveStatus.classList.remove('auto-save-inactive');
                    autoSaveStatus.classList.add('auto-save-active');
                }
                // Show success notification if showNotification function exists
                if (typeof showNotification === 'function') {
                    showNotification('Auto-save abilitato - le modifiche saranno salvate automaticamente', 'success');
                } else {
                    // Fallback: show status in export-status div
                    document.getElementById('export-status').innerHTML = `
                        <div class="status-message status-success">
                            ‚úÖ Auto-save abilitato - le modifiche saranno salvate automaticamente
                        </div>
                    `;
                    setTimeout(() => {
                        document.getElementById('export-status').innerHTML = '';
                    }, 3000);
                }
            } else {
                localStorage.setItem('piomarta_auto_save_enabled', 'false');
                // Aggiorna l'indicatore di stato
                if (autoSaveStatus) {
                    autoSaveStatus.textContent = 'AUTO-SAVE NON ATTIVO';
                    autoSaveStatus.classList.remove('auto-save-active');
                    autoSaveStatus.classList.add('auto-save-inactive');
                }
                // Show warning notification if showNotification function exists
                if (typeof showNotification === 'function') {
                    showNotification('Auto-save disabilitato', 'warning');
                } else {
                    // Fallback: show status in export-status div
                    document.getElementById('export-status').innerHTML = `
                        <div class="status-message status-warning">
                            ‚ö†Ô∏è Auto-save disabilitato
                        </div>
                    `;
                    setTimeout(() => {
                        document.getElementById('export-status').innerHTML = '';
                    }, 3000);
                }
            }
        }

        function handleFileSelect() {
            const fileInput = document.getElementById('import-file');
            const importBtn = document.getElementById('import-btn');
            
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                if (file.type === 'application/json' || file.name.endsWith('.json')) {
                    importBtn.disabled = false;
                    importBtn.style.opacity = '1';
                } else {
                    importBtn.disabled = true;
                    importBtn.style.opacity = '0.5';
                    document.getElementById('import-status').innerHTML = `
                        <div class="status-message status-error">
                            ‚ùå Seleziona un file JSON valido
                        </div>
                    `;
                }
            } else {
                importBtn.disabled = true;
                importBtn.style.opacity = '0.5';
            }
        }

        function importData() {
            const fileInput = document.getElementById('import-file');
            if (fileInput.files.length === 0) return;
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importedData.roomData) {
                        throw new Error('File JSON non valido: manca roomData');
                    }
                    
                    // Validate room data structure
                    const expectedRooms = [
                        // Singole
                        '1-02', '1-03', '1-04', '1-06',
                        // Doppie
                        '1-01', '1-10', '1-11', '1-12', '1-13', '1-14', '1-15', '1-16', '1-17', '1-18',
                        '1-19', '1-20', '1-21', '1-22', '1-23', '1-24', '1-25', '1-26', '1-27', '1-28',
                        '1-29', '1-30', '1-31', '1-32', '1-101', '1-102', '1-103', '1-104', '1-105',
                        '1-106', '1-107', '1-108', '1-109', '1-110',
                        // Tripla
                        '1-39',
                        // Quadruple Piano Primo
                        '1-41', '1-43', '1-45', '1-47', '1-49', '1-51', '1-53', '1-55', '1-57', '1-59',
                        '1-61', '1-62', '1-67', '1-71', '1-73',
                        // Triple Piano Ammezzato
                        'A-63', 'A-65', 'A-67', 'A-69', 'A-71', 'A-73', 'A-75', 'A-77', 'A-83', 'A-85',
                        'A-86', 'A-87', 'A-89', 'A-91', 'A-93', 'A-95', 'A-97',
                        // Quadrupla Piano Ammezzato  
                        'A-79',
                        // Quintuple Piano Ammezzato
                        'A-80', 'A-81',
                        // Singola Piano Secondo
                        '2-06',
                        // Doppie Piano Secondo
                        '2-03', '2-07', '2-09', '2-10', '2-11', '2-12', '2-13', '2-14', '2-15', '2-16',
                        '2-17', '2-18', '2-19', '2-20', '2-21', '2-22', '2-23', '2-24', '2-25', '2-26',
                        '2-27', '2-28', '2-29', '2-30', '2-31', '2-77', '2-78', '2-79', '2-80', '2-88',
                        '2-89', '2-90', '2-91', '2-92', '2-93', '2-94', '2-95', '2-96', '2-97', '2-98',
                        '2-99', '2-100', '2-101', '2-102', '2-103', '2-104', '2-105', '2-106', '2-107', '2-108',
                        '2-109', '2-110',
                        // Tripla Piano Secondo
                        '2-43',
                        // Quadruple Piano Secondo
                        '2-01', '2-08', '2-45', '2-47', '2-49', '2-51', '2-52', '2-53', '2-55', '2-57',
                        '2-58', '2-59', '2-60', '2-62', '2-64', '2-65', '2-67', '2-69', '2-71', '2-73', '2-75'
                    ];
                    
                    expectedRooms.forEach(roomNum => {
                        if (!importedData.roomData[roomNum]) {
                            throw new Error(`Camera ${roomNum} mancante nei dati`);
                        }
                        const room = importedData.roomData[roomNum];
                        if (!room.beds || !Array.isArray(room.beds)) {
                            throw new Error(`Dati camera ${roomNum} non validi`);
                        }
                    });
                    
                    // Import room data
                    roomData = importedData.roomData;
                    Object.keys(roomData).forEach(roomNum => {
                        const room = roomData[roomNum];
                        if (room.unavailable === undefined) room.unavailable = false;
                        if (room.underWork === undefined) room.underWork = false;
                        if (room.notes === undefined) room.notes = '';
                    });
                    saveRoomDataToStorage();
                    initializeRoomStatus();
                    
                    // Import spogliatoio data (if exists)
                    if (importedData.spogliatoioData) {
                        spogliatoioData = importedData.spogliatoioData;
                        saveSpogliatoioDataToStorage();
                        initializeSpogliatoioStatus();
                    }
                    
                    // Import locali data (if exists)
                    if (importedData.localiData) {
                        localiData = importedData.localiData;
                        saveLocaliDataToStorage();
                        initializeLocaleStatus();
                    }
                    
                    document.getElementById('import-status').innerHTML = `
                        <div class="status-message status-success">
                            ‚úÖ Dati importati con successo!<br>
                            <small>Importati da: ${importedData.metadata?.applicationName || 'File sconosciuto'}</small><br>
                            <small>Data esportazione: ${importedData.exportTime || 'Non disponibile'}</small>
                        </div>
                    `;
                    
                    // Reset file input
                    fileInput.value = '';
                    document.getElementById('import-btn').disabled = true;
                    document.getElementById('import-btn').style.opacity = '0.5';
                    
                } catch (error) {
                    document.getElementById('import-status').innerHTML = `
                        <div class="status-message status-error">
                            ‚ùå Errore durante l'importazione: ${error.message}
                        </div>
                    `;
                }
            };
            
            reader.readAsText(file);
        }

        // Auto-save setup functions rimosso - ora gestito dal PiomartaManager

        // Auto-Save control functions

        // Notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: ${type === 'success' ? '#27ae60' : type === 'warning' ? '#f39c12' : '#e74c3c'};
                color: white;
                padding: 20px 30px;
                border-radius: 10px;
                font-size: 1.2em;
                font-weight: bold;
                z-index: 10000;
                box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                text-align: center;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Helper function for status messages
        function showStatusMessage(element, message, type) {
            if (!element) return;
            
            const bgColors = {
                success: 'rgba(39, 174, 96, 0.1)',
                error: 'rgba(231, 76, 60, 0.1)',
                warning: 'rgba(243, 156, 18, 0.1)',
                info: 'rgba(52, 152, 219, 0.1)'
            };
            
            const textColors = {
                success: '#27ae60',
                error: '#e74c3c',
                warning: '#f39c12',
                info: '#3498db'
            };
            
            element.innerHTML = `
                <div style="padding: 15px; background: ${bgColors[type] || bgColors.info}; 
                           color: ${textColors[type] || textColors.info}; border-radius: 5px; margin-top: 15px;">
                    ${message}
                </div>
            `;
        }

        function showDeleteConfirmation() {
            document.getElementById('confirmModal').style.display = 'block';
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        function confirmDeleteAllData() {
            try {
                // Reset room data to default empty state - mantieni struttura stanze, svuota solo assegnazioni
                roomData = getDefaultRoomData();
                localStorage.removeItem('maristanav_room_data');
                saveRoomDataToStorage();
                initializeRoomStatus();
                
                // Reset spogliatoi data to default empty state
                spogliatoioData = getDefaultSpogliatoioData();
                localStorage.removeItem('maristanav_spogliatoio_data');
                saveSpogliatoioDataToStorage();
                initializeSpogliatoioStatus();
                
                // Reset locali data to default empty state
                localiData = getDefaultLocaliData();
                localStorage.removeItem('maristanav_locali_data');
                saveLocaliDataToStorage();
                initializeLocaleStatus();
                
                // Close confirmation modal
                closeConfirmModal();
                
                // Show success message
                document.getElementById('delete-status').innerHTML = `
                    <div class="status-message status-success">
                        ‚úÖ Tutti i dati sono stati eliminati con successo!<br>
                        <small>Il sistema √® stato ripristinato allo stato iniziale (Camere, Spogliatoi e Locali)</small>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('delete-status').innerHTML = `
                    <div class="status-message status-error">
                        ‚ùå Errore durante l'eliminazione: ${error.message}
                    </div>
                `;
                closeConfirmModal();
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const roomModal = document.getElementById('roomModal');
            const comandoModal = document.getElementById('comandoModal');
            const confirmModal = document.getElementById('confirmModal');
            const arrediModal = document.getElementById('arrediModal');
            const spogliatoioModal = document.getElementById('spogliatoioModal');
            const spogliatoioArrediModal = document.getElementById('spogliatoioArrediModal');
            const localeModal = document.getElementById('localeModal');
            const localeArrediModal = document.getElementById('localeArrediModal');
            
            if (event.target == roomModal) {
                closeRoomModal();
            } else if (event.target == comandoModal) {
                closeComandoModal();
            } else if (event.target == confirmModal) {
                closeConfirmModal();
            } else if (event.target == arrediModal) {
                closeArrediModal();
            } else if (event.target == spogliatoioModal) {
                closeSpogliatoioModal();
            } else if (event.target == spogliatoioArrediModal) {
                closeSpogliatoioArrediModal();
            } else if (event.target == localeModal) {
                closeLocaleModal();
            } else if (event.target == localeArrediModal) {
                closeLocaleArrediModal();
            }
        }

        // Helper function to filter rooms by floor
        function getRoomsByFloor(floor) {
            return Object.keys(roomData).filter(roomNumber => {
                if (floor === 'piano1') {
                    return roomNumber.startsWith('1-') || /^10[1-5]$/.test(roomNumber);
                } else if (floor === 'piano2') {
                    return roomNumber.startsWith('A-');
                } else if (floor === 'piano3') {
                    return roomNumber.startsWith('2-') || roomNumber.startsWith('S-');
                }
                return false;
            }).sort((a, b) => {
                // Sort rooms in ascending order (natural sort for mixed numbers)
                const aNum = a.match(/\d+/g)?.map(Number) || [0];
                const bNum = b.match(/\d+/g)?.map(Number) || [0];
                
                // Compare first number
                if (aNum[0] !== bNum[0]) return aNum[0] - bNum[0];
                
                // If first numbers are equal, compare second numbers
                if (aNum[1] !== undefined && bNum[1] !== undefined) {
                    return aNum[1] - bNum[1];
                }
                
                return a.localeCompare(b);
            });
        }

        // Helper function to calculate floor statistics
        function getFloorStats(floorRooms) {
            const stats = {
                liberi: 0,
                occupati: 0,
                nonAgibili: 0,
                aiLavori: 0,
                stanzeLibere: 0,
                stanzeOccupate: 0,
                tipologie: { singole: 0, doppie: 0, triple: 0, quadruple: 0, quintuple: 0 }
            };

            floorRooms.forEach(roomNumber => {
                const data = roomData[roomNumber];
                const bedCount = data.beds.length;
                
                // Count room types
                if (bedCount === 1) stats.tipologie.singole++;
                else if (bedCount === 2) stats.tipologie.doppie++;
                else if (bedCount === 3) stats.tipologie.triple++;
                else if (bedCount === 4) stats.tipologie.quadruple++;
                else if (bedCount === 5) stats.tipologie.quintuple++;

                if (data.unavailable) {
                    stats.nonAgibili++;
                } else if (data.underWork) {
                    stats.aiLavori++;
                } else {
                    const occupied = data.beds.filter(bed => bed.trim() !== '').length;
                    stats.liberi += (data.beds.length - occupied);
                    stats.occupati += occupied;
                    
                    if (occupied === 0) {
                        stats.stanzeLibere++;
                    } else {
                        stats.stanzeOccupate++;
                    }
                }
            });

            return stats;
        }

        // Helper function to calculate comando stats for a specific floor
        function getFloorComandoStats(floorRooms) {
            const stats = {};
            
            floorRooms.forEach(roomNumber => {
                const data = roomData[roomNumber];
                if (!data.unavailable && !data.underWork) {
                    data.beds.forEach(bed => {
                        if (bed.trim() !== '') {
                            if (!stats[bed]) {
                                stats[bed] = { letti: 0, stanze: new Set() };
                            }
                            stats[bed].letti++;
                            stats[bed].stanze.add(roomNumber);
                        }
                    });
                }
            });
            
            // Convert Set to count
            Object.keys(stats).forEach(comando => {
                stats[comando].stanze = stats[comando].stanze.size;
            });
            
            return stats;
        }

        function showRiepilogoPiano(piano) {
            // Update button states
            const buttons = document.querySelectorAll('.riepilogo-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Find the correct button to activate based on the piano parameter
            let targetButton;
            switch(piano) {
                case 'piano1':
                    targetButton = buttons[0]; // PIANO PRIMO
                    break;
                case 'piano2':
                    targetButton = buttons[1]; // PIANO AMMEZZATO
                    break;
                case 'piano3':
                    targetButton = buttons[2]; // PIANO SECONDO
                    break;
                case 'spogliatoi':
                    targetButton = buttons[3]; // SPOGLIATOI
                    break;
                case 'generale':
                    targetButton = buttons[4]; // GENERALE
                    break;
                default:
                    targetButton = event?.target || buttons[0];
            }
            
            if (targetButton) {
                targetButton.classList.add('active');
            }
            
            // Show/hide PDF export button only for GENERALE
            const pdfExportBtn = document.getElementById('pdf-export-btn');
            if (piano === 'generale') {
                pdfExportBtn.style.display = 'inline-block';
            } else {
                pdfExportBtn.style.display = 'none';
            }

            const roomsTitle = document.getElementById('rooms-panel-title');
            const roomsContent = document.getElementById('rooms-panel-content');
            const comandoTitle = document.getElementById('comando-panel-title');
            const comandoContent = document.getElementById('comando-panel-content');

            if (piano === 'piano1') {
                roomsTitle.textContent = 'Camere Piano Primo';
                comandoTitle.textContent = 'Riepilogo per Comando';
                
                // Filter rooms by floor
                const floorRooms = getRoomsByFloor('piano1');
                
                // Show rooms summary
                let roomsHtml = '';
                floorRooms.forEach(roomNumber => {
                    const data = roomData[roomNumber];
                    const occupied = data.beds.filter(bed => bed.trim() !== '').length;
                    const roomType = getRoomTypeName(data.beds.length);
                    
                    roomsHtml += '<div class="room-item">';
                    if (data.unavailable) {
                        roomsHtml += `<strong>Camera ${roomNumber} (${roomType}):</strong> <span style="color: #e74c3c;">NON AGIBILE</span>`;
                    } else if (data.underWork) {
                        roomsHtml += `<strong>Camera ${roomNumber} (${roomType}):</strong> <span style="color: #8e44ad;">AI LAVORI</span>`;
                    } else if (occupied === 0) {
                        const totalBeds = data.beds.length;
                        const bedText = totalBeds === 1 ? 'letto' : 'letti';
                        roomsHtml += `<strong>Camera ${roomNumber} (${roomType}):</strong> <span style="color: #27ae60;">Libera (${totalBeds} ${bedText})</span>`;
                    } else if (occupied < data.beds.length) {
                        const freeBedsCount = data.beds.length - occupied;
                        const bedsText = freeBedsCount === 1 ? 'letto libero' : 'letti liberi';
                        roomsHtml += `<strong>Camera ${roomNumber} (${roomType}):</strong> <span style="color: #f39c12;">${freeBedsCount} ${bedsText}</span>`;
                    } else {
                        roomsHtml += `<strong>Camera ${roomNumber} (${roomType}):</strong> <span style="color: #e74c3c;">Completa</span>`;
                    }
                    
                    if (data.notes) {
                        roomsHtml += `<br><small>Note: ${data.notes}</small>`;
                    }
                    roomsHtml += '</div>';
                });
                roomsContent.innerHTML = roomsHtml;

                // Show comando summary for this floor
                const comandoStats = getFloorComandoStats(floorRooms);
                let comandoHtml = '';
                
                Object.keys(comandoStats).forEach(comando => {
                    const stats = comandoStats[comando];
                    comandoHtml += `
                        <div class="comando-item">
                            <div class="comando-stats">
                                <div>
                                    <strong>${comando}</strong><br>
                                    <small>${stats.letti} letti in ${stats.stanze} ${stats.stanze === 1 ? 'stanza' : 'stanze'}</small>
                                </div>
                                <button class="details-btn" onclick="showComandoDetails('${comando}')">Dettagli</button>
                            </div>
                        </div>
                    `;
                });
                
                if (comandoHtml === '') {
                    comandoHtml = '<p style="color: rgba(255,255,255,0.6);">Nessun comando assegnato</p>';
                }
                
                comandoContent.innerHTML = comandoHtml;
            } else if (piano === 'generale') {
                roomsTitle.textContent = 'Camere Tutti i Piani';
                comandoTitle.textContent = 'Riepilogo per Comando';
                
                // Generate summary for each floor
                const piano1Rooms = getRoomsByFloor('piano1');
                const piano2Rooms = getRoomsByFloor('piano2');
                const piano3Rooms = getRoomsByFloor('piano3');
                
                const piano1Stats = getFloorStats(piano1Rooms);
                const piano2Stats = getFloorStats(piano2Rooms);
                const piano3Stats = getFloorStats(piano3Rooms);
                
                // Calculate total statistics
                const totalStats = {
                    liberi: piano1Stats.liberi + piano2Stats.liberi + piano3Stats.liberi,
                    occupati: piano1Stats.occupati + piano2Stats.occupati + piano3Stats.occupati,
                    nonAgibili: piano1Stats.nonAgibili + piano2Stats.nonAgibili + piano3Stats.nonAgibili,
                    aiLavori: piano1Stats.aiLavori + piano2Stats.aiLavori + piano3Stats.aiLavori,
                    stanzeLibere: piano1Stats.stanzeLibere + piano2Stats.stanzeLibere + piano3Stats.stanzeLibere,
                    stanzeOccupate: piano1Stats.stanzeOccupate + piano2Stats.stanzeOccupate + piano3Stats.stanzeOccupate,
                    tipologie: {
                        singole: piano1Stats.tipologie.singole + piano2Stats.tipologie.singole + piano3Stats.tipologie.singole,
                        doppie: piano1Stats.tipologie.doppie + piano2Stats.tipologie.doppie + piano3Stats.tipologie.doppie,
                        triple: piano1Stats.tipologie.triple + piano2Stats.tipologie.triple + piano3Stats.tipologie.triple,
                        quadruple: piano1Stats.tipologie.quadruple + piano2Stats.tipologie.quadruple + piano3Stats.tipologie.quadruple,
                        quintuple: piano1Stats.tipologie.quintuple + piano2Stats.tipologie.quintuple + piano3Stats.tipologie.quintuple
                    }
                };
                
                let generalRoomsHtml = '';
                
                // First show GENERALE summary (total of all floors)
                generalRoomsHtml += `
                    <div class="room-item" style="border-left: 4px solid #e74c3c; background: rgba(231, 76, 60, 0.1);">
                        <strong>GENERALE (TOTALE)</strong><br>
                        <small>‚Ä¢ Letti liberi: ${totalStats.liberi}</small><br>
                        <small>‚Ä¢ Letti occupati: ${totalStats.occupati}</small><br>
                        <small>‚Ä¢ Stanze libere: ${totalStats.stanzeLibere}</small><br>
                        <small>‚Ä¢ Stanze occupate: ${totalStats.stanzeOccupate}</small><br>
                        <small>‚Ä¢ Stanze non agibili: ${totalStats.nonAgibili}</small><br>
                        <small>‚Ä¢ Stanze ai lavori: ${totalStats.aiLavori}</small><br>
                        <small style="color: #e74c3c;"><strong>Tipologie Totali:</strong> ${totalStats.tipologie.singole} Singole, ${totalStats.tipologie.doppie} Doppie, ${totalStats.tipologie.triple} Triple, ${totalStats.tipologie.quadruple} Quadruple, ${totalStats.tipologie.quintuple} Quintuple</small>
                    </div>
                `;
                
                // Piano Primo
                generalRoomsHtml += `
                    <div class="room-item" style="border-left: 4px solid #4a90e2;">
                        <strong>PIANO PRIMO</strong><br>
                        <small>‚Ä¢ Letti liberi: ${piano1Stats.liberi}</small><br>
                        <small>‚Ä¢ Letti occupati: ${piano1Stats.occupati}</small><br>
                        <small>‚Ä¢ Stanze libere: ${piano1Stats.stanzeLibere}</small><br>
                        <small>‚Ä¢ Stanze occupate: ${piano1Stats.stanzeOccupate}</small><br>
                        <small>‚Ä¢ Stanze non agibili: ${piano1Stats.nonAgibili}</small><br>
                        <small>‚Ä¢ Stanze ai lavori: ${piano1Stats.aiLavori}</small><br>
                        <small style="color: #4a90e2;"><strong>Tipologie:</strong> ${piano1Stats.tipologie.singole} Singole, ${piano1Stats.tipologie.doppie} Doppie, ${piano1Stats.tipologie.triple} Triple, ${piano1Stats.tipologie.quadruple} Quadruple, ${piano1Stats.tipologie.quintuple} Quintuple</small>
                    </div>
                `;
                
                // Piano Ammezzato
                generalRoomsHtml += `
                    <div class="room-item" style="border-left: 4px solid #f39c12;">
                        <strong>PIANO AMMEZZATO</strong><br>
                        <small>‚Ä¢ Letti liberi: ${piano2Stats.liberi}</small><br>
                        <small>‚Ä¢ Letti occupati: ${piano2Stats.occupati}</small><br>
                        <small>‚Ä¢ Stanze libere: ${piano2Stats.stanzeLibere}</small><br>
                        <small>‚Ä¢ Stanze occupate: ${piano2Stats.stanzeOccupate}</small><br>
                        <small>‚Ä¢ Stanze non agibili: ${piano2Stats.nonAgibili}</small><br>
                        <small>‚Ä¢ Stanze ai lavori: ${piano2Stats.aiLavori}</small><br>
                        <small style="color: #f39c12;"><strong>Tipologie:</strong> ${piano2Stats.tipologie.singole} Singole, ${piano2Stats.tipologie.doppie} Doppie, ${piano2Stats.tipologie.triple} Triple, ${piano2Stats.tipologie.quadruple} Quadruple, ${piano2Stats.tipologie.quintuple} Quintuple</small>
                    </div>
                `;
                
                // Piano Secondo
                generalRoomsHtml += `
                    <div class="room-item" style="border-left: 4px solid #27ae60;">
                        <strong>PIANO SECONDO</strong><br>
                        <small>‚Ä¢ Letti liberi: ${piano3Stats.liberi}</small><br>
                        <small>‚Ä¢ Letti occupati: ${piano3Stats.occupati}</small><br>
                        <small>‚Ä¢ Stanze libere: ${piano3Stats.stanzeLibere}</small><br>
                        <small>‚Ä¢ Stanze occupate: ${piano3Stats.stanzeOccupate}</small><br>
                        <small>‚Ä¢ Stanze non agibili: ${piano3Stats.nonAgibili}</small><br>
                        <small>‚Ä¢ Stanze ai lavori: ${piano3Stats.aiLavori}</small><br>
                        <small style="color: #27ae60;"><strong>Tipologie:</strong> ${piano3Stats.tipologie.singole} Singole, ${piano3Stats.tipologie.doppie} Doppie, ${piano3Stats.tipologie.triple} Triple, ${piano3Stats.tipologie.quadruple} Quadruple, ${piano3Stats.tipologie.quintuple} Quintuple</small>
                    </div>
                `;
                
                // Calculate spogliatoi statistics
                const allSpogliatoi = Object.keys(spogliatoioData);
                let spogliatoi_liberi = 0;
                let spogliatoi_occupati = 0;
                let spogliatoi_nonAgibili = 0;
                let spogliatoi_aiLavori = 0;
                
                allSpogliatoi.forEach(spogliatoioNumber => {
                    const data = spogliatoioData[spogliatoioNumber];
                    if (data.unavailable) {
                        spogliatoi_nonAgibili++;
                    } else if (data.underWork) {
                        spogliatoi_aiLavori++;
                    } else if (data.assigned && data.command.trim() !== '') {
                        spogliatoi_occupati++;
                    } else {
                        spogliatoi_liberi++;
                    }
                });
                
                // Spogliatoi
                generalRoomsHtml += `
                    <div class="room-item" style="border-left: 4px solid #3498db;">
                        <strong>SPOGLIATOI</strong><br>
                        <small>‚Ä¢ Spogliatoi liberi: ${spogliatoi_liberi}</small><br>
                        <small>‚Ä¢ Spogliatoi occupati: ${spogliatoi_occupati}</small><br>
                        <small>‚Ä¢ Spogliatoi non agibili: ${spogliatoi_nonAgibili}</small><br>
                        <small>‚Ä¢ Spogliatoi ai lavori: ${spogliatoi_aiLavori}</small><br>
                        <small style="color: #3498db;"><strong>Totale spogliatoi: ${allSpogliatoi.length}</strong></small>
                    </div>
                `;
                
                roomsContent.innerHTML = generalRoomsHtml;
                
                // Generate general comando summary for all floors + spogliatoi
                const allRooms = [...piano1Rooms, ...piano2Rooms, ...piano3Rooms];
                const comandoStats = getFloorComandoStats(allRooms);
                
                // Add spogliatoi to comando stats
                allSpogliatoi.forEach(spogliatoioNumber => {
                    const data = spogliatoioData[spogliatoioNumber];
                    if (!data.unavailable && !data.underWork && data.assigned && data.command.trim() !== '') {
                        const comando = data.command.trim();
                        if (!comandoStats[comando]) {
                            comandoStats[comando] = { letti: 0, stanze: 0, spogliatoi: 0, dettagliSpogliatoi: [] };
                        } else {
                            // Initialize spogliatoi properties if they don't exist
                            if (!comandoStats[comando].spogliatoi) {
                                comandoStats[comando].spogliatoi = 0;
                                comandoStats[comando].dettagliSpogliatoi = [];
                            }
                        }
                        comandoStats[comando].spogliatoi++;
                        comandoStats[comando].dettagliSpogliatoi.push(spogliatoioNumber);
                    }
                });
                
                let generalComandoHtml = '';
                
                Object.keys(comandoStats).forEach(comando => {
                    const stats = comandoStats[comando];
                    const hasSpogliatoi = stats.spogliatoi && stats.spogliatoi > 0;
                    
                    let descrizione = '';
                    if (stats.letti > 0 && hasSpogliatoi) {
                        descrizione = `${stats.letti} letti in ${stats.stanze} ${stats.stanze === 1 ? 'stanza' : 'stanze'} + ${stats.spogliatoi} ${stats.spogliatoi === 1 ? 'spogliatoio' : 'spogliatoi'}`;
                    } else if (stats.letti > 0) {
                        descrizione = `${stats.letti} letti in ${stats.stanze} ${stats.stanze === 1 ? 'stanza' : 'stanze'}`;
                    } else if (hasSpogliatoi) {
                        descrizione = `${stats.spogliatoi} ${stats.spogliatoi === 1 ? 'spogliatoio' : 'spogliatoi'}`;
                    }
                    
                    generalComandoHtml += `
                        <div class="comando-item">
                            <div class="comando-stats">
                                <div>
                                    <strong>${comando}</strong><br>
                                    <small>${descrizione}</small>
                                    ${hasSpogliatoi ? `<br><small style="color: #3498db;">Spogliatoi: ${stats.dettagliSpogliatoi.join(', ')}</small>` : ''}
                                </div>
                                <button class="details-btn" onclick="showComandoDetails('${comando}')">Dettagli</button>
                            </div>
                        </div>
                    `;
                });
                
                if (generalComandoHtml === '') {
                    generalComandoHtml = '<p style="color: rgba(255,255,255,0.6);">Nessun comando assegnato</p>';
                }
                
                comandoContent.innerHTML = generalComandoHtml;
                
            } else if (piano === 'piano2') {
                roomsTitle.textContent = 'Camere Piano Ammezzato';
                comandoTitle.textContent = 'Riepilogo per Comando';
                
                // Filter rooms by floor
                const floorRooms = getRoomsByFloor('piano2');
                
                // Show rooms summary
                let roomsHtml = '';
                floorRooms.forEach(roomNumber => {
                    const data = roomData[roomNumber];
                    const occupied = data.beds.filter(bed => bed.trim() !== '').length;
                    const roomType = getRoomTypeName(data.beds.length);
                    
                    roomsHtml += '<div class="room-item">';
                    if (data.unavailable) {
                        roomsHtml += `<strong>Camera ${roomNumber} (${roomType}):</strong> <span style="color: #e74c3c;">NON AGIBILE</span>`;
                    } else if (data.underWork) {
                        roomsHtml += `<strong>Camera ${roomNumber} (${roomType}):</strong> <span style="color: #8e44ad;">AI LAVORI</span>`;
                    } else if (occupied === 0) {
                        const totalBeds = data.beds.length;
                        const bedText = totalBeds === 1 ? 'letto' : 'letti';
                        roomsHtml += `<strong>Camera ${roomNumber} (${roomType}):</strong> <span style="color: #27ae60;">Libera (${totalBeds} ${bedText})</span>`;
                    } else if (occupied < data.beds.length) {
                        const freeBedsCount = data.beds.length - occupied;
                        const bedsText = freeBedsCount === 1 ? 'letto libero' : 'letti liberi';
                        roomsHtml += `<strong>Camera ${roomNumber} (${roomType}):</strong> <span style="color: #f39c12;">${freeBedsCount} ${bedsText}</span>`;
                    } else {
                        roomsHtml += `<strong>Camera ${roomNumber} (${roomType}):</strong> <span style="color: #e74c3c;">Completa</span>`;
                    }
                    
                    if (data.notes) {
                        roomsHtml += `<br><small>Note: ${data.notes}</small>`;
                    }
                    roomsHtml += '</div>';
                });
                
                if (roomsHtml === '') {
                    roomsHtml = '<p style="color: rgba(255,255,255,0.6);">Nessuna camera configurata per questo piano</p>';
                }
                
                roomsContent.innerHTML = roomsHtml;

                // Show comando summary for this floor
                const comandoStats = getFloorComandoStats(floorRooms);
                let comandoHtml = '';
                
                Object.keys(comandoStats).forEach(comando => {
                    const stats = comandoStats[comando];
                    comandoHtml += `
                        <div class="comando-item">
                            <div class="comando-stats">
                                <div>
                                    <strong>${comando}</strong><br>
                                    <small>${stats.letti} letti in ${stats.stanze} ${stats.stanze === 1 ? 'stanza' : 'stanze'}</small>
                                </div>
                                <button class="details-btn" onclick="showComandoDetails('${comando}')">Dettagli</button>
                            </div>
                        </div>
                    `;
                });
                
                if (comandoHtml === '') {
                    comandoHtml = '<p style="color: rgba(255,255,255,0.6);">Nessun comando assegnato</p>';
                }
                
                comandoContent.innerHTML = comandoHtml;
                
            } else if (piano === 'piano3') {
                roomsTitle.textContent = 'Camere Piano Secondo';
                comandoTitle.textContent = 'Riepilogo per Comando';
                
                // Filter rooms by floor
                const floorRooms = getRoomsByFloor('piano3');
                
                // Show rooms summary
                let roomsHtml = '';
                floorRooms.forEach(roomNumber => {
                    const data = roomData[roomNumber];
                    const occupied = data.beds.filter(bed => bed.trim() !== '').length;
                    const roomType = getRoomTypeName(data.beds.length);
                    
                    roomsHtml += '<div class="room-item">';
                    if (data.unavailable) {
                        roomsHtml += `<strong>Camera ${roomNumber} (${roomType}):</strong> <span style="color: #e74c3c;">NON AGIBILE</span>`;
                    } else if (data.underWork) {
                        roomsHtml += `<strong>Camera ${roomNumber} (${roomType}):</strong> <span style="color: #8e44ad;">AI LAVORI</span>`;
                    } else if (occupied === 0) {
                        const totalBeds = data.beds.length;
                        const bedText = totalBeds === 1 ? 'letto' : 'letti';
                        roomsHtml += `<strong>Camera ${roomNumber} (${roomType}):</strong> <span style="color: #27ae60;">Libera (${totalBeds} ${bedText})</span>`;
                    } else if (occupied < data.beds.length) {
                        const freeBedsCount = data.beds.length - occupied;
                        const bedsText = freeBedsCount === 1 ? 'letto libero' : 'letti liberi';
                        roomsHtml += `<strong>Camera ${roomNumber} (${roomType}):</strong> <span style="color: #f39c12;">${freeBedsCount} ${bedsText}</span>`;
                    } else {
                        roomsHtml += `<strong>Camera ${roomNumber} (${roomType}):</strong> <span style="color: #e74c3c;">Completa</span>`;
                    }
                    
                    if (data.notes) {
                        roomsHtml += `<br><small>Note: ${data.notes}</small>`;
                    }
                    roomsHtml += '</div>';
                });
                
                if (roomsHtml === '') {
                    roomsHtml = '<p style="color: rgba(255,255,255,0.6);">Nessuna camera configurata per questo piano</p>';
                }
                
                roomsContent.innerHTML = roomsHtml;

                // Show comando summary for this floor
                const comandoStats = getFloorComandoStats(floorRooms);
                let comandoHtml = '';
                
                Object.keys(comandoStats).forEach(comando => {
                    const stats = comandoStats[comando];
                    comandoHtml += `
                        <div class="comando-item">
                            <div class="comando-stats">
                                <div>
                                    <strong>${comando}</strong><br>
                                    <small>${stats.letti} letti in ${stats.stanze} ${stats.stanze === 1 ? 'stanza' : 'stanze'}</small>
                                </div>
                                <button class="details-btn" onclick="showComandoDetails('${comando}')">Dettagli</button>
                            </div>
                        </div>
                    `;
                });
                
                if (comandoHtml === '') {
                    comandoHtml = '<p style="color: rgba(255,255,255,0.6);">Nessun comando assegnato</p>';
                }
                
                comandoContent.innerHTML = comandoHtml;
                
            } else if (piano === 'spogliatoi') {
                roomsTitle.textContent = 'Spogliatoi';
                comandoTitle.textContent = 'Riepilogo per Comando';
                
                // Get all spogliatoi
                const allSpogliatoi = Object.keys(spogliatoioData);
                
                // Calculate statistics
                let liberi = 0;
                let occupati = 0;
                let nonAgibili = 0;
                let aiLavori = 0;
                
                // Show spogliatoi summary
                let spogliatoiHtml = '';
                allSpogliatoi.forEach(spogliatoioNumber => {
                    const data = spogliatoioData[spogliatoioNumber];
                    
                    spogliatoiHtml += '<div class="room-item">';
                    if (data.unavailable) {
                        spogliatoiHtml += `<strong>Spogliatoio ${spogliatoioNumber}:</strong> <span style="color: #e74c3c;">NON AGIBILE</span>`;
                        nonAgibili++;
                    } else if (data.underWork) {
                        spogliatoiHtml += `<strong>Spogliatoio ${spogliatoioNumber}:</strong> <span style="color: #8e44ad;">AI LAVORI</span>`;
                        aiLavori++;
                    } else if (data.assigned && data.command.trim() !== '') {
                        spogliatoiHtml += `<strong>Spogliatoio ${spogliatoioNumber}:</strong> <span style="color: #e74c3c;">Assegnato a ${data.command}</span>`;
                        occupati++;
                    } else {
                        spogliatoiHtml += `<strong>Spogliatoio ${spogliatoioNumber}:</strong> <span style="color: #27ae60;">Libero</span>`;
                        liberi++;
                    }
                    
                    if (data.notes) {
                        spogliatoiHtml += `<br><small>Note: ${data.notes}</small>`;
                    }
                    spogliatoiHtml += '</div>';
                });
                
                // Add summary header
                const summaryHtml = `
                    <div class="room-item" style="border-left: 4px solid #3498db; background: rgba(52, 152, 219, 0.1); margin-bottom: 20px;">
                        <strong>RIEPILOGO SPOGLIATOI</strong><br>
                        <small>‚Ä¢ Spogliatoi liberi: ${liberi}</small><br>
                        <small>‚Ä¢ Spogliatoi occupati: ${occupati}</small><br>
                        <small>‚Ä¢ Spogliatoi non agibili: ${nonAgibili}</small><br>
                        <small>‚Ä¢ Spogliatoi ai lavori: ${aiLavori}</small><br>
                        <small>‚Ä¢ <strong>Totale spogliatoi: ${allSpogliatoi.length}</strong></small>
                    </div>
                ` + spogliatoiHtml;
                
                roomsContent.innerHTML = summaryHtml;
                
                // Generate comando summary for spogliatoi
                const spogliatoiComandoStats = {};
                allSpogliatoi.forEach(spogliatoioNumber => {
                    const data = spogliatoioData[spogliatoioNumber];
                    if (!data.unavailable && !data.underWork && data.assigned && data.command.trim() !== '') {
                        const comando = data.command.trim();
                        if (!spogliatoiComandoStats[comando]) {
                            spogliatoiComandoStats[comando] = { spogliatoi: 0, dettagli: [] };
                        }
                        spogliatoiComandoStats[comando].spogliatoi++;
                        spogliatoiComandoStats[comando].dettagli.push(spogliatoioNumber);
                    }
                });
                
                let spogliatoiComandoHtml = '';
                Object.keys(spogliatoiComandoStats).forEach(comando => {
                    const stats = spogliatoiComandoStats[comando];
                    spogliatoiComandoHtml += `
                        <div class="comando-item">
                            <div class="comando-stats">
                                <div>
                                    <strong>${comando}</strong><br>
                                    <small>${stats.spogliatoi} ${stats.spogliatoi === 1 ? 'spogliatoio' : 'spogliatoi'}</small><br>
                                    <small style="color: #3498db;">${stats.dettagli.join(', ')}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                if (spogliatoiComandoHtml === '') {
                    spogliatoiComandoHtml = '<p style="color: rgba(255,255,255,0.6);">Nessun spogliatoio assegnato</p>';
                }
                
                comandoContent.innerHTML = spogliatoiComandoHtml;
            }
        }

        function calculateComandoStats() {
            const stats = {};
            
            Object.keys(roomData).forEach(roomNumber => {
                const data = roomData[roomNumber];
                if (!data.unavailable && !data.underWork) {
                    data.beds.forEach(bed => {
                        if (bed.trim() !== '') {
                            if (!stats[bed]) {
                                stats[bed] = { letti: 0, stanze: new Set() };
                            }
                            stats[bed].letti++;
                            stats[bed].stanze.add(roomNumber);
                        }
                    });
                }
            });
            
            // Convert Set to count
            Object.keys(stats).forEach(comando => {
                stats[comando].stanze = stats[comando].stanze.size;
            });
            
            return stats;
        }

        function showComandoDetails(comando) {
            const modal = document.getElementById('comandoModal');
            const title = document.getElementById('comando-modal-title');
            const content = document.getElementById('comando-modal-content');
            
            title.textContent = `Dettagli assegnazioni - ${comando}`;
            
            let detailsHtml = '';
            let totalLetti = 0;
            let totalStanze = 0;
            
            Object.keys(roomData).forEach(roomNumber => {
                const data = roomData[roomNumber];
                if (!data.unavailable && !data.underWork) {
                    const lettiComando = [];
                    data.beds.forEach((bed, index) => {
                        if (bed.trim() === comando) {
                            lettiComando.push(index + 1);
                        }
                    });
                    
                    if (lettiComando.length > 0) {
                        totalStanze++;
                        totalLetti += lettiComando.length;
                        const roomType = getRoomTypeName(data.beds.length);
                        detailsHtml += `
                            <div class="room-item">
                                <strong>Camera ${roomNumber}:</strong> Letto ${lettiComando.join(', ')}
                                <br><small>Piano Primo - Camera ${roomType}</small>
                            </div>
                        `;
                    }
                }
            });
            
            if (detailsHtml === '') {
                detailsHtml = '<p style="color: rgba(255,255,255,0.6);">Nessuna assegnazione trovata</p>';
            } else {
                detailsHtml = `
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(74, 144, 226, 0.2); border-radius: 8px;">
                        <strong>Riepilogo:</strong><br>
                        ‚Ä¢ ${totalLetti} letti occupati<br>
                        ‚Ä¢ ${totalStanze} ${totalStanze === 1 ? 'camera utilizzata' : 'camere utilizzate'}
                    </div>
                    ${detailsHtml}
                `;
            }
            
            content.innerHTML = detailsHtml;
            modal.style.display = 'block';
        }

        function closeComandoModal() {
            document.getElementById('comandoModal').style.display = 'none';
        }

        // Room management data storage with localStorage persistence
        function loadRoomData() {
            const savedData = localStorage.getItem('maristanav_room_data');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                // Check if old rooms exist (101-105) or new rooms are missing, if so, reset data to load new rooms
                const hasOldRooms = parsedData['101'] || parsedData['102'];
                const missingNewRooms = !parsedData['1-39'] || !parsedData['1-41'] || !parsedData['1-73'] || 
                                       !parsedData['A-63'] || !parsedData['A-79'] || !parsedData['A-80'] ||
                                       !parsedData['2-06'] || !parsedData['2-43'] || !parsedData['2-01'];
                
                if (hasOldRooms || missingNewRooms) {
                    console.log('Old room structure or missing new rooms detected, resetting to new structure...');
                    localStorage.removeItem('maristanav_room_data');
                    return getDefaultRoomData();
                }
                return parsedData;
            }
            return getDefaultRoomData();
        }

        function getDefaultRoomData() {
            return {
                // PIANO PRIMO - SINGOLE (1 letto)
                '1-02': { beds: [''], unavailable: false, underWork: false, notes: '' },
                '1-03': { beds: [''], unavailable: false, underWork: false, notes: '' },
                '1-04': { beds: [''], unavailable: false, underWork: false, notes: '' },
                '1-06': { beds: [''], unavailable: false, underWork: false, notes: '' },
                
                // PIANO PRIMO - DOPPIE (2 letti)
                '1-01': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-10': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-11': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-12': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-13': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-14': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-15': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-16': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-17': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-18': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-19': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-20': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-21': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-22': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-23': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-24': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-25': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-26': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-27': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-28': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-29': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-30': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-31': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-32': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-101': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-102': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-103': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-104': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-105': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-106': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-107': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-108': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-109': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '1-110': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                
                // PIANO PRIMO - TRIPLA (3 letti)
                '1-39': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                
                // PIANO PRIMO - QUADRUPLE (4 letti)
                '1-41': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '1-43': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '1-45': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '1-47': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '1-49': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '1-51': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '1-53': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '1-55': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '1-57': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '1-59': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '1-61': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '1-62': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '1-67': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '1-71': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '1-73': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                
                // PIANO AMMEZZATO - TRIPLE (3 letti)
                'A-63': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-65': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-67': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-69': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-71': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-73': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-75': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-77': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-83': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-85': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-86': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-87': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-89': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-91': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-93': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-95': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-97': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                
                // PIANO AMMEZZATO - QUADRUPLA (4 letti)
                'A-79': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                
                // PIANO AMMEZZATO - QUINTUPLE (5 letti)
                'A-80': { beds: ['', '', '', '', ''], unavailable: false, underWork: false, notes: '' },
                'A-81': { beds: ['', '', '', '', ''], unavailable: false, underWork: false, notes: '' },
                
                // PIANO SECONDO - SINGOLA (1 letto)
                '2-06': { beds: [''], unavailable: false, underWork: false, notes: '' },
                
                // PIANO SECONDO - DOPPIE (2 letti)
                '2-03': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-07': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-09': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-10': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-11': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-12': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-13': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-14': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-15': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-16': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-17': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-18': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-19': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-20': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-21': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-22': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-23': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-24': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-25': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-26': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-27': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-28': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-29': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-30': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-31': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-77': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-78': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-79': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-80': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-88': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-89': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-90': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-91': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-92': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-93': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-94': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-95': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-96': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-97': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-98': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-99': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-100': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-101': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-102': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-103': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-104': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-105': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-106': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-107': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-108': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-109': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                '2-110': { beds: ['', ''], unavailable: false, underWork: false, notes: '' },
                
                // PIANO SECONDO - TRIPLA (3 letti)
                '2-43': { beds: ['', '', ''], unavailable: false, underWork: false, notes: '' },
                
                // PIANO SECONDO - QUADRUPLE (4 letti)
                '2-01': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-08': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-45': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-47': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-49': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-51': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-52': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-53': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-55': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-57': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-58': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-59': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-60': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-62': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-64': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-65': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-67': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-69': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-71': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-73': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' },
                '2-75': { beds: ['', '', '', ''], unavailable: false, underWork: false, notes: '' }
            };
        }

        function saveRoomDataToStorage() {
            // Salva su IndexedDB e triggera auto-save
            if (window.piomartaManager && window.piomartaManager.isInitialized) {
                window.piomartaManager.saveToIndexedDB('roomData', roomData);
                window.piomartaManager.markAsChanged(); // Triggera auto-save FINALE 26 style
            } else {
                console.warn('‚ö†Ô∏è PiomartaManager non inizializzato, salvataggio ignorato');
            }
        }

        let roomData = loadRoomData();

        let currentModalRoom = null;
        let currentModalSpogliatoio = null;
        let currentModalLocale = null;

        // Spogliatoio data structure
        let spogliatoioData = loadSpogliatoioData();

        // Locali data structure
        let localiData = loadLocaliData();

        function loadSpogliatoioData() {
            const savedData = localStorage.getItem('maristanav_spogliatoio_data');
            if (savedData) {
                return JSON.parse(savedData);
            }
            return getDefaultSpogliatoioData();
        }

        function getDefaultSpogliatoioData() {
            return {
                'S 1-56': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'S 1-63': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'S 1-65': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'S 1-69': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'S 2-02': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'S 2-37': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'S 2-84': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'S 2-85': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'S 2-87': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} }
            };
        }

        function saveSpogliatoioDataToStorage() {
            // Salva su IndexedDB e triggera auto-save
            if (window.piomartaManager && window.piomartaManager.isInitialized) {
                window.piomartaManager.saveToIndexedDB('spogliatoioData', spogliatoioData);
                window.piomartaManager.markAsChanged(); // Triggera auto-save FINALE 26 style
            } else {
                console.warn('‚ö†Ô∏è PiomartaManager non inizializzato, salvataggio spogliatoi ignorato');
            }
        }

        function loadLocaliData() {
            const savedData = localStorage.getItem('maristanav_locali_data');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                // Merge with defaults to ensure new locali are added
                const defaultData = getDefaultLocaliData();
                
                // Add any missing locali from defaults
                Object.keys(defaultData).forEach(locale => {
                    if (!parsedData[locale]) {
                        parsedData[locale] = defaultData[locale];
                    }
                });
                
                // Save the updated data back to localStorage
                localStorage.setItem('maristanav_locali_data', JSON.stringify(parsedData));
                
                return parsedData;
            }
            return getDefaultLocaliData();
        }

        function getDefaultLocaliData() {
            return {
                // SEGRETERIE
                'L 1-07': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-08': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-09': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-33': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                // UFFICI
                'L A-61': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-34': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-37': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-90': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-91': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-92': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-93': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-94': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-95': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-96': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-97': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-98': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-99': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-100': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L A-101': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                // CLASSIFICATI
                'L A106-1': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L A106-2': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L A106-3': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L A106-4': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                // CASSE DI RISERVA
                'L A108-1': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L A108-2': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L A108-3': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                // MAGAZZINI
                'L 1-80': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-86': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 1-87': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 2-32': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 2-34': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 2-41': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 2-82': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} },
                'L 2-83': { assigned: false, command: '', unavailable: false, underWork: false, notes: '', furniture: {} }
            };
        }

        function saveLocaliDataToStorage() {
            // Salva su IndexedDB e triggera auto-save
            if (window.piomartaManager && window.piomartaManager.isInitialized) {
                window.piomartaManager.saveToIndexedDB('localiData', localiData);
                window.piomartaManager.markAsChanged(); // Triggera auto-save FINALE 26 style
            } else {
                console.warn('‚ö†Ô∏è PiomartaManager non inizializzato, salvataggio locali ignorato');
            }
        }

        function generateBedAssignmentFields(beds) {
            const bedAssignmentsDiv = document.getElementById('bed-assignments');
            let bedFieldsHtml = '';
            
            beds.forEach((bed, index) => {
                const bedNumber = index + 1;
                bedFieldsHtml += `
                    <div class="bed-assignment">
                        <label for="bed${bedNumber}">Letto ${bedNumber} - COMANDO:</label>
                        <input type="text" id="bed${bedNumber}" placeholder="Inserisci nome comando">
                    </div>
                `;
            });
            
            bedAssignmentsDiv.innerHTML = bedFieldsHtml;
        }

        function getCurrentBedInputs() {
            if (!currentModalRoom || !roomData[currentModalRoom]) return [];
            const bedCount = roomData[currentModalRoom].beds.length;
            const bedInputs = [];
            for (let i = 1; i <= bedCount; i++) {
                bedInputs.push(`bed${i}`);
            }
            return bedInputs;
        }

        function openRoomModal(roomNumber) {
            // Check authentication for room modifications
            if (!requireAuthentication()) {
                return;
            }
            
            currentModalRoom = roomNumber;
            const modal = document.getElementById('roomModal');
            const title = document.getElementById('modal-room-title');
            
            // Load existing data
            const data = roomData[roomNumber];
            const bedCount = data.beds.length;
            const roomTypeName = getRoomTypeName(bedCount);
            
            title.textContent = `Camera ${roomNumber} - Piano Primo ${roomTypeName}`;
            
            // Generate dynamic bed assignment fields
            generateBedAssignmentFields(data.beds);
            
            // Set bed values
            data.beds.forEach((bed, index) => {
                const bedInput = document.getElementById(`bed${index + 1}`);
                if (bedInput) {
                    bedInput.value = bed;
                }
            });
            document.getElementById('room-unavailable').checked = data.unavailable;
            document.getElementById('room-under-work').checked = data.underWork || false;
            document.getElementById('room-notes').value = data.notes;
            
            // Check if all beds have the same command (full room assignment)
            const uniqueCommands = [...new Set(data.beds.filter(bed => bed.trim() !== ''))];
            const isFullRoomAssignment = uniqueCommands.length === 1 && data.beds.every(bed => bed === uniqueCommands[0]);
            
            document.getElementById('full-room-assignment').checked = isFullRoomAssignment;
            document.getElementById('full-room-command').value = isFullRoomAssignment ? uniqueCommands[0] : '';
            
            // Initialize field states
            if (isFullRoomAssignment) {
                document.getElementById('full-room-command').disabled = false;
                document.getElementById('full-room-command').style.opacity = '1';
            } else {
                document.getElementById('full-room-command').disabled = true;
                document.getElementById('full-room-command').style.opacity = '0.5';
            }
            
            // Update field states
            toggleRoomAvailability();
            if (isFullRoomAssignment) {
                toggleFullRoomAssignment();
            }
            
            modal.style.display = 'block';
        }

        function closeRoomModal() {
            document.getElementById('roomModal').style.display = 'none';
            currentModalRoom = null;
        }

        function openSpogliatoioModal(spogliatoioNumber) {
            currentModalSpogliatoio = spogliatoioNumber;
            const modal = document.getElementById('spogliatoioModal');
            const title = document.getElementById('modal-spogliatoio-title');
            
            // Load existing data
            const data = spogliatoioData[spogliatoioNumber];
            
            title.textContent = `Spogliatoio ${spogliatoioNumber}`;
            
            // Load form fields
            document.getElementById('spogliatoio-assignment').checked = data.assigned || false;
            document.getElementById('spogliatoio-command').value = data.command || '';
            document.getElementById('spogliatoio-unavailable').checked = data.unavailable || false;
            document.getElementById('spogliatoio-under-work').checked = data.underWork || false;
            document.getElementById('spogliatoio-notes').value = data.notes || '';
            
            // Update field states
            toggleSpogliatoioAvailability();
            if (data.assigned) {
                toggleSpogliatoioAssignment();
            }
            
            modal.style.display = 'block';
        }

        function closeSpogliatoioModal() {
            document.getElementById('spogliatoioModal').style.display = 'none';
            currentModalSpogliatoio = null;
        }

        function toggleSpogliatoioAssignment() {
            const checkbox = document.getElementById('spogliatoio-assignment');
            const commandInput = document.getElementById('spogliatoio-command');
            
            commandInput.disabled = !checkbox.checked;
            commandInput.style.opacity = checkbox.checked ? '1' : '0.5';
            
            if (!checkbox.checked) {
                commandInput.value = '';
            }
        }

        function toggleSpogliatoioAvailability() {
            const unavailableCheckbox = document.getElementById('spogliatoio-unavailable');
            const underWorkCheckbox = document.getElementById('spogliatoio-under-work');
            const assignmentCheckbox = document.getElementById('spogliatoio-assignment');
            const commandInput = document.getElementById('spogliatoio-command');
            
            if (unavailableCheckbox.checked) {
                // Se NON AGIBILE, disattiva tutte le altre opzioni
                underWorkCheckbox.checked = false;
                underWorkCheckbox.disabled = true;
                assignmentCheckbox.checked = false;
                assignmentCheckbox.disabled = true;
                commandInput.disabled = true;
                commandInput.value = '';
                commandInput.style.opacity = '0.5';
            } else {
                // Se non √® NON AGIBILE, riabilita le altre opzioni
                underWorkCheckbox.disabled = false;
                assignmentCheckbox.disabled = false;
                
                // Solo se non √® AI LAVORI, abilita l'assegnazione
                if (!underWorkCheckbox.checked) {
                    toggleSpogliatoioAssignment();
                }
            }
        }

        function toggleSpogliatoioUnderWork() {
            const underWorkCheckbox = document.getElementById('spogliatoio-under-work');
            const unavailableCheckbox = document.getElementById('spogliatoio-unavailable');
            const assignmentCheckbox = document.getElementById('spogliatoio-assignment');
            const commandInput = document.getElementById('spogliatoio-command');
            
            if (underWorkCheckbox.checked) {
                // Se AI LAVORI, disattiva l'assegnazione ma permette NON AGIBILE
                assignmentCheckbox.checked = false;
                assignmentCheckbox.disabled = true;
                commandInput.disabled = true;
                commandInput.value = '';
                commandInput.style.opacity = '0.5';
            } else {
                // Se non √® AI LAVORI, riabilita l'assegnazione solo se non √® NON AGIBILE
                if (!unavailableCheckbox.checked) {
                    assignmentCheckbox.disabled = false;
                    toggleSpogliatoioAssignment();
                }
            }
        }

        function saveSpogliatoioData() {
            if (!currentModalSpogliatoio) return;
            
            const data = spogliatoioData[currentModalSpogliatoio];
            
            data.assigned = document.getElementById('spogliatoio-assignment').checked;
            data.command = document.getElementById('spogliatoio-command').value;
            data.unavailable = document.getElementById('spogliatoio-unavailable').checked;
            data.underWork = document.getElementById('spogliatoio-under-work').checked;
            data.notes = document.getElementById('spogliatoio-notes').value;
            
            // Save to localStorage
            saveSpogliatoioDataToStorage();
            
            updateSpogliatoioStatus(currentModalSpogliatoio);
            closeSpogliatoioModal();
        }

        function resetSpogliatoioForm() {
            if (!currentModalSpogliatoio) return;
            
            document.getElementById('spogliatoio-assignment').checked = false;
            document.getElementById('spogliatoio-command').value = '';
            document.getElementById('spogliatoio-unavailable').checked = false;
            document.getElementById('spogliatoio-under-work').checked = false;
            document.getElementById('spogliatoio-notes').value = '';
            
            toggleSpogliatoioAvailability();
        }

        function updateSpogliatoioStatus(spogliatoioNumber) {
            const data = spogliatoioData[spogliatoioNumber];
            const statusId = spogliatoioNumber.replace(/\s/g, '-');
            
            // Update all status indicators for this spogliatoio
            const statusIndicators = document.querySelectorAll(`#status-${statusId}`);
            const spogliatoioButtons = document.querySelectorAll(`[onclick="openSpogliatoioModal('${spogliatoioNumber}')"]`);
            
            // Handle spogliatoio buttons (add/remove unavailable class)
            spogliatoioButtons.forEach(button => {
                if (data.unavailable) {
                    button.classList.add('room-unavailable');
                } else {
                    button.classList.remove('room-unavailable');
                }
            });
            
            // Update status indicators
            statusIndicators.forEach(indicator => {
                // Remove all status classes
                indicator.className = 'status-indicator';
                
                if (data.unavailable) {
                    // No indicator for unavailable spogliatoi (hidden by CSS)
                    return;
                } else if (data.underWork) {
                    indicator.classList.add('status-purple');
                } else if (data.assigned && data.command.trim() !== '') {
                    indicator.classList.add('status-red');
                } else {
                    indicator.classList.add('status-green');
                }
            });
        }

        // Initialize spogliatoio status indicators on page load
        function initializeSpogliatoioStatus() {
            Object.keys(spogliatoioData).forEach(spogliatoioNumber => {
                updateSpogliatoioStatus(spogliatoioNumber);
            });
        }

        function openLocaleModal(localeNumber) {
            currentModalLocale = localeNumber;
            const modal = document.getElementById('localeModal');
            const title = document.getElementById('modal-locale-title');
            
            // Load existing data
            const data = localiData[localeNumber];
            
            title.textContent = `Locale ${localeNumber}`;
            
            // Load form fields
            document.getElementById('locale-assignment').checked = data.assigned || false;
            document.getElementById('locale-command').value = data.command || '';
            document.getElementById('locale-unavailable').checked = data.unavailable || false;
            document.getElementById('locale-under-work').checked = data.underWork || false;
            document.getElementById('locale-notes').value = data.notes || '';
            
            // Update field states
            toggleLocaleAvailability();
            if (data.assigned) {
                toggleLocaleAssignment();
            }
            
            modal.style.display = 'block';
        }

        function closeLocaleModal() {
            document.getElementById('localeModal').style.display = 'none';
            currentModalLocale = null;
        }

        function toggleLocaleAssignment() {
            const checkbox = document.getElementById('locale-assignment');
            const commandInput = document.getElementById('locale-command');
            
            commandInput.disabled = !checkbox.checked;
            commandInput.style.opacity = checkbox.checked ? '1' : '0.5';
            
            if (!checkbox.checked) {
                commandInput.value = '';
            }
        }

        function toggleLocaleAvailability() {
            const unavailableCheckbox = document.getElementById('locale-unavailable');
            const underWorkCheckbox = document.getElementById('locale-under-work');
            const assignmentCheckbox = document.getElementById('locale-assignment');
            const commandInput = document.getElementById('locale-command');
            
            if (unavailableCheckbox.checked) {
                // Se NON AGIBILE, disattiva tutte le altre opzioni
                underWorkCheckbox.checked = false;
                underWorkCheckbox.disabled = true;
                assignmentCheckbox.checked = false;
                assignmentCheckbox.disabled = true;
                commandInput.disabled = true;
                commandInput.value = '';
                commandInput.style.opacity = '0.5';
            } else {
                // Se non √® NON AGIBILE, riabilita le altre opzioni
                underWorkCheckbox.disabled = false;
                assignmentCheckbox.disabled = false;
                
                // Solo se non √® AI LAVORI, abilita l'assegnazione
                if (!underWorkCheckbox.checked) {
                    toggleLocaleAssignment();
                }
            }
        }

        function toggleLocaleUnderWork() {
            const underWorkCheckbox = document.getElementById('locale-under-work');
            const unavailableCheckbox = document.getElementById('locale-unavailable');
            const assignmentCheckbox = document.getElementById('locale-assignment');
            const commandInput = document.getElementById('locale-command');
            
            if (underWorkCheckbox.checked) {
                // Se AI LAVORI, disattiva l'assegnazione ma permette NON AGIBILE
                assignmentCheckbox.checked = false;
                assignmentCheckbox.disabled = true;
                commandInput.disabled = true;
                commandInput.value = '';
                commandInput.style.opacity = '0.5';
            } else {
                // Se non √® AI LAVORI, riabilita l'assegnazione solo se non √® NON AGIBILE
                if (!unavailableCheckbox.checked) {
                    assignmentCheckbox.disabled = false;
                    toggleLocaleAssignment();
                }
            }
        }

        function saveLocaleData() {
            if (!currentModalLocale) return;
            
            const data = localiData[currentModalLocale];
            
            data.assigned = document.getElementById('locale-assignment').checked;
            data.command = document.getElementById('locale-command').value;
            data.unavailable = document.getElementById('locale-unavailable').checked;
            data.underWork = document.getElementById('locale-under-work').checked;
            data.notes = document.getElementById('locale-notes').value;
            
            // Save to localStorage
            saveLocaliDataToStorage();
            
            updateLocaleStatus(currentModalLocale);
            closeLocaleModal();
        }

        function resetLocaleForm() {
            if (!currentModalLocale) return;
            
            document.getElementById('locale-assignment').checked = false;
            document.getElementById('locale-command').value = '';
            document.getElementById('locale-unavailable').checked = false;
            document.getElementById('locale-under-work').checked = false;
            document.getElementById('locale-notes').value = '';
            
            toggleLocaleAvailability();
        }

        function updateLocaleStatus(localeNumber) {
            const data = localiData[localeNumber];
            const statusId = localeNumber.replace(/\s/g, '-').replace(/\//g, '-');
            
            // Update all status indicators for this locale
            const statusIndicators = document.querySelectorAll(`#status-${statusId}`);
            const localeButtons = document.querySelectorAll(`[onclick="openLocaleModal('${localeNumber}')"]`);
            
            // Handle locale buttons (add/remove unavailable class)
            localeButtons.forEach(button => {
                if (data.unavailable) {
                    button.classList.add('room-unavailable');
                } else {
                    button.classList.remove('room-unavailable');
                }
            });
            
            // Update status indicators
            statusIndicators.forEach(indicator => {
                // Remove all status classes
                indicator.className = 'status-indicator';
                
                if (data.unavailable) {
                    // No indicator for unavailable locali (hidden by CSS)
                    return;
                } else if (data.underWork) {
                    indicator.classList.add('status-purple');
                } else if (data.assigned && data.command.trim() !== '') {
                    indicator.classList.add('status-red');
                } else {
                    indicator.classList.add('status-green');
                }
            });
        }

        // Initialize locale status indicators on page load
        function initializeLocaleStatus() {
            Object.keys(localiData).forEach(localeNumber => {
                updateLocaleStatus(localeNumber);
            });
        }

        function openLocaleArrediModal() {
            if (!currentModalLocale) return;
            
            const localeArrediModal = document.getElementById('localeArrediModal');
            const title = document.getElementById('locale-arredi-title');
            
            title.textContent = `Arredi - Locale ${currentModalLocale}`;
            
            // Load existing furniture data if any
            loadLocaleArrediData(currentModalLocale);
            
            localeArrediModal.style.display = 'block';
        }

        function closeLocaleArrediModal() {
            document.getElementById('localeArrediModal').style.display = 'none';
        }

        function toggleLocaleArredoInput(arredoType) {
            const checkbox = document.getElementById(`loc-arredo-${arredoType}`);
            const quantityInput = document.getElementById(`loc-qty-${arredoType}`);
            
            if (checkbox.checked) {
                quantityInput.disabled = false;
                quantityInput.style.opacity = '1';
            } else {
                quantityInput.disabled = true;
                quantityInput.style.opacity = '0.6';
            }
        }

        function saveLocaleArrediData() {
            if (!currentModalLocale) return;
            
            // Initialize furniture data structure if it doesn't exist
            if (!localiData[currentModalLocale].furniture) {
                localiData[currentModalLocale].furniture = {};
            }
            
            // List of all locale furniture types
            const furnitureTypes = [
                'scrivanie', 'sedie', 'armadi', 'scaffali', 'cassettiere', 'tavoli', 'computer'
            ];
            
            furnitureTypes.forEach(type => {
                const checkbox = document.getElementById(`loc-arredo-${type}`);
                const quantityInput = document.getElementById(`loc-qty-${type}`);
                
                if (checkbox.checked && !quantityInput.disabled) {
                    localiData[currentModalLocale].furniture[type] = parseInt(quantityInput.value) || 1;
                } else {
                    delete localiData[currentModalLocale].furniture[type];
                }
            });
            
            // Save to localStorage
            saveLocaliDataToStorage();
            
            // Close modal
            closeLocaleArrediModal();
            
            alert(`‚úÖ Arredi del Locale ${currentModalLocale} salvati con successo!`);
        }

        function loadLocaleArrediData(localeNumber) {
            const furnitureData = localiData[localeNumber].furniture || {};
            
            // List of all locale furniture types
            const furnitureTypes = [
                'scrivanie', 'sedie', 'armadi', 'scaffali', 'cassettiere', 'tavoli', 'computer'
            ];
            
            furnitureTypes.forEach(type => {
                const checkbox = document.getElementById(`loc-arredo-${type}`);
                const quantityInput = document.getElementById(`loc-qty-${type}`);
                
                if (furnitureData[type] !== undefined) {
                    checkbox.checked = true;
                    quantityInput.value = furnitureData[type];
                    quantityInput.disabled = false;
                    quantityInput.style.opacity = '1';
                } else {
                    checkbox.checked = false;
                    quantityInput.disabled = true;
                    quantityInput.style.opacity = '0.6';
                }
            });
        }

        function openSpogliatoioArrediModal() {
            if (!currentModalSpogliatoio) return;
            
            const spogliatoioArrediModal = document.getElementById('spogliatoioArrediModal');
            const title = document.getElementById('spogliatoio-arredi-title');
            
            title.textContent = `Arredi - Spogliatoio ${currentModalSpogliatoio}`;
            
            // Load existing furniture data if any
            loadSpogliatoioArrediData(currentModalSpogliatoio);
            
            spogliatoioArrediModal.style.display = 'block';
        }

        function closeSpogliatoioArrediModal() {
            document.getElementById('spogliatoioArrediModal').style.display = 'none';
        }

        function toggleSpogliatoioArredoInput(arredoType) {
            const checkbox = document.getElementById(`spog-arredo-${arredoType}`);
            const quantityInput = document.getElementById(`spog-qty-${arredoType}`);
            
            if (checkbox.checked) {
                quantityInput.disabled = false;
                quantityInput.style.opacity = '1';
            } else {
                quantityInput.disabled = true;
                quantityInput.style.opacity = '0.6';
            }
        }

        function saveSpogliatoioArrediData() {
            if (!currentModalSpogliatoio) return;
            
            // Initialize furniture data structure if it doesn't exist
            if (!spogliatoioData[currentModalSpogliatoio].furniture) {
                spogliatoioData[currentModalSpogliatoio].furniture = {};
            }
            
            // List of all spogliatoio furniture types
            const furnitureTypes = [
                'scarpiera', 'comodini', 'armadi', 'sedie', 'specchi', 'attaccapanni', 'panche'
            ];
            
            furnitureTypes.forEach(type => {
                const checkbox = document.getElementById(`spog-arredo-${type}`);
                const quantityInput = document.getElementById(`spog-qty-${type}`);
                
                if (checkbox.checked && !quantityInput.disabled) {
                    spogliatoioData[currentModalSpogliatoio].furniture[type] = parseInt(quantityInput.value) || 1;
                } else {
                    delete spogliatoioData[currentModalSpogliatoio].furniture[type];
                }
            });
            
            // Save to localStorage
            saveSpogliatoioDataToStorage();
            
            // Close modal
            closeSpogliatoioArrediModal();
            
            alert(`‚úÖ Arredi dello Spogliatoio ${currentModalSpogliatoio} salvati con successo!`);
        }

        function loadSpogliatoioArrediData(spogliatoioNumber) {
            const furnitureData = spogliatoioData[spogliatoioNumber].furniture || {};
            
            // List of all spogliatoio furniture types
            const furnitureTypes = [
                'scarpiera', 'comodini', 'armadi', 'sedie', 'specchi', 'attaccapanni', 'panche'
            ];
            
            furnitureTypes.forEach(type => {
                const checkbox = document.getElementById(`spog-arredo-${type}`);
                const quantityInput = document.getElementById(`spog-qty-${type}`);
                
                if (furnitureData[type] !== undefined) {
                    checkbox.checked = true;
                    quantityInput.value = furnitureData[type];
                    quantityInput.disabled = false;
                    quantityInput.style.opacity = '1';
                } else {
                    checkbox.checked = false;
                    quantityInput.disabled = true;
                    quantityInput.style.opacity = '0.6';
                }
            });
        }

        function openArrediModal() {
            if (!currentModalRoom) return;
            
            const arrediModal = document.getElementById('arrediModal');
            const title = document.getElementById('arredi-room-title');
            
            title.textContent = `Arredi - Camera ${currentModalRoom}`;
            
            // Load existing furniture data if any
            loadArrediData(currentModalRoom);
            
            arrediModal.style.display = 'block';
        }

        function closeArrediModal() {
            document.getElementById('arrediModal').style.display = 'none';
        }

        function toggleArredoInput(arredoType) {
            const checkbox = document.getElementById(`arredo-${arredoType}`);
            const quantityInput = document.getElementById(`qty-${arredoType}`);
            
            if (checkbox.checked) {
                quantityInput.disabled = false;
                quantityInput.style.opacity = '1';
            } else {
                quantityInput.disabled = true;
                quantityInput.style.opacity = '0.6';
            }
        }

        function saveArrediData() {
            if (!currentModalRoom) return;
            
            // Initialize furniture data structure if it doesn't exist
            if (!roomData[currentModalRoom].furniture) {
                roomData[currentModalRoom].furniture = {};
            }
            
            // List of all furniture types
            const furnitureTypes = [
                'scarpiera', 'comodini', 'armadi', 'scrivanie', 'sedie', 
                'bollitore', 'macchinacaffe', 'televisione', 'ventilatore', 
                'climatizzatore', 'appendiabiti', 'bagno'
            ];
            
            // Save furniture data
            furnitureTypes.forEach(type => {
                const checkbox = document.getElementById(`arredo-${type}`);
                const quantityInput = document.getElementById(`qty-${type}`);
                
                if (checkbox.checked && !quantityInput.disabled) {
                    roomData[currentModalRoom].furniture[type] = parseInt(quantityInput.value) || 1;
                } else {
                    delete roomData[currentModalRoom].furniture[type];
                }
            });
            
            // Save to localStorage
            saveRoomDataToStorage();
            
            // Close modal
            closeArrediModal();
            
            // If user is currently viewing a room type view, refresh it to show bathroom emoji
            const triplaRoomsView = document.getElementById('tripla-rooms-view');
            if (triplaRoomsView && triplaRoomsView.classList.contains('active')) {
                // Refresh the current view with the same floor and room type
                if (currentFloor && currentRoom) {
                    generateDynamicRoomView(currentFloor, currentRoom);
                }
            }
            
            alert(`‚úÖ Arredi della Camera ${currentModalRoom} salvati con successo!`);
        }

        function loadArrediData(roomNumber) {
            const furnitureData = roomData[roomNumber].furniture || {};
            
            // List of all furniture types
            const furnitureTypes = [
                'scarpiera', 'comodini', 'armadi', 'scrivanie', 'sedie', 
                'bollitore', 'macchinacaffe', 'televisione', 'ventilatore', 
                'climatizzatore', 'appendiabiti', 'bagno'
            ];
            
            // Load existing data
            furnitureTypes.forEach(type => {
                const checkbox = document.getElementById(`arredo-${type}`);
                const quantityInput = document.getElementById(`qty-${type}`);
                
                if (furnitureData[type] !== undefined) {
                    checkbox.checked = true;
                    quantityInput.value = furnitureData[type];
                    quantityInput.disabled = false;
                    quantityInput.style.opacity = '1';
                } else {
                    checkbox.checked = false;
                    quantityInput.disabled = true;
                    quantityInput.style.opacity = '0.6';
                }
            });
        }

        function toggleRoomAvailability() {
            const unavailableCheckbox = document.getElementById('room-unavailable');
            const underWorkCheckbox = document.getElementById('room-under-work');
            const fullRoomCheckbox = document.getElementById('full-room-assignment');
            const fullRoomCommandInput = document.getElementById('full-room-command');
            const bedInputs = getCurrentBedInputs();
            
            // If room is unavailable, disable all other options and bed inputs
            if (unavailableCheckbox.checked) {
                underWorkCheckbox.checked = false;
                underWorkCheckbox.disabled = true;
                fullRoomCheckbox.checked = false;
                fullRoomCheckbox.disabled = true;
                fullRoomCommandInput.disabled = true;
                fullRoomCommandInput.style.opacity = '0.5';
                fullRoomCommandInput.value = '';
                
                bedInputs.forEach(id => {
                    const input = document.getElementById(id);
                    input.disabled = true;
                    input.style.opacity = '0.5';
                    input.value = ''; // Clear bed assignments
                });
            } else {
                underWorkCheckbox.disabled = false;
                fullRoomCheckbox.disabled = false;
                
                // Only enable bed inputs if not under work and not full room assignment
                if (!underWorkCheckbox.checked && !fullRoomCheckbox.checked) {
                    bedInputs.forEach(id => {
                        const input = document.getElementById(id);
                        input.disabled = false;
                        input.style.opacity = '1';
                    });
                } else if (underWorkCheckbox.checked) {
                    // If under work, keep bed inputs disabled
                    bedInputs.forEach(id => {
                        const input = document.getElementById(id);
                        input.disabled = true;
                        input.style.opacity = '0.5';
                    });
                } else if (fullRoomCheckbox.checked) {
                    // If full room assignment, keep bed inputs disabled
                    bedInputs.forEach(id => {
                        const input = document.getElementById(id);
                        input.disabled = true;
                        input.style.opacity = '0.5';
                    });
                }
            }
        }

        function toggleRoomUnderWork() {
            const underWorkCheckbox = document.getElementById('room-under-work');
            const fullRoomCheckbox = document.getElementById('full-room-assignment');
            const fullRoomCommandInput = document.getElementById('full-room-command');
            const bedInputs = getCurrentBedInputs();
            
            if (underWorkCheckbox.checked) {
                // Disable full room assignment and bed inputs
                fullRoomCheckbox.checked = false;
                fullRoomCheckbox.disabled = true;
                fullRoomCommandInput.disabled = true;
                fullRoomCommandInput.style.opacity = '0.5';
                fullRoomCommandInput.value = '';
                
                bedInputs.forEach(id => {
                    const input = document.getElementById(id);
                    input.disabled = true;
                    input.style.opacity = '0.5';
                    input.value = ''; // Clear bed assignments
                });
            } else {
                fullRoomCheckbox.disabled = false;
                
                // Only enable bed inputs if not full room assignment
                if (!fullRoomCheckbox.checked) {
                    bedInputs.forEach(id => {
                        const input = document.getElementById(id);
                        input.disabled = false;
                        input.style.opacity = '1';
                    });
                }
            }
        }

        function toggleFullRoomAssignment() {
            const fullRoomCheckbox = document.getElementById('full-room-assignment');
            const fullRoomCommandInput = document.getElementById('full-room-command');
            const bedInputs = getCurrentBedInputs();
            const unavailableCheckbox = document.getElementById('room-unavailable');
            const underWorkCheckbox = document.getElementById('room-under-work');
            
            if (fullRoomCheckbox.checked) {
                // Enable the command input
                fullRoomCommandInput.disabled = false;
                fullRoomCommandInput.style.opacity = '1';
                
                // Disable other options
                unavailableCheckbox.checked = false;
                underWorkCheckbox.checked = false;
                unavailableCheckbox.disabled = true;
                underWorkCheckbox.disabled = true;
                
                // Disable individual bed inputs
                bedInputs.forEach(id => {
                    const input = document.getElementById(id);
                    input.disabled = true;
                    input.style.opacity = '0.5';
                });
                
                // Auto-assign beds when command is entered
                fullRoomCommandInput.addEventListener('input', function() {
                    const command = this.value;
                    bedInputs.forEach(id => {
                        document.getElementById(id).value = command;
                    });
                });
                
            } else {
                // Disable the command input
                fullRoomCommandInput.disabled = true;
                fullRoomCommandInput.style.opacity = '0.5';
                fullRoomCommandInput.value = '';
                
                // Enable other options
                unavailableCheckbox.disabled = false;
                underWorkCheckbox.disabled = false;
                
                // Enable individual bed inputs if room is not unavailable or under work
                if (!unavailableCheckbox.checked && !underWorkCheckbox.checked) {
                    bedInputs.forEach(id => {
                        const input = document.getElementById(id);
                        input.disabled = false;
                        input.style.opacity = '1';
                    });
                }
                
                // Clear bed assignments
                bedInputs.forEach(id => {
                    document.getElementById(id).value = '';
                });
            }
        }

        function resetRoomForm() {
            if (!currentModalRoom) return;
            
            // Clear all form fields
            document.getElementById('bed1').value = '';
            document.getElementById('bed2').value = '';
            document.getElementById('bed3').value = '';
            document.getElementById('full-room-assignment').checked = false;
            document.getElementById('full-room-command').value = '';
            document.getElementById('room-unavailable').checked = false;
            document.getElementById('room-under-work').checked = false;
            document.getElementById('room-notes').value = '';
            
            // Reset field states
            document.getElementById('full-room-command').disabled = true;
            document.getElementById('full-room-command').style.opacity = '0.5';
            document.getElementById('room-unavailable').disabled = false;
            document.getElementById('room-under-work').disabled = false;
            
            const bedInputs = getCurrentBedInputs();
            bedInputs.forEach(id => {
                const input = document.getElementById(id);
                input.disabled = false;
                input.style.opacity = '1';
            });
        }

        function saveRoomData() {
            if (!currentModalRoom) return;
            if (!requireAuthentication()) return;
            
            const data = roomData[currentModalRoom];
            
            // Save bed assignments dynamically
            data.beds.forEach((bed, index) => {
                const bedInput = document.getElementById(`bed${index + 1}`);
                if (bedInput) {
                    data.beds[index] = bedInput.value;
                }
            });
            
            data.unavailable = document.getElementById('room-unavailable').checked;
            data.underWork = document.getElementById('room-under-work').checked;
            data.notes = document.getElementById('room-notes').value;
            
            // Save to localStorage
            saveRoomDataToStorage();
            
            updateRoomStatus(currentModalRoom);
            closeRoomModal();
        }

        function updateRoomStatus(roomNumber) {
            const data = roomData[roomNumber];
            
            // Update all status indicators and room buttons for this room
            const statusIndicators = document.querySelectorAll(`#status-${roomNumber}`);
            const roomButtons = document.querySelectorAll(`[onclick="openRoomModal('${roomNumber}')"]`);
            
            // Handle room buttons (add/remove unavailable class)
            roomButtons.forEach(button => {
                if (data.unavailable) {
                    button.classList.add('room-unavailable');
                } else {
                    button.classList.remove('room-unavailable');
                }
            });
            
            statusIndicators.forEach(statusIndicator => {
                // Remove all status classes
                statusIndicator.classList.remove('status-green', 'status-yellow', 'status-red', 'status-purple');
                
                if (data.unavailable) {
                    // No indicator for unavailable rooms (hidden by CSS)
                    return;
                } else if (data.underWork) {
                    statusIndicator.classList.add('status-purple');
                } else {
                    const occupiedBeds = data.beds.filter(bed => bed.trim() !== '').length;
                    const totalBeds = data.beds.length;
                    
                    if (occupiedBeds === 0) {
                        statusIndicator.classList.add('status-green');
                    } else if (occupiedBeds < totalBeds) {
                        statusIndicator.classList.add('status-yellow');
                    } else {
                        statusIndicator.classList.add('status-red');
                    }
                }
            });
        }

        // Initialize room status indicators on page load
        function initializeRoomStatus() {
            Object.keys(roomData).forEach(roomNumber => {
                updateRoomStatus(roomNumber);
            });
        }

        function initializeAutoSave() {
            // This function will be called when the ESPORTA tab is shown
            // Check if the checkbox exists before trying to access it
            const autoSaveCheckbox = document.getElementById('auto-save-enabled');
            const autoSaveStatus = document.getElementById('autoSaveStatus');
            
            if (autoSaveCheckbox) {
                const autoSaveEnabled = localStorage.getItem('piomarta_auto_save_enabled') === 'true';
                autoSaveCheckbox.checked = autoSaveEnabled;
                
                // Aggiorna anche l'indicatore di stato nell'header
                if (autoSaveStatus) {
                    if (autoSaveEnabled) {
                        autoSaveStatus.textContent = 'AUTO-SAVE ATTIVO';
                        autoSaveStatus.classList.remove('auto-save-inactive');
                        autoSaveStatus.classList.add('auto-save-active');
                    } else {
                        autoSaveStatus.textContent = 'AUTO-SAVE NON ATTIVO';
                        autoSaveStatus.classList.remove('auto-save-active');
                        autoSaveStatus.classList.add('auto-save-inactive');
                    }
                }
            }
        }

        // This function was moved and merged with the main window.onclick handler above

        function exportToPDF() {
            try {
                // Use same logic as corrected riepilogo - separate floors
                const piano1Rooms = getRoomsByFloor('piano1');
                const piano2Rooms = getRoomsByFloor('piano2');
                const piano3Rooms = getRoomsByFloor('piano3');
                
                const piano1Stats = getFloorStats(piano1Rooms);
                const piano2Stats = getFloorStats(piano2Rooms);
                const piano3Stats = getFloorStats(piano3Rooms);
                
                // Calculate total statistics
                const totalStats = {
                    liberi: piano1Stats.liberi + piano2Stats.liberi + piano3Stats.liberi,
                    occupati: piano1Stats.occupati + piano2Stats.occupati + piano3Stats.occupati,
                    nonAgibili: piano1Stats.nonAgibili + piano2Stats.nonAgibili + piano3Stats.nonAgibili,
                    aiLavori: piano1Stats.aiLavori + piano2Stats.aiLavori + piano3Stats.aiLavori,
                    stanzeLibere: piano1Stats.stanzeLibere + piano2Stats.stanzeLibere + piano3Stats.stanzeLibere,
                    stanzeOccupate: piano1Stats.stanzeOccupate + piano2Stats.stanzeOccupate + piano3Stats.stanzeOccupate,
                    tipologie: {
                        singole: piano1Stats.tipologie.singole + piano2Stats.tipologie.singole + piano3Stats.tipologie.singole,
                        doppie: piano1Stats.tipologie.doppie + piano2Stats.tipologie.doppie + piano3Stats.tipologie.doppie,
                        triple: piano1Stats.tipologie.triple + piano2Stats.tipologie.triple + piano3Stats.tipologie.triple,
                        quadruple: piano1Stats.tipologie.quadruple + piano2Stats.tipologie.quadruple + piano3Stats.tipologie.quadruple,
                        quintuple: piano1Stats.tipologie.quintuple + piano2Stats.tipologie.quintuple + piano3Stats.tipologie.quintuple
                    }
                };
                
                // Get command stats for all floors
                const allRooms = [...piano1Rooms, ...piano2Rooms, ...piano3Rooms];
                const comandoStats = getFloorComandoStats(allRooms);
                
                const currentDate = new Date().toLocaleString('it-IT');
                
                // Create printable HTML content
                let htmlContent = `
                    <h1>GESTIONE CABINE "NAVE TRIESTE"<br><small style="font-size: 16px; color: #4a90e2;">RIEPILOGO GENERALE</small></h1>
                    <div class="date-info"><strong>Data: ${currentDate}</strong></div>
                    
                    <div class="piano-section" style="border-left: 4px solid #e74c3c; background: rgba(231, 76, 60, 0.1);">
                        <h3>GENERALE (TOTALE):</h3>
                        <ul>
                            <li>Letti liberi: ${totalStats.liberi}</li>
                            <li>Letti occupati: ${totalStats.occupati}</li>
                            <li>Stanze libere: ${totalStats.stanzeLibere}</li>
                            <li>Stanze occupate: ${totalStats.stanzeOccupate}</li>
                            <li>Stanze non agibili: ${totalStats.nonAgibili}</li>
                            <li>Stanze ai lavori: ${totalStats.aiLavori}</li>
                        </ul>
                    </div>
                    
                    <h2>üìä RIEPILOGO PER PIANO</h2>
                    
                    <div class="piano-section">
                        <h3>PIANO PRIMO:</h3>
                        <ul>
                            <li>Letti liberi: ${piano1Stats.liberi}</li>
                            <li>Letti occupati: ${piano1Stats.occupati}</li>
                            <li>Stanze libere: ${piano1Stats.stanzeLibere}</li>
                            <li>Stanze occupate: ${piano1Stats.stanzeOccupate}</li>
                            <li>Stanze non agibili: ${piano1Stats.nonAgibili}</li>
                            <li>Stanze ai lavori: ${piano1Stats.aiLavori}</li>
                        </ul>
                    </div>
                    
                    <div class="piano-section">
                        <h3>PIANO AMMEZZATO:</h3>
                        <ul>
                            <li>Letti liberi: ${piano2Stats.liberi}</li>
                            <li>Letti occupati: ${piano2Stats.occupati}</li>
                            <li>Stanze libere: ${piano2Stats.stanzeLibere}</li>
                            <li>Stanze occupate: ${piano2Stats.stanzeOccupate}</li>
                            <li>Stanze non agibili: ${piano2Stats.nonAgibili}</li>
                            <li>Stanze ai lavori: ${piano2Stats.aiLavori}</li>
                        </ul>
                    </div>
                    
                    <div class="piano-section">
                        <h3>PIANO SECONDO:</h3>
                        <ul>
                            <li>Letti liberi: ${piano3Stats.liberi}</li>
                            <li>Letti occupati: ${piano3Stats.occupati}</li>
                            <li>Stanze libere: ${piano3Stats.stanzeLibere}</li>
                            <li>Stanze occupate: ${piano3Stats.stanzeOccupate}</li>
                            <li>Stanze non agibili: ${piano3Stats.nonAgibili}</li>
                            <li>Stanze ai lavori: ${piano3Stats.aiLavori}</li>
                        </ul>
                    </div>
                    
                    <h2>üë• RIEPILOGO PER COMANDO</h2>
                `;
                
                if (Object.keys(comandoStats).length > 0) {
                    Object.keys(comandoStats).forEach(comando => {
                        const stats = comandoStats[comando];
                        htmlContent += `
                            <div class="comando-section">
                                <h3>${comando}:</h3>
                                <ul>
                                    <li>${stats.letti} letti in ${stats.stanze} ${stats.stanze === 1 ? 'stanza' : 'stanze'}</li>
                                </ul>
                                <ul style="margin-left: 20px;">
                        `;
                        
                        // Add room details for each comando
                        Object.keys(roomData).forEach(roomNumber => {
                            const data = roomData[roomNumber];
                            if (!data.unavailable && !data.underWork) {
                                const lettiComando = [];
                                data.beds.forEach((bed, index) => {
                                    if (bed.trim() === comando) {
                                        lettiComando.push(index + 1);
                                    }
                                });
                                
                                if (lettiComando.length > 0) {
                                    const roomType = getRoomTypeName(data.beds.length);
                                    htmlContent += `<li>Camera ${roomNumber} (${roomType}): Letto ${lettiComando.join(', ')}</li>`;
                                }
                            }
                        });
                        htmlContent += `</ul></div>`;
                    });
                } else {
                    htmlContent += '<p>Nessun comando assegnato</p>';
                }
                
                // Add details for each floor separately
                htmlContent += '<h2>üè† DETTAGLI CAMERE PIANO PRIMO</h2>';
                piano1Rooms.forEach(roomNumber => {
                    const data = roomData[roomNumber];
                    const roomType = getRoomTypeName(data.beds.length);
                    htmlContent += `<div class="camera-section"><h3>Camera ${roomNumber} (${roomType}):</h3><ul>`;
                    
                    if (data.unavailable) {
                        htmlContent += '<li>Stato: <span class="status-non-agibile">NON AGIBILE</span></li>';
                    } else if (data.underWork) {
                        htmlContent += '<li>Stato: <span class="status-ai-lavori">AI LAVORI</span></li>';
                    } else {
                        const occupied = data.beds.filter(bed => bed.trim() !== '').length;
                        let stato, statusClass;
                        if (occupied === 0) {
                            stato = 'Libera';
                            statusClass = 'status-libera';
                        } else if (occupied === data.beds.length) {
                            stato = 'Completa';
                            statusClass = 'status-occupata';
                        } else {
                            stato = 'Parzialmente occupata';
                            statusClass = 'status-parziale';
                        }
                        htmlContent += `<li>Stato: <span class="${statusClass}">${stato}</span></li>`;
                        
                        data.beds.forEach((bed, index) => {
                            if (bed.trim() !== '') {
                                htmlContent += `<li><strong>Letto ${index + 1}:</strong> <span style="color: #2980b9; font-weight: bold;">${bed}</span></li>`;
                            }
                        });
                    }
                    
                    if (data.notes && data.notes.trim() !== '') {
                        htmlContent += `<li><strong>üìù Note:</strong> <em style="color: #7f8c8d;">${data.notes}</em></li>`;
                    }
                    htmlContent += '</ul></div>';
                });
                
                htmlContent += '<h2>üè† DETTAGLI CAMERE PIANO AMMEZZATO</h2>';
                piano2Rooms.forEach(roomNumber => {
                    const data = roomData[roomNumber];
                    const roomType = getRoomTypeName(data.beds.length);
                    htmlContent += `<div class="camera-section"><h3>Camera ${roomNumber} (${roomType}):</h3><ul>`;
                    
                    if (data.unavailable) {
                        htmlContent += '<li>Stato: <span class="status-non-agibile">NON AGIBILE</span></li>';
                    } else if (data.underWork) {
                        htmlContent += '<li>Stato: <span class="status-ai-lavori">AI LAVORI</span></li>';
                    } else {
                        const occupied = data.beds.filter(bed => bed.trim() !== '').length;
                        let stato, statusClass;
                        if (occupied === 0) {
                            stato = 'Libera';
                            statusClass = 'status-libera';
                        } else if (occupied === data.beds.length) {
                            stato = 'Completa';
                            statusClass = 'status-occupata';
                        } else {
                            stato = 'Parzialmente occupata';
                            statusClass = 'status-parziale';
                        }
                        htmlContent += `<li>Stato: <span class="${statusClass}">${stato}</span></li>`;
                        
                        data.beds.forEach((bed, index) => {
                            if (bed.trim() !== '') {
                                htmlContent += `<li><strong>Letto ${index + 1}:</strong> <span style="color: #2980b9; font-weight: bold;">${bed}</span></li>`;
                            }
                        });
                    }
                    
                    if (data.notes && data.notes.trim() !== '') {
                        htmlContent += `<li><strong>üìù Note:</strong> <em style="color: #7f8c8d;">${data.notes}</em></li>`;
                    }
                    htmlContent += '</ul></div>';
                });
                
                htmlContent += '<h2>üè† DETTAGLI CAMERE PIANO SECONDO</h2>';
                piano3Rooms.forEach(roomNumber => {
                    const data = roomData[roomNumber];
                    const roomType = getRoomTypeName(data.beds.length);
                    htmlContent += `<div class="camera-section"><h3>Camera ${roomNumber} (${roomType}):</h3><ul>`;
                    
                    if (data.unavailable) {
                        htmlContent += '<li>Stato: <span class="status-non-agibile">NON AGIBILE</span></li>';
                    } else if (data.underWork) {
                        htmlContent += '<li>Stato: <span class="status-ai-lavori">AI LAVORI</span></li>';
                    } else {
                        const occupied = data.beds.filter(bed => bed.trim() !== '').length;
                        let stato, statusClass;
                        if (occupied === 0) {
                            stato = 'Libera';
                            statusClass = 'status-libera';
                        } else if (occupied === data.beds.length) {
                            stato = 'Completa';
                            statusClass = 'status-occupata';
                        } else {
                            stato = 'Parzialmente occupata';
                            statusClass = 'status-parziale';
                        }
                        htmlContent += `<li>Stato: <span class="${statusClass}">${stato}</span></li>`;
                        
                        data.beds.forEach((bed, index) => {
                            if (bed.trim() !== '') {
                                htmlContent += `<li><strong>Letto ${index + 1}:</strong> <span style="color: #2980b9; font-weight: bold;">${bed}</span></li>`;
                            }
                        });
                    }
                    
                    if (data.notes && data.notes.trim() !== '') {
                        htmlContent += `<li><strong>üìù Note:</strong> <em style="color: #7f8c8d;">${data.notes}</em></li>`;
                    }
                    htmlContent += '</ul></div>';
                });
                
                // Insert content into hidden div and print
                const pdfContent = document.getElementById('pdf-content');
                pdfContent.innerHTML = htmlContent;
                
                // Show the PDF content temporarily and print
                pdfContent.style.display = 'block';
                window.print();
                
                // Hide the content again after printing
                setTimeout(() => {
                    pdfContent.style.display = 'none';
                }, 1000);
                
            } catch (error) {
                console.error('PDF Export Error:', error);
                alert('‚ùå Errore durante la generazione del PDF: ' + error.message);
            }
        }

        let currentModificaRoom = null;
        let currentModificaFloor = 'piano1';
        
        function selectModificaFloor(floor) {
            if (!requireAuthentication()) return;
            // Clear all room button selections
            const allRoomBtns = document.querySelectorAll('.room-btn');
            allRoomBtns.forEach(btn => btn.classList.remove('selected'));
            
            // Select current floor button
            event.target.classList.add('selected');

            // Show modifica camere section
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('room-info').classList.remove('active');
            document.getElementById('tripla-rooms-view').classList.remove('active');
            document.getElementById('riepilogo-info').classList.remove('active');
            document.getElementById('disponibilita-info').classList.remove('active');
            document.getElementById('dati-info').classList.remove('active');
            document.getElementById('spogliatoi-info').classList.remove('active');
            document.getElementById('locali-info').classList.remove('active');
            document.getElementById('genera-ricevuta-info').classList.remove('active');
            document.getElementById('modifica-camere-info').classList.add('active');

            // Show the selected floor
            showModificaFloor(floor);
        }

        function selectLocaliType(tipo) {
            // Clear all room button selections
            const allRoomBtns = document.querySelectorAll('.room-btn');
            allRoomBtns.forEach(btn => btn.classList.remove('selected'));
            
            // Select current type button
            event.target.classList.add('selected');

            // Show locali section
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('room-info').classList.remove('active');
            document.getElementById('tripla-rooms-view').classList.remove('active');
            document.getElementById('riepilogo-info').classList.remove('active');
            document.getElementById('disponibilita-info').classList.remove('active');
            document.getElementById('dati-info').classList.remove('active');
            document.getElementById('modifica-camere-info').classList.remove('active');
            document.getElementById('spogliatoi-info').classList.remove('active');
            document.getElementById('locali-info').classList.remove('active');
            document.getElementById('genera-ricevuta-info').classList.remove('active');
            document.getElementById('locali-info').classList.add('active');

            // Show the selected type
            showLocaliType(tipo);
        }

        function showLocaliType(tipo) {
            // Update title based on selected type
            const tipoNames = {
                'segreterie': 'SEGRETERIE',
                'uffici': 'UFFICI',
                'classificati': 'CLASSIFICATI',
                'casse-riserva': 'CASSE DI RISERVA',
                'magazzini': 'MAGAZZINI'
            };
            document.getElementById('locali-type-title').textContent = `GESTIONE LOCALI - ${tipoNames[tipo]}`;
            
            // Define locali for each type
            const locali = {
                'segreterie': ['L 1-07', 'L 1-08', 'L 1-09', 'L 1-33'],
                'uffici': ['L A-61', 'L 1-34', 'L 1-37', 'L 1-90', 'L 1-91', 'L 1-92', 'L 1-93', 'L 1-94', 'L 1-95', 'L 1-96', 'L 1-97', 'L 1-98', 'L 1-99', 'L 1-100', 'L A-101'],
                'classificati': ['L A106-1', 'L A106-2', 'L A106-3', 'L A106-4'],
                'casse-riserva': ['L A108-1', 'L A108-2', 'L A108-3'],
                'magazzini': ['L 1-80', 'L 1-86', 'L 1-87', 'L 2-32', 'L 2-34', 'L 2-41', 'L 2-82', 'L 2-83']
            };
            
            // Update instructions
            const instructions = document.getElementById('locali-instructions');
            instructions.innerHTML = `<p>Seleziona un locale di tipo <strong>${tipoNames[tipo]}</strong> per gestire l'assegnazione:</p>`;
            
            // Generate locali grid
            const localiGrid = document.getElementById('locali-grid');
            let localiHtml = '';
            
            if (locali[tipo]) {
                locali[tipo].forEach(locale => {
                    localiHtml += `
                        <button class="room-number-btn" onclick="openLocaleModal('${locale}')" style="width: 200px; margin: 10px;">
                            ${locale}
                            <div class="status-indicator" id="status-${locale.replace(/\s/g, '-').replace(/\//g, '-')}"></div>
                        </button>
                    `;
                });
                
                localiGrid.innerHTML = `
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 20px;">
                        ${localiHtml}
                    </div>
                `;
                
                // Initialize status indicators for the displayed locali
                setTimeout(() => {
                    locali[tipo].forEach(locale => {
                        updateLocaleStatus(locale);
                    });
                }, 100);
            } else {
                localiGrid.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: rgba(255,255,255,0.6); font-style: italic;">
                        <h3>üì¶ Nessun locale disponibile</h3>
                        <p>Non ci sono locali configurati per questo tipo.</p>
                    </div>
                `;
            }
        }

        function selectSpogliatoiFloor(floor) {
            // Clear all room button selections
            const allRoomBtns = document.querySelectorAll('.room-btn');
            allRoomBtns.forEach(btn => btn.classList.remove('selected'));
            
            // Select current floor button
            event.target.classList.add('selected');

            // Show spogliatoi section
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('room-info').classList.remove('active');
            document.getElementById('tripla-rooms-view').classList.remove('active');
            document.getElementById('riepilogo-info').classList.remove('active');
            document.getElementById('disponibilita-info').classList.remove('active');
            document.getElementById('dati-info').classList.remove('active');
            document.getElementById('modifica-camere-info').classList.remove('active');
            document.getElementById('spogliatoi-info').classList.remove('active');
            document.getElementById('genera-ricevuta-info').classList.remove('active');
            document.getElementById('spogliatoi-info').classList.add('active');

            // Show the selected floor
            showSpogliatoiFloor(floor);
        }

        function showSpogliatoiFloor(floor) {
            // Update title based on selected floor
            const floorNames = {
                'piano1': 'PIANO PRIMO',
                'piano2': 'PIANO AMMEZZATO', 
                'piano3': 'PIANO SECONDO'
            };
            document.getElementById('spogliatoi-floor-title').textContent = `GESTIONE SPOGLIATOI - ${floorNames[floor]}`;
            
            // Define lockers for each floor
            const spogliatoi = {
                'piano1': ['S 1-56', 'S 1-63', 'S 1-65', 'S 1-69'],
                'piano3': ['S 2-02', 'S 2-37', 'S 2-84', 'S 2-85', 'S 2-87']
            };
            
            // Update instructions
            const instructions = document.getElementById('spogliatoi-instructions');
            instructions.innerHTML = `<p>Seleziona uno spogliatoio del <strong>${floorNames[floor]}</strong> per gestire l'assegnazione:</p>`;
            
            // Generate spogliatoi grid
            const spogliatoiGrid = document.getElementById('spogliatoi-grid');
            let spogliatoiHtml = '';
            
            if (spogliatoi[floor]) {
                spogliatoi[floor].forEach(spogliatoio => {
                    spogliatoiHtml += `
                        <button class="room-number-btn" onclick="openSpogliatoioModal('${spogliatoio}')" style="width: 200px; margin: 10px;">
                            ${spogliatoio}
                            <div class="status-indicator" id="status-${spogliatoio.replace(/\s/g, '-')}"></div>
                        </button>
                    `;
                });
                
                spogliatoiGrid.innerHTML = `
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 20px;">
                        ${spogliatoiHtml}
                    </div>
                `;
                
                // Initialize status indicators for the displayed spogliatoi
                setTimeout(() => {
                    spogliatoi[floor].forEach(spogliatoio => {
                        updateSpogliatoioStatus(spogliatoio);
                    });
                }, 100);
            } else {
                spogliatoiGrid.innerHTML = `
                    <div style="text-align: center; padding: 50px; color: rgba(255,255,255,0.6); font-style: italic;">
                        <h3>üì¶ Nessuno spogliatoio disponibile</h3>
                        <p>Non ci sono spogliatoi configurati per questo piano.</p>
                    </div>
                `;
            }
        }

        
        function showModificaFloor(floor) {
            currentModificaFloor = floor;
            
            // Update title based on selected floor
            const floorNames = {
                'piano1': 'PIANO PRIMO',
                'piano2': 'PIANO AMMEZZATO', 
                'piano3': 'PIANO SECONDO'
            };
            document.getElementById('modifica-floor-title').textContent = `MODIFICA CONFIGURAZIONE CAMERE - ${floorNames[floor]}`;
            
            // Generate rooms for the selected floor
            generateFloorRoomsList(floor);
        }
        
        function generateFloorRoomsList(floor) {
            const roomsGrid = document.getElementById('floor-rooms-grid');
            const instructions = document.getElementById('modifica-instructions');
            
            const floorNames = {
                'piano1': 'Piano Primo',
                'piano2': 'Piano Ammezzato',
                'piano3': 'Piano Secondo'
            };
            
            const floorName = floorNames[floor];
            
            // Filter rooms by floor prefix
            let floorRooms = [];
            if (floor === 'piano1') {
                floorRooms = Object.keys(roomData).filter(room => 
                    room.startsWith('1-') || /^10[1-5]$/.test(room)
                );
            } else if (floor === 'piano2') {
                floorRooms = Object.keys(roomData).filter(room => room.startsWith('A-'));
            } else if (floor === 'piano3') {
                floorRooms = Object.keys(roomData).filter(room => room.startsWith('2-'));
            }
            
            // Sort rooms in ascending order (natural sort for mixed numbers)
            floorRooms.sort((a, b) => {
                // Extract numeric parts for proper sorting
                const aNum = a.match(/\d+/g)?.map(Number) || [0];
                const bNum = b.match(/\d+/g)?.map(Number) || [0];
                
                // Compare first number
                if (aNum[0] !== bNum[0]) return aNum[0] - bNum[0];
                
                // If same first number, compare second number if exists
                return (aNum[1] || 0) - (bNum[1] || 0);
            });
            
            // Generate room buttons HTML
            let roomsHtml = '';
            if (floorRooms.length === 0) {
                roomsHtml = `<p style="color: rgba(255,255,255,0.6); font-style: italic; text-align: center; margin-top: 50px;">
                    Nessuna camera configurata per il ${floorName}
                </p>`;
            } else {
                floorRooms.forEach(roomNumber => {
                    const bedCount = roomData[roomNumber].beds.length;
                    const roomType = getRoomTypeName(bedCount);
                    
                    roomsHtml += `
                        <button class="modifica-room-btn" onclick="openModificaCameraModal('${roomNumber}')">
                            <span class="room-number">${roomNumber}</span>
                            <span class="room-type">${roomType} (${bedCount} ${bedCount === 1 ? 'letto' : 'letti'})</span>
                        </button>
                    `;
                });
            }
            
            instructions.innerHTML = `<p>Seleziona una camera dal <strong>${floorName}</strong> per modificarne la configurazione dei letti:</p>`;
            roomsGrid.innerHTML = roomsHtml;
        }
        
        function getRoomTypeName(bedCount) {
            switch(bedCount) {
                case 1: return 'Singola';
                case 2: return 'Doppia';
                case 3: return 'Tripla';
                case 4: return 'Quadrupla';
                case 5: return 'Quintupla';
                default: return 'Sconosciuta';
            }
        }
        
        function openModificaCameraModal(roomNumber) {
            if (!requireAuthentication()) return;
            currentModificaRoom = roomNumber;
            const modal = document.getElementById('modificaCameraModal');
            const title = document.getElementById('modifica-room-title');
            const data = roomData[roomNumber];
            
            title.textContent = `Modifica Camera ${roomNumber}`;
            
            // Set current bed count
            const currentBedCount = data.beds.length;
            const radioButtons = document.querySelectorAll('input[name="bed-count"]');
            radioButtons.forEach(radio => {
                radio.checked = radio.value == currentBedCount;
            });
            
            modal.style.display = 'block';
        }
        
        function closeModificaCameraModal() {
            document.getElementById('modificaCameraModal').style.display = 'none';
            currentModificaRoom = null;
        }
        
        function saveRoomModification() {
            if (!currentModificaRoom) return;
            if (!requireAuthentication()) return;
            
            const selectedBedCount = document.querySelector('input[name="bed-count"]:checked');
            if (!selectedBedCount) {
                alert('Seleziona il numero di letti per la camera.');
                return;
            }
            
            const newBedCount = parseInt(selectedBedCount.value);
            const currentData = roomData[currentModificaRoom];
            const oldBedCount = currentData.beds.length;
            
            if (newBedCount === oldBedCount) {
                alert('Il numero di letti non √® cambiato.');
                closeModificaCameraModal();
                return;
            }
            
            const oldTypeName = getRoomTypeName(oldBedCount);
            const newTypeName = getRoomTypeName(newBedCount);
            
            // Confirm the change
            if (!confirm(`Sei sicuro di voler modificare la Camera ${currentModificaRoom}?\n\nCambiamento: ${oldTypeName} (${oldBedCount} letti) ‚Üí ${newTypeName} (${newBedCount} letti)\n\n‚ö†Ô∏è Questo canceller√† tutte le assegnazioni correnti per questa camera.`)) {
                return;
            }
            
            // Update room data
            const newBeds = new Array(newBedCount).fill('');
            roomData[currentModificaRoom] = {
                beds: newBeds,
                unavailable: false,
                underWork: false,
                notes: currentData.notes || ''
            };
            
            // Save to localStorage
            saveRoomData();
            
            // Refresh the current floor rooms list
            generateFloorRoomsList(currentModificaFloor);
            
            // Close modal
            closeModificaCameraModal();
            
            // Show success message with updated info
            alert(`‚úÖ Camera ${currentModificaRoom} modificata con successo!\n\nNuova configurazione: ${newTypeName} con ${newBedCount} ${newBedCount === 1 ? 'letto' : 'letti'}\n\nüîÑ La camera √® stata automaticamente ricollocata nella categoria corretta.`);
            
            // Update all other sections that might show this room
            if (typeof generateDisponibilitaData === 'function') {
                generateDisponibilitaData();
            }
            
            // If user is currently viewing a room type view, refresh it
            const triplaRoomsView = document.getElementById('tripla-rooms-view');
            if (triplaRoomsView && triplaRoomsView.classList.contains('active')) {
                // Refresh the current view with the same floor and room type
                if (currentFloor && currentRoom) {
                    generateDynamicRoomView(currentFloor, currentRoom);
                }
            }
        }


        // Initialize the page when loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeRoomStatus();
            initializeSpogliatoioStatus();
            initializeLocaleStatus();
            // Force reset once for Piano Secondo rooms
            const resetDone = localStorage.getItem('piano3_rooms_loaded');
            if (!resetDone) {
                localStorage.removeItem('maristanav_room_data');
                localStorage.setItem('piano3_rooms_loaded', 'true');
                location.reload();
            }
            
        });

        // Ricevuta generation functions
        let selectedItems = {
            camere: new Set(),
            spogliatoi: new Set(),
            locali: new Set()
        };

        let currentStanzeFilter = 'tutti';

        function initializeRicevutaSelections() {
            // Clear previous selections
            selectedItems.camere.clear();
            selectedItems.spogliatoi.clear();
            selectedItems.locali.clear();

            // Initialize camere selection with filter
            populateStanzeGrid();

            // Initialize spogliatoi selection
            const spogliatoiGrid = document.getElementById('spogliatoi-selection');
            let spogliatoiHtml = '';
            
            Object.keys(spogliatoioData).forEach(spogliatoioNumber => {
                const data = spogliatoioData[spogliatoioNumber];
                let statusInfo = '';
                
                if (data.unavailable) {
                    statusInfo = 'NON AGIBILE';
                } else if (data.underWork) {
                    statusInfo = 'AI LAVORI';
                } else if (data.assigned && data.command.trim() !== '') {
                    statusInfo = `Assegnato a ${data.command}`;
                } else {
                    statusInfo = 'Libero';
                }
                
                spogliatoiHtml += `
                    <div class="selection-item" onclick="toggleSelection('spogliatoi', '${spogliatoioNumber}')">
                        <div class="item-title">Spogliatoio ${spogliatoioNumber}</div>
                        <div class="item-info">${statusInfo}</div>
                    </div>
                `;
            });
            
            spogliatoiGrid.innerHTML = spogliatoiHtml;

            // Initialize locali selection
            const localiGrid = document.getElementById('locali-selection');
            let localiHtml = '';
            
            Object.keys(localiData).forEach(localeNumber => {
                const data = localiData[localeNumber];
                let statusInfo = '';
                
                if (data.unavailable) {
                    statusInfo = 'NON AGIBILE';
                } else if (data.underWork) {
                    statusInfo = 'AI LAVORI';
                } else if (data.assigned && data.command.trim() !== '') {
                    statusInfo = `Assegnato a ${data.command}`;
                } else {
                    statusInfo = 'Libero';
                }
                
                localiHtml += `
                    <div class="selection-item" onclick="toggleSelection('locali', '${localeNumber}')">
                        <div class="item-title">Locale ${localeNumber}</div>
                        <div class="item-info">${statusInfo}</div>
                    </div>
                `;
            });
            
            localiGrid.innerHTML = localiHtml;
        }

        function toggleSelection(type, item) {
            if (selectedItems[type].has(item)) {
                selectedItems[type].delete(item);
            } else {
                selectedItems[type].add(item);
            }
            
            // Update visual selection
            event.target.closest('.selection-item').classList.toggle('selected');
        }

        function clearRicevutaSelection() {
            selectedItems.camere.clear();
            selectedItems.spogliatoi.clear();
            selectedItems.locali.clear();
            
            // Refresh all grids to remove visual selections
            populateStanzeGrid();
            
            // Refresh spogliatoi
            const spogliatoiGrid = document.getElementById('spogliatoi-selection');
            let spogliatoiHtml = '';
            Object.keys(spogliatoioData).forEach(spogliatoioNumber => {
                const data = spogliatoioData[spogliatoioNumber];
                let statusInfo = '';
                if (data.unavailable) {
                    statusInfo = 'NON AGIBILE';
                } else if (data.underWork) {
                    statusInfo = 'AI LAVORI';
                } else if (data.assigned && data.command.trim() !== '') {
                    statusInfo = `Assegnato a ${data.command}`;
                } else {
                    statusInfo = 'Libero';
                }
                spogliatoiHtml += `
                    <div class="selection-item" onclick="toggleSelection('spogliatoi', '${spogliatoioNumber}')">
                        <div class="item-title">Spogliatoio ${spogliatoioNumber}</div>
                        <div class="item-info">${statusInfo}</div>
                    </div>
                `;
            });
            spogliatoiGrid.innerHTML = spogliatoiHtml;
            
            // Refresh locali
            const localiGrid = document.getElementById('locali-selection');
            let localiHtml = '';
            Object.keys(localiData).forEach(localeNumber => {
                const data = localiData[localeNumber];
                let statusInfo = '';
                if (data.unavailable) {
                    statusInfo = 'NON AGIBILE';
                } else if (data.underWork) {
                    statusInfo = 'AI LAVORI';
                } else if (data.assigned && data.command.trim() !== '') {
                    statusInfo = `Assegnato a ${data.command}`;
                } else {
                    statusInfo = 'Libero';
                }
                localiHtml += `
                    <div class="selection-item" onclick="toggleSelection('locali', '${localeNumber}')">
                        <div class="item-title">Locale ${localeNumber}</div>
                        <div class="item-info">${statusInfo}</div>
                    </div>
                `;
            });
            localiGrid.innerHTML = localiHtml;
        }

        function generateRicevuta() {
            if (selectedItems.camere.size === 0 && selectedItems.spogliatoi.size === 0 && selectedItems.locali.size === 0) {
                alert('Seleziona almeno un elemento per generare la ricevuta.');
                return;
            }
            
            let ricevutaContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>RICEVUTA DI ASSEGNAZIONE - CASERMA L. PIOMARTA</title>
                    <style>
                        body { 
                            font-family: 'Times New Roman', serif; 
                            margin: 40px; 
                            line-height: 1.6;
                            color: #000;
                        }
                        .header { 
                            text-align: center; 
                            margin-bottom: 40px;
                            border-bottom: 3px solid #000;
                            padding-bottom: 20px;
                        }
                        .header h1 { 
                            font-size: 24px; 
                            margin-bottom: 10px;
                            text-transform: uppercase;
                            letter-spacing: 2px;
                        }
                        .header h2 { 
                            font-size: 18px; 
                            color: #333;
                            font-weight: normal;
                        }
                        .section { 
                            margin-bottom: 30px; 
                            page-break-inside: avoid;
                        }
                        .section h3 { 
                            background: #f0f0f0; 
                            padding: 10px; 
                            margin-bottom: 15px;
                            border-left: 5px solid #333;
                            font-size: 16px;
                        }
                        .item { 
                            margin-bottom: 15px; 
                            padding: 10px;
                            border: 1px solid #ddd;
                            background: #fafafa;
                        }
                        .item-title { 
                            font-weight: bold; 
                            font-size: 14px;
                            margin-bottom: 5px;
                        }
                        .item-details { 
                            font-size: 12px; 
                            color: #666;
                        }
                        .footer { 
                            margin-top: 60px; 
                            border-top: 1px solid #000;
                            padding-top: 30px;
                        }
                        .signature-row {
                            display: flex;
                            justify-content: space-between;
                            align-items: baseline;
                            margin-bottom: 20px;
                        }
                        .signature-line-container {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        .date-place-inline { 
                            text-align: left;
                        }
                        .signature-section-inline { 
                            text-align: center;
                        }
                        .observations-bottom { 
                            position: absolute;
                            bottom: 60px;
                            left: 22px;
                            width: 300px;
                        }
                        .observations-bottom h4 {
                            margin-left: 0px;
                            margin-bottom: 15px;
                            font-size: 14px;
                        }
                        .observations-bottom .obs-line {
                            margin-left: 0px;
                        }
                        .observations h4 { 
                            margin-bottom: 15px;
                            font-size: 14px;
                        }
                        .obs-line { 
                            border-bottom: 1px solid #000; 
                            height: 25px; 
                            margin-bottom: 10px;
                        }
                        .date-place { 
                            margin-bottom: 40px;
                        }
                        .signature-line { 
                            border-bottom: 2px solid #000; 
                            width: 250px; 
                            height: 40px; 
                            margin: 20px auto;
                        }
                        @media print {
                            body { margin: 20px; }
                            .section { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>MARINA MILITARE ITALIANA</h1>
                        <h2>RICEVUTA DI ASSEGNAZIONE ALLOGGI</h2>
                        <p><strong>CASERMA "L. PIOMARTA" - MARISTANAV</strong></p>
                    </div>
            `;
            
            const currentDate = new Date().toLocaleDateString('it-IT');
            
            // Add selected items
            if (selectedItems.camere.size > 0) {
                ricevutaContent += '<div class="section"><h3>üè† STANZE ASSEGNATE</h3>';
                selectedItems.camere.forEach(roomNumber => {
                    const data = roomData[roomNumber];
                    const roomType = getRoomTypeName(data.beds.length);
                    const comando = data.beds.find(bed => bed.trim() !== '') || 'N/A';
                    
                    let arrediText = '';
                    if (data.furniture && Object.keys(data.furniture).length > 0) {
                        const arredi = [];
                        Object.keys(data.furniture).forEach(item => {
                            const quantity = data.furniture[item];
                            if (quantity > 0) {
                                arredi.push(`${item}: ${quantity}`);
                            }
                        });
                        if (arredi.length > 0) {
                            arrediText = `<br><strong>Arredi:</strong> ${arredi.join(', ')}`;
                        }
                    }
                    
                    ricevutaContent += `
                        <div class="item">
                            <div class="item-title">Stanza ${roomNumber} (${roomType})</div>
                            <div class="item-details">
                                <strong>Assegnatario:</strong> ${comando}${arrediText}
                                ${data.notes ? `<br><strong>Note:</strong> ${data.notes}` : ''}
                            </div>
                        </div>
                    `;
                });
                ricevutaContent += '</div>';
            }
            
            if (selectedItems.spogliatoi.size > 0) {
                ricevutaContent += '<div class="section"><h3>üëî SPOGLIATOI ASSEGNATI</h3>';
                selectedItems.spogliatoi.forEach(spogliatoioNumber => {
                    const data = spogliatoioData[spogliatoioNumber];
                    const comando = data.command || 'N/A';
                    
                    let arrediText = '';
                    if (data.furniture && Object.keys(data.furniture).length > 0) {
                        const arredi = [];
                        Object.keys(data.furniture).forEach(item => {
                            const quantity = data.furniture[item];
                            if (quantity > 0) {
                                arredi.push(`${item}: ${quantity}`);
                            }
                        });
                        if (arredi.length > 0) {
                            arrediText = `<br><strong>Arredi:</strong> ${arredi.join(', ')}`;
                        }
                    }
                    
                    ricevutaContent += `
                        <div class="item">
                            <div class="item-title">Spogliatoio ${spogliatoioNumber}</div>
                            <div class="item-details">
                                <strong>Assegnatario:</strong> ${comando}${arrediText}
                                ${data.notes ? `<br><strong>Note:</strong> ${data.notes}` : ''}
                            </div>
                        </div>
                    `;
                });
                ricevutaContent += '</div>';
            }
            
            if (selectedItems.locali.size > 0) {
                ricevutaContent += '<div class="section"><h3>üè¢ LOCALI ASSEGNATI</h3>';
                selectedItems.locali.forEach(localeNumber => {
                    const data = localiData[localeNumber];
                    const comando = data.command || 'N/A';
                    
                    let arrediText = '';
                    if (data.furniture && Object.keys(data.furniture).length > 0) {
                        const arredi = [];
                        Object.keys(data.furniture).forEach(item => {
                            const quantity = data.furniture[item];
                            if (quantity > 0) {
                                arredi.push(`${item}: ${quantity}`);
                            }
                        });
                        if (arredi.length > 0) {
                            arrediText = `<br><strong>Arredi:</strong> ${arredi.join(', ')}`;
                        }
                    }
                    
                    ricevutaContent += `
                        <div class="item">
                            <div class="item-title">Locale ${localeNumber}</div>
                            <div class="item-details">
                                <strong>Assegnatario:</strong> ${comando}${arrediText}
                                ${data.notes ? `<br><strong>Note:</strong> ${data.notes}` : ''}
                            </div>
                        </div>
                    `;
                });
                ricevutaContent += '</div>';
            }
            
            ricevutaContent += `
                    <div class="footer">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="text-align: left;">
                                <p><strong>LUOGO E DATA:</strong></p>
                                <p>La Spezia, ${currentDate}</p>
                            </div>
                            <div style="text-align: center;">
                                <p><strong>FIRMA PER RICEVUTA</strong></p>
                                <div style="border-bottom: 2px solid #000; width: 250px; height: 40px; margin: 20px 0 10px 0;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="observations-bottom">
                        <h4>OSSERVAZIONI:</h4>
                        <div class="obs-line"></div>
                        <div class="obs-line"></div>
                        <div class="obs-line"></div>
                    </div>
                </body>
                </html>
            `;
            
            // Open in new window for printing
            const printWindow = window.open('', '_blank');
            printWindow.document.write(ricevutaContent);
            printWindow.document.close();
            printWindow.focus();
            
            // Automatically trigger print dialog
            setTimeout(() => {
                printWindow.print();
            }, 500);
        }

        function filterStanze(piano) {
            currentStanzeFilter = piano;
            
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Repopulate stanze grid
            populateStanzeGrid();
        }

        function populateStanzeGrid() {
            const camereGrid = document.getElementById('camere-selection');
            let camereHtml = '';
            
            Object.keys(roomData).forEach(roomNumber => {
                // Apply filter
                if (currentStanzeFilter !== 'tutti') {
                    const floorRooms = getRoomsByFloor(currentStanzeFilter);
                    if (!floorRooms.includes(roomNumber)) {
                        return; // Skip this room
                    }
                }
                
                const data = roomData[roomNumber];
                const roomType = getRoomTypeName(data.beds.length);
                let statusInfo = '';
                
                if (data.unavailable) {
                    statusInfo = 'NON AGIBILE';
                } else if (data.underWork) {
                    statusInfo = 'AI LAVORI';
                } else {
                    const occupied = data.beds.filter(bed => bed.trim() !== '').length;
                    if (occupied > 0) {
                        const comando = data.beds.find(bed => bed.trim() !== '');
                        statusInfo = `Assegnata a ${comando}`;
                    } else {
                        statusInfo = 'Libera';
                    }
                }
                
                const isSelected = selectedItems.camere.has(roomNumber) ? 'selected' : '';
                camereHtml += `
                    <div class="selection-item ${isSelected}" onclick="toggleSelection('camere', '${roomNumber}')">
                        <div class="item-title">Stanza ${roomNumber} (${roomType})</div>
                        <div class="item-info">${statusInfo}</div>
                    </div>
                `;
            });
            
            camereGrid.innerHTML = camereHtml;
        }

        function toggleSection(headerElement) {
            const section = headerElement.closest('.selection-section');
            section.classList.toggle('collapsed');
        }

        // Auto-Save System
        class AutoSaveManager {
            constructor() {
                this.fileHandle = null;
                this.hasUnsavedChanges = false;
                this.isEnabled = false;
                this.dbName = 'piomarta_autosave';
                this.db = null;
                this.isInitializing = true; // Flag per evitare popup durante inizializzazione
                this.promptShown = false; // Flag per evitare popup duplicati
                
                // Sync manager for multi-user support
                this.lastModified = null;
                this.lastSize = null;
                this.syncEnabled = false;
                this.isSyncing = false;
                
                this.init();
            }
            
            async init() {
                // Initialize IndexedDB for file handle persistence
                await this.initDB();
                
                // Load saved file handle and settings
                const savedEnabled = localStorage.getItem('piomarta_auto_save_enabled');
                if (savedEnabled === 'true') {
                    this.isEnabled = true;
                    await this.loadFileHandle();
                    console.log('üîÑ Auto-save abilitato e file handle caricato');
                    
                    // Auto-save gi√† configurato
                    if (this.fileHandle) {
                        console.log('üíæ Auto-save already configured');
                    }
                }
                
                // Dopo 3 secondi dall'inizializzazione, permettiamo i popup
                setTimeout(() => {
                    this.isInitializing = false;
                    console.log('üîÑ Inizializzazione auto-save completata');
                    
                    // Abilita sync se c'√® un file handle
                    if (this.fileHandle) {
                        this.enableSync();
                    }
                    
                }, 3000);
            }
            
            async initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('fileHandles')) {
                            db.createObjectStore('fileHandles', { keyPath: 'key' });
                        }
                    };
                });
            }
            
            async saveFileHandle() {
                if (!this.db || !this.fileHandle) return;
                
                return new Promise((resolve, reject) => {
                    try {
                        const transaction = this.db.transaction(['fileHandles'], 'readwrite');
                        const store = transaction.objectStore('fileHandles');
                        const request = store.put({ key: 'autoSaveFile', handle: this.fileHandle });
                        
                        request.onsuccess = () => {
                            console.log('üìÅ File handle salvato in IndexedDB');
                            resolve();
                        };
                        request.onerror = () => {
                            console.error('Errore salvataggio file handle:', request.error);
                            reject(request.error);
                        };
                    } catch (error) {
                        console.error('Errore salvataggio file handle:', error);
                        reject(error);
                    }
                });
            }
            
            async loadFileHandle() {
                if (!this.db) return false;
                
                return new Promise((resolve) => {
                    try {
                        const transaction = this.db.transaction(['fileHandles'], 'readonly');
                        const store = transaction.objectStore('fileHandles');
                        const request = store.get('autoSaveFile');
                        
                        request.onsuccess = () => {
                            const result = request.result;
                            if (result && result.handle) {
                                this.fileHandle = result.handle;
                                console.log('üìÅ File handle caricato da IndexedDB:', this.fileHandle.name);
                                resolve(true);
                            } else {
                                resolve(false);
                            }
                        };
                        request.onerror = () => {
                            console.error('Errore caricamento file handle:', request.error);
                            // Se errore, disabilita auto-save
                            this.isEnabled = false;
                            localStorage.setItem('piomarta_auto_save_enabled', 'false');
                            resolve(false);
                        };
                    } catch (error) {
                        console.error('Errore caricamento file handle:', error);
                        this.isEnabled = false;
                        localStorage.setItem('piomarta_auto_save_enabled', 'false');
                        resolve(false);
                    }
                });
            }
            
            markAsChanged() {
                if (!this.isEnabled) return;
                
                // Non permettere auto-save in modalit√† solo lettura
                if (isReadOnlyMode || !isAuthenticated) {
                    console.log('üîí Auto-save disabled - read-only mode or not authenticated');
                    return;
                }
                
                // Non mostrare popup durante inizializzazione
                if (this.isInitializing) {
                    console.log('üîÑ Modifica durante inizializzazione - popup saltato');
                    return;
                }
                
                this.hasUnsavedChanges = true;
                console.log('üî• Dati modificati - auto-save pendente');
                
                // Se non abbiamo il file handle, chiedi prima la selezione
                if (!this.fileHandle) {
                    // Evita popup duplicati
                    if (!this.promptShown) {
                        this.promptShown = true;
                        this.showAutoSavePrompt();
                    }
                } else {
                    // Altrimenti salva immediatamente
                    this.saveImmediately();
                }
            }
            
            showAutoSavePrompt() {
                const promptDiv = document.createElement('div');
                promptDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                    color: white;
                    padding: 25px;
                    border-radius: 10px;
                    font-size: 1.1em;
                    z-index: 10000;
                    box-shadow: 0 5px 20px rgba(0,0,0,0.4);
                    text-align: center;
                    max-width: 400px;
                `;
                
                promptDiv.innerHTML = `
                    <h3 style="margin: 0 0 15px 0;">üíæ Auto-Save Prima Configurazione</h3>
                    <p style="margin: 10px 0;">Seleziona il file dove salvare automaticamente i dati</p>
                    <p style="margin: 10px 0; font-size: 0.9em; opacity: 0.8;">Dopo questa selezione, i salvataggi saranno automatici</p>
                    <div style="margin-top: 20px;">
                        <button onclick="triggerAutoSaveSetup()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">
                            üìÅ Seleziona File
                        </button>
                        <button onclick="closeAutoSavePrompt()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                            ‚ùå Salta Ora
                        </button>
                    </div>
                `;
                
                promptDiv.id = 'auto-save-setup-prompt';
                document.body.appendChild(promptDiv);
                
                // Auto-close dopo 15 secondi
                setTimeout(() => {
                    if (document.getElementById('auto-save-setup-prompt')) {
                        closeAutoSavePrompt();
                    }
                }, 15000);
            }
            
            async configureAutoSave() {
                try {
                    this.fileHandle = await window.showSaveFilePicker({
                        suggestedName: "piomarta_dati.json",
                        types: [{
                            description: "JSON file",
                            accept: {"application/json": [".json"]},
                        }],
                    });
                    
                    this.isEnabled = true;
                    localStorage.setItem('piomarta_auto_save_enabled', 'true');
                    
                    // Aggiorna l'indicatore di stato nell'header
                    const autoSaveStatus = document.getElementById('autoSaveStatus');
                    if (autoSaveStatus) {
                        autoSaveStatus.textContent = 'AUTO-SAVE ATTIVO';
                        autoSaveStatus.classList.remove('auto-save-inactive');
                        autoSaveStatus.classList.add('auto-save-active');
                    }
                    
                    // Salva il file handle in IndexedDB per persistenza
                    await this.saveFileHandle();
                    
                    // Abilita sync multi-utente
                    this.enableSync();
                    
                    showNotification('Auto-save configurato con sync multi-utente!', 'success');
                    console.log('üìÅ Auto-save e sync configurati:', this.fileHandle.name);
                    return true;
                } catch (error) {
                    console.log('‚ùå Configurazione auto-save annullata');
                    return false;
                }
            }
            
            async clearFileHandle() {
                if (this.db) {
                    try {
                        const transaction = this.db.transaction(['fileHandles'], 'readwrite');
                        const store = transaction.objectStore('fileHandles');
                        const request = store.delete('autoSaveFile');
                        request.onsuccess = () => console.log('üóëÔ∏è File handle rimosso da IndexedDB');
                        request.onerror = (error) => console.error('Errore rimozione file handle:', error);
                    } catch (error) {
                        console.error('Errore rimozione file handle:', error);
                    }
                }
            }
            
            async saveImmediately() {
                if (!this.isEnabled || !this.hasUnsavedChanges || !this.fileHandle) return;
                
                try {
                    const exportData = {
                        system: 'PIOMARTA - Auto Export',
                        exportDate: new Date().toISOString(),
                        roomData: roomData,
                        spogliatoioData: spogliatoioData,
                        localiData: localiData,
                        version: '1.1'
                    };
                    
                    const writable = await this.fileHandle.createWritable();
                    await writable.write(JSON.stringify(exportData, null, 2));
                    await writable.close();
                    
                    this.hasUnsavedChanges = false;
                    console.log('‚úÖ Auto-save completato:', this.fileHandle.name);
                    
                    // Aggiorna metadata dopo il salvataggio per sync
                    await this.updateFileMetadata();
                    
                    // Notifica discreta
                    showAutoSaveNotification();
                    
                } catch (error) {
                    console.error('‚ùå Auto-save fallito:', error);
                    
                    // Offri opzioni all'utente invece di forzare immediata riselezio ne
                    const userChoice = confirm(
                        `‚ö†Ô∏è Auto-save fallito: ${error.message}\n\n` +
                        `Il file potrebbe essere stato spostato o rinominato.\n\n` +
                        `Opzioni:\n` +
                        `‚Ä¢ OK: Seleziona un nuovo file ora\n` +
                        `‚Ä¢ Annulla: Disabilita auto-save temporaneamente\n\n` +
                        `Vuoi selezionare un nuovo file?`
                    );
                    
                    if (userChoice) {
                        // L'utente vuole selezionare un nuovo file
                        this.fileHandle = null;
                        this.promptShown = false;
                        await this.clearFileHandle();
                        // Prova immediatamente a configurare un nuovo file
                        const configured = await this.configureAutoSave();
                        if (configured) {
                            // Riprova il salvataggio con il nuovo file
                            this.saveImmediately();
                        }
                    } else {
                        // L'utente vuole disabilitare temporaneamente
                        this.isEnabled = false;
                        localStorage.setItem('piomarta_auto_save_enabled', 'false');
                        showNotification('Auto-save disabilitato temporaneamente. Riabilitalo quando vuoi dal menu DATI.', 'info');
                    }
                }
            }
            
            async disableAutoSave() {
                this.isEnabled = false;
                this.fileHandle = null;
                localStorage.setItem('piomarta_auto_save_enabled', 'false');
                
                // Aggiorna l'indicatore di stato nell'header
                const autoSaveStatus = document.getElementById('autoSaveStatus');
                if (autoSaveStatus) {
                    autoSaveStatus.textContent = 'AUTO-SAVE NON ATTIVO';
                    autoSaveStatus.classList.remove('auto-save-active');
                    autoSaveStatus.classList.add('auto-save-inactive');
                }
                
                // Disabilita sync
                this.disableSync();
                
                // Rimuovi il file handle da IndexedDB
                await this.clearFileHandle();
                
                showNotification('Auto-save disabilitato', 'info');
                console.log('üö´ Auto-save disabilitato');
            }
            
            // Sync Management Methods
            enableSync() {
                if (this.syncEnabled || !this.fileHandle) return;
                
                this.syncEnabled = true;
                console.log('üîÑ Sync multi-utente abilitato');
                
                // Page Visibility API per controllare quando si torna alla tab
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && this.syncEnabled) {
                        this.checkForUpdates();
                    }
                });
                
                // Controlla anche al focus della finestra
                window.addEventListener('focus', () => {
                    if (this.syncEnabled) {
                        this.checkForUpdates();
                    }
                });
                
                // I metadata verranno inizializzati al primo salvataggio o caricamento con interazione utente
            }
            
            disableSync() {
                this.syncEnabled = false;
                console.log('üö´ Sync multi-utente disabilitato');
            }
            
            async updateFileMetadata() {
                if (!this.fileHandle) return;
                
                try {
                    const file = await this.fileHandle.getFile();
                    this.lastModified = file.lastModified;
                    this.lastSize = file.size;
                    console.log('üìä File metadata aggiornato:', { 
                        lastModified: new Date(this.lastModified).toLocaleTimeString(),
                        size: this.lastSize 
                    });
                } catch (error) {
                    if (error.name === 'NotAllowedError') {
                        // Errore di permessi - disabilita il sync automatico
                        console.log('üîá Sync automatico disabilitato - richiede interazione utente');
                        this.disableSync();
                    } else {
                        console.error('‚ùå Errore lettura metadata file:', error);
                    }
                }
            }
            
            async checkForUpdates() {
                if (!this.fileHandle || !this.syncEnabled || this.isSyncing) return;
                
                try {
                    const file = await this.fileHandle.getFile();
                    const currentModified = file.lastModified;
                    const currentSize = file.size;
                    
                    // Se il file √® cambiato da quando l'abbiamo controllato l'ultima volta
                    if (this.lastModified && 
                        (currentModified > this.lastModified || currentSize !== this.lastSize)) {
                        
                        console.log('üîÑ File modificato da altro utente - sincronizzazione...');
                        await this.syncFromFile();
                    }
                    
                    // Aggiorna i metadata
                    this.lastModified = currentModified;
                    this.lastSize = currentSize;
                    
                } catch (error) {
                    if (error.name === 'NotAllowedError') {
                        // Errore di permessi - disabilita il sync automatico
                        console.log('üîá Sync automatico disabilitato - richiede interazione utente');
                        this.disableSync();
                    } else {
                        console.error('‚ùå Errore controllo aggiornamenti:', error);
                    }
                }
            }
            
            async syncFromFile() {
                if (this.isSyncing) return;
                
                this.isSyncing = true;
                
                try {
                    const file = await this.fileHandle.getFile();
                    const content = await file.text();
                    const importedData = JSON.parse(content);
                    
                    // Validate JSON structure
                    if (!importedData.roomData) {
                        throw new Error('File JSON non valido: manca roomData');
                    }
                    
                    // Import the data usando la logica esistente
                    Object.assign(roomData, importedData.roomData);
                    if (importedData.spogliatoioData) {
                        Object.assign(spogliatoioData, importedData.spogliatoioData);
                    }
                    if (importedData.localiData) {
                        Object.assign(localiData, importedData.localiData);
                    }
                    
                    // Save to localStorage
                    saveRoomDataSilent();
                    saveSpogliatoioDataSilent();
                    saveLocaliDataToStorageSilent();
                    
                    // Update UI
                    initializeRoomStatus();
                    initializeSpogliatoioStatus();
                    initializeLocaleStatus();
                    
                    // Notifica discreta
                    showSyncNotification();
                    
                    console.log('‚úÖ Sincronizzazione completata');
                    
                } catch (error) {
                    console.error('‚ùå Errore sincronizzazione:', error);
                    showNotification('Errore sincronizzazione dati', 'error');
                } finally {
                    this.isSyncing = false;
                }
            }
        }

        // Notifica auto-save discreta
        function showAutoSaveNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(39, 174, 96, 0.9);
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                font-size: 0.9em;
                z-index: 10000;
                box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            `;
            notification.textContent = 'üíæ Dati salvati automaticamente';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // Notifica sincronizzazione multi-utente
        function showSyncNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(52, 152, 219, 0.9);
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                font-size: 0.9em;
                z-index: 10000;
                box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            `;
            notification.textContent = 'üîÑ Dati aggiornati da altro utente';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Funzioni "silent" per salvare senza triggare auto-save
        function saveRoomDataSilent() {
            // Salva su IndexedDB invece di localStorage
            if (window.piomartaManager && window.piomartaManager.isInitialized) {
                window.piomartaManager.saveToIndexedDB('roomData', roomData);
            }
        }

        function saveSpogliatoioDataSilent() {
            // Salva su IndexedDB invece di localStorage
            if (window.piomartaManager && window.piomartaManager.isInitialized) {
                window.piomartaManager.saveToIndexedDB('spogliatoioData', spogliatoioData);
            }
        }

        function saveLocaliDataToStorageSilent() {
            // Salva su IndexedDB invece di localStorage
            if (window.piomartaManager && window.piomartaManager.isInitialized) {
                window.piomartaManager.saveToIndexedDB('localiData', localiData);
            }
        }

        // Il sistema di auto-save √® ora gestito direttamente dal PiomartaManager
        // I dati vengono salvati automaticamente su IndexedDB e sul file quando disponibile

        function toggleSection(headerElement) {
            const section = headerElement.closest('.selection-section');
            section.classList.toggle('collapsed');
        }

        // ===== NUOVO SISTEMA SOLIDO IndexedDB + Auto-Save =====
        
        // Funzione per aggiornare tutti i display dopo il caricamento dati
        function updateAllDisplays() {
            try {
                // Aggiorna le camere
                if (typeof initializeRoomStatus === 'function') {
                    initializeRoomStatus();
                }
                
                // Aggiorna gli spogliatoi se presenti
                if (typeof initializeSpogliatoioStatus === 'function') {
                    initializeSpogliatoioStatus();
                }
                
                // Aggiorna i locali se presenti
                if (typeof initializeLocaleStatus === 'function') {
                    initializeLocaleStatus();
                }
                
                console.log('‚úÖ Tutti i display aggiornati dopo caricamento dati');
            } catch (error) {
                console.error('‚ùå Errore aggiornamento display:', error);
            }
        }
        
        class PiomartaManager {
            constructor() {
                this.dbName = 'piomarta_data';
                this.db = null;
                this.fileHandle = null;
                this.hasUnsavedChanges = false;
                this.directoryHandle = null;
                this.isInitialized = false;
            }

            async init() {
                try {
                    // Inizializza IndexedDB
                    await this.initDB();
                    
                    // Carica dati da IndexedDB
                    await this.loadData();
                    
                    console.log('‚úÖ PiomartaManager inizializzato con IndexedDB');
                    this.isInitialized = true;
                    
                    // Setup auto-save come FINALE 26
                    this.setupPeriodicExport();
                    
                } catch (error) {
                    console.error('‚ùå Errore inizializzazione PiomartaManager:', error);
                }
            }

            async initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, 1);
                    
                    request.onupgradeneeded = (event) => {
                        this.db = event.target.result;
                        
                        // Store per dati alloggi
                        if (!this.db.objectStoreNames.contains('alloggi')) {
                            this.db.createObjectStore('alloggi', { keyPath: 'id' });
                        }
                        
                        // Store per directory handles
                        if (!this.db.objectStoreNames.contains('directoryHandles')) {
                            this.db.createObjectStore('directoryHandles', { keyPath: 'id' });
                        }
                        
                        console.log('üìÅ Database IndexedDB creato/aggiornato');
                    };
                    
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log('‚úÖ IndexedDB connesso');
                        resolve();
                    };
                    
                    request.onerror = (event) => {
                        console.error('‚ùå Errore connessione IndexedDB:', event.target.error);
                        reject(event.target.error);
                    };
                });
            }


            async saveToIndexedDB(key, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['alloggi'], 'readwrite');
                    const store = transaction.objectStore('alloggi');
                    const dataToSave = { 
                        id: key, 
                        data: data, 
                        lastUpdate: new Date().toISOString() 
                    };
                    
                    const request = store.put(dataToSave);
                    
                    request.onsuccess = () => {
                        resolve(request.result);
                    };
                    
                    request.onerror = () => {
                        reject(request.error);
                    };
                });
            }

            async loadFromIndexedDB(key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['alloggi'], 'readonly');
                    const store = transaction.objectStore('alloggi');
                    const request = store.get(key);
                    
                    request.onsuccess = () => {
                        if (request.result) {
                            resolve(request.result.data);
                        } else {
                            resolve(null);
                        }
                    };
                    
                    request.onerror = () => {
                        reject(request.error);
                    };
                });
            }

            async loadData() {
                try {
                    // Carica roomData
                    const loadedRoomData = await this.loadFromIndexedDB('roomData');
                    if (loadedRoomData) {
                        Object.assign(roomData, loadedRoomData);
                    }
                    
                    // Carica spogliatoioData
                    const loadedSpogliatoioData = await this.loadFromIndexedDB('spogliatoioData');
                    if (loadedSpogliatoioData) {
                        Object.assign(spogliatoioData, loadedSpogliatoioData);
                    }
                    
                    // Carica localiData
                    const loadedLocaliData = await this.loadFromIndexedDB('localiData');
                    if (loadedLocaliData) {
                        Object.assign(localiData, loadedLocaliData);
                    }
                    
                    // Aggiorna UI
                    updateAllDisplays();
                    
                } catch (error) {
                    console.error('‚ùå Errore caricamento dati:', error);
                }
            }

            async saveData() {
                try {
                    await this.saveToIndexedDB('roomData', roomData);
                    await this.saveToIndexedDB('spogliatoioData', spogliatoioData);
                    await this.saveToIndexedDB('localiData', localiData);
                    
                    console.log('‚úÖ Dati salvati su IndexedDB');
                    return true;
                } catch (error) {
                    console.error('‚ùå Errore salvataggio IndexedDB:', error);
                    return false;
                }
            }

            setupPeriodicExport() {
                // Salvataggio automatico IMMEDIATO dopo ogni modifica
                this.fileHandle = null;
                
                // Override markAsChanged per salvare immediatamente
                const originalMarkAsChanged = this.markAsChanged.bind(this);
                const self = this;
                this.markAsChanged = async function() {
                    if (!self.isInitialized) return;
                    
                    // Non permettere auto-save in modalit√† solo lettura
                    if (isReadOnlyMode || !isAuthenticated) {
                        console.log('üîí Auto-save disabled - read-only mode');
                        return;
                    }
                    
                    originalMarkAsChanged();
                    
                    // Salva immediatamente dopo ogni modifica
                    await self.saveImmediately();
                };

                // Page Visibility API per salvataggio quando si cambia tab/finestra
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'hidden' && self.hasUnsavedChanges) {
                        self.saveImmediately();
                    }
                });
            }
            
            markAsChanged() {
                this.hasUnsavedChanges = true;
                console.log('üî• Modifiche marcate - hasUnsavedChanges:', this.hasUnsavedChanges);
            }
            
            async saveImmediately() {
                if (!this.hasUnsavedChanges) return;
                
                // Check if auto-save is enabled
                const autoSaveEnabled = localStorage.getItem('piomarta_auto_save_enabled') === 'true';
                if (!autoSaveEnabled) {
                    console.log('üö´ Auto-save disabilitato, saltando salvataggio automatico');
                    return;
                }
                
                // Prova prima con File System Access API
                if (await this.initFileHandle()) {
                    const exportData = {
                        system: 'PIOMARTA - Auto Export v1.2',
                        exportDate: new Date().toISOString(),
                        roomData: roomData,
                        spogliatoioData: spogliatoioData,
                        localiData: localiData,
                        version: '1.2'
                    };
                    
                    try {
                        const writable = await this.fileHandle.createWritable();
                        await writable.write(JSON.stringify(exportData, null, 2));
                        await writable.close();
                        
                        this.hasUnsavedChanges = false;
                        console.log('‚úÖ Salvataggio immediato completato');
                        
                        // Mostra popup discreto di successo
                        showAutoSaveNotification();
                        
                        return true;
                    } catch (error) {
                        console.log('‚ö†Ô∏è File System API fallito (primo tentativo):', error);
                        
                        // Reset file handle and retry with new file picker
                        this.fileHandle = null;
                        console.log('üîÑ Reset file handle, tentativo di ripristino...');
                        
                        // Try to get a new file handle
                        if (await this.initFileHandle()) {
                            try {
                                const writable = await this.fileHandle.createWritable();
                                await writable.write(JSON.stringify(exportData, null, 2));
                                await writable.close();
                                
                                this.hasUnsavedChanges = false;
                                console.log('‚úÖ Salvataggio immediato completato dopo retry');
                                
                                // Mostra popup discreto di successo
                                showAutoSaveNotification();
                                
                                return true;
                            } catch (retryError) {
                                console.log('‚ùå File System API fallito anche al secondo tentativo:', retryError);
                            }
                        }
                    }
                }
                
                // Se File System API fallisce, log dell'errore
                console.log('‚ö†Ô∏è Salvataggio File System fallito');
                return false;
            }


            async initFileHandle() {
                if (!this.fileHandle) {
                    try {
                        this.fileHandle = await window.showSaveFilePicker({
                            suggestedName: "piomarta_dati.json",
                            types: [{
                                description: "JSON files",
                                accept: {"application/json": [".json"]}
                            }]
                        });
                        console.log('üìÅ File di salvataggio configurato');
                        return true;
                    } catch (error) {
                        console.log('‚ùå Utente ha annullato selezione file');
                        return false;
                    }
                }
                return true;
            }

            closeAutoSaveSetup() {
                const prompt = document.getElementById('auto-save-setup');
                if (prompt) {
                    prompt.remove();
                }
            }

            async saveToFile() {
                if (!this.fileHandle || !this.hasUnsavedChanges) return;
                
                try {
                    const exportData = {
                        system: 'PIOMARTA - Auto Export v1.2',
                        exportDate: new Date().toISOString(),
                        roomData: roomData,
                        spogliatoioData: spogliatoioData,
                        localiData: localiData,
                        version: '1.2'
                    };
                    
                    const writable = await this.fileHandle.createWritable();
                    await writable.write(JSON.stringify(exportData, null, 2));
                    await writable.close();
                    
                    this.hasUnsavedChanges = false;
                    
                    // Notifica discreta
                    this.showAutoSaveSuccess();
                    
                    console.log('‚úÖ Auto-save completato:', this.fileHandle.name);
                    
                } catch (error) {
                    console.error('‚ùå Auto-save fallito:', error);
                    showNotification('‚ùå Auto-save fallito - file non accessibile', 'error');
                }
            }

            showAutoSaveSuccess() {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #27ae60, #2ecc71);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-size: 0.9em;
                    z-index: 10000;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                
                notification.textContent = 'üíæ Dati salvati automaticamente';
                document.body.appendChild(notification);
                
                // Animazione fade in
                setTimeout(() => notification.style.opacity = '1', 100);
                
                // Rimuovi dopo 3 secondi
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }


            // Caricamento JSON con cartella predefinita
            async loadJSON() {
                try {
                    let pickerOptions = {
                        types: [{
                            description: "JSON files",
                            accept: {"application/json": [".json"]}
                        }],
                        multiple: false
                    };
                    
                    // Usa directory handle salvata se disponibile
                    if (this.directoryHandle) {
                        pickerOptions.startIn = this.directoryHandle;
                    }
                    
                    const fileHandles = await window.showOpenFilePicker(pickerOptions);
                    const fileHandle = fileHandles[0];
                    const file = await fileHandle.getFile();
                    const text = await file.text();
                    const importData = JSON.parse(text);
                    
                    // Imposta file handle per auto-save
                    this.fileHandle = fileHandle;
                    
                    // Salva file handle su IndexedDB per persistenza
                    await this.saveToIndexedDB('fileHandle', fileHandle);
                    
                    // Abilita auto-save ora che abbiamo un file handle
                    this.hasUnsavedChanges = false;
                    
                    // Abilita sync se il metodo esiste
                    if (typeof this.enableSync === 'function') {
                        this.enableSync();
                    } else {
                        this.syncEnabled = true;
                        console.log('üîÑ Sync abilitato (metodo enableSync non trovato)');
                    }
                    
                    // Importa i dati
                    if (importData.roomData) {
                        Object.assign(roomData, importData.roomData);
                    }
                    if (importData.spogliatoioData) {
                        Object.assign(spogliatoioData, importData.spogliatoioData);
                    }
                    if (importData.localiData) {
                        Object.assign(localiData, importData.localiData);
                    }
                    
                    // Salva directory handle per usi futuri
                    await this.saveDirectoryHandleFromFile(fileHandle);
                    
                    // Salva su IndexedDB e aggiorna UI
                    await this.saveData();
                    updateAllDisplays();
                    
                    showNotification('‚úÖ Dati caricati con successo!', 'success');
                    console.log('üìÇ Dati caricati da:', file.name);
                    
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log('Caricamento annullato');
                    } else {
                        console.error('‚ùå Errore caricamento:', error);
                        showNotification('‚ùå Errore nel caricamento del file', 'error');
                    }
                }
            }

            async saveDirectoryHandleFromFile(fileHandle = null) {
                try {
                    const handle = fileHandle || this.fileHandle;
                    if (!handle) return;
                    
                    // Il file handle non ci d√† accesso alla directory parent direttamente
                    // Ma possiamo salvarlo come riferimento per usi futuri
                    const transaction = this.db.transaction(['directoryHandles'], 'readwrite');
                    const store = transaction.objectStore('directoryHandles');
                    
                    await store.put({
                        id: 'lastUsedFile',
                        handle: handle,
                        timestamp: new Date().toISOString()
                    });
                    
                    console.log('üìÅ File handle salvato per usi futuri');
                    
                } catch (error) {
                    console.error('‚ùå Errore salvataggio directory handle:', error);
                }
            }

            async loadDataFromFile() {
                if (!this.fileHandle) {
                    console.warn('‚ö†Ô∏è Nessun file handle disponibile per il caricamento');
                    return;
                }
                
                try {
                    console.log('üìÇ Caricamento dati da file salvato:', this.fileHandle.name);
                    
                    const file = await this.fileHandle.getFile();
                    const text = await file.text();
                    const importData = JSON.parse(text);
                    
                    // Importa i dati sostituendo completamente gli oggetti esistenti
                    if (importData.roomData) {
                        window.roomData = importData.roomData;
                        console.log('‚úÖ RoomData caricati:', Object.keys(importData.roomData).length, 'camere');
                    }
                    if (importData.spogliatoioData) {
                        window.spogliatoioData = importData.spogliatoioData;
                        console.log('‚úÖ SpogliatoioData caricati:', Object.keys(importData.spogliatoioData).length, 'spogliatoi');
                    }
                    if (importData.localiData) {
                        window.localiData = importData.localiData;
                        console.log('‚úÖ LocaliData caricati:', Object.keys(importData.localiData).length, 'locali');
                    }
                    
                    // Salva su IndexedDB e aggiorna UI
                    await this.saveData();
                    updateAllDisplays();
                    
                    console.log('‚úÖ Dati caricati automaticamente da:', this.fileHandle.name);
                    
                } catch (error) {
                    if (error.name === 'NotAllowedError') {
                        console.log('‚ö†Ô∏è Caricamento automatico non consentito - richiede interazione utente');
                        console.log('üí° I dati verranno caricati al primo utilizzo del sistema');
                    } else {
                        console.error('‚ùå Errore caricamento automatico dati:', error);
                    }
                    // Non bloccare l'inizializzazione per errori di caricamento
                }
            }

            // Caricamento dati con interazione utente
            async loadDataOnDemand() {
                if (!this.fileHandle || this.dataLoaded) return;
                
                try {
                    await this.loadDataFromFile();
                    this.dataLoaded = true;
                } catch (error) {
                    console.error('‚ùå Errore caricamento su richiesta:', error);
                }
            }
        }

        // Inizializza il nuovo manager
        const piomartaManager = new PiomartaManager();
        window.piomartaManager = piomartaManager; // Rendi globale
        
        // Inizializza immediatamente
        piomartaManager.init();



        // Auto-save success notification
        function showAutoSaveNotification() {
            // Rimuovi notifiche precedenti se presenti
            const existing = document.getElementById('auto-save-notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.id = 'auto-save-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #27ae60, #2ecc71);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
                max-width: 300px;
                display: flex;
                align-items: center;
                gap: 8px;
            `;
            
            notification.innerHTML = 'üíæ Auto-save completato';
            document.body.appendChild(notification);
            
            // Animazione di entrata
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 10);
            
            // Auto-rimozione dopo 3 secondi
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }
        
        // Popup avviso dati non aggiornati
        function showDataUpdateWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
                color: white;
                padding: 30px;
                border-radius: 15px;
                border: 2px solid #e74c3c;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                font-size: 1.1em;
                z-index: 10000;
                text-align: center;
                max-width: 450px;
                animation: pulse 1s infinite;
            `;
            
            warningDiv.innerHTML = `
                <h3 style="margin: 0 0 15px 0;">‚ö†Ô∏è Dati Non Aggiornati</h3>
                <p style="margin: 10px 0; line-height: 1.4;">
                    I dati visualizzati potrebbero non essere aggiornati.<br>
                    <strong>Vuoi caricare i dati pi√π recenti?</strong>
                </p>
                <div style="margin-top: 20px;">
                    <button onclick="proceedToImport()" style="background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 8px; margin-right: 10px; cursor: pointer; font-size: 1em;">
                        üîÑ S√¨, Aggiorna Dati
                    </button>
                    <button onclick="closeDataUpdateWarning()" style="background: #7f8c8d; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1em;">
                        ‚è≠Ô∏è Continua Cos√¨
                    </button>
                </div>
                <style>
                    @keyframes pulse {
                        0% { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); }
                        50% { box-shadow: 0 10px 40px rgba(231, 76, 60, 0.3), 0 0 0 10px rgba(231, 76, 60, 0.1); }
                        100% { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); }
                    }
                </style>
            `;
            
            warningDiv.id = 'data-update-warning';
            document.body.appendChild(warningDiv);
        }
        
        function closeDataUpdateWarning() {
            const warning = document.getElementById('data-update-warning');
            if (warning) {
                warning.remove();
            }
        }
        
        function proceedToImport() {
            closeDataUpdateWarning();
            // Vai alla sezione DATI > IMPORTA
            showDati();
            setTimeout(() => {
                showDatiTab('importa', document.querySelector('.dati-btn:nth-child(2)'));
            }, 300);
        }
        
        // Funzioni globali per interfaccia
        function loadPiomartaJSON() {
            piomartaManager.loadJSON();
        }

        function initializePiomartaManager() {
            piomartaManager.init();
        }

        // Inizializza all'avvio
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inizializzazione PiomartaManager...');
            initializePiomartaManager();
        });
    </script>

</body></html>